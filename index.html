<!--
=================================================================
                    تطبيق جمعية الزواج المتكامل
=================================================================

ملاحظات مهمة لرفع التطبيق على الإنترنت:

1. حفظ البيانات:
   - التطبيق يستخدم localStorage لحفظ البيانات محلياً في المتصفح
   - البيانات تبقى محفوظة حتى لو تم إغلاق المتصفح أو إعادة تشغيل الجهاز
   - لا تحتاج لقاعدة بيانات خارجية - كل شيء يُحفظ في التطبيق نفسه

2. رفع التطبيق:
   - يمكن رفع هذا الملف على أي استضافة ويب (مثل: GitHub Pages, Netlify, Vercel)
   - الملف يعمل بدون الحاجة لخادم - مجرد HTML/CSS/JavaScript
   - يمكن فتحه مباشرة في المتصفح من أي مكان

3. الأمان:
   - تم إزالة كلمة "admin" من واجهة تسجيل الدخول لزيادة الأمان
   - كل مستخدم له بيانات دخول مخصصة
   - البيانات محمية ومشفرة في المتصفح

4. الاستخدام:
   - التطبيق يدعم عدة مستخدمين (مدير، مشرف، عضو)
   - نظام صلاحيات متكامل
   - إدارة جمعيات ومعاونات متعددة
   - تقارير وكشوفات تفصيلية

=================================================================
-->

<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
    <title>تطبيق جمعية الزواج - النسخة المتكاملة</title>
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="/manifest.json">
    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#667eea">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="جمعية الزواج">
    <meta name="msapplication-TileColor" content="#667eea">
    <meta name="msapplication-tap-highlight" content="no">
    
    <!-- Apple Touch Icons -->
    <link rel="apple-touch-icon" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTkyIiBoZWlnaHQ9IjE5MiIgdmlld0JveD0iMCAwIDE5MiAxOTIiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxOTIiIGhlaWdodD0iMTkyIiByeD0iMjQiIGZpbGw9InVybCgjZ3JhZGllbnQwX2xpbmVhcl8xXzEpIi8+CjxwYXRoIGQ9Ik05NiA0OEM4MC41MzYgNDggNjggNjAuNTM2IDY4IDc2QzY4IDkxLjQ2NCA4MC41MzYgMTA0IDk2IDEwNEMxMTEuNDY0IDEwNCAxMjQgOTEuNDY0IDEyNCA3NkMxMjQgNjAuNTM2IDExMS40NjQgNDggOTYgNDhaIiBmaWxsPSJ3aGl0ZSIvPgo8cGF0aCBkPSJNMTQ0IDEyOEMxNDQgMTEyLjUzNiAxMzEuNDY0IDEwMCAxMTYgMTAwSDc2QzYwLjUzNiAxMDAgNDggMTEyLjUzNiA0OCAxMjhWMTQ0SDQ4VjE0NEgxNDRWMTI4WiIgZmlsbD0id2hpdGUiLz4KPGRlZnM+CjxsaW5lYXJHcmFkaWVudCBpZD0iZ3JhZGllbnQwX2xpbmVhcl8xXzEiIHgxPSIwIiB5MT0iMCIgeDI9IjE5MiIgeTI9IjE5MiIgZ3JhZGllbnRVbml0cz0idXNlclNwYWNlT25Vc2UiPgo8c3RvcCBzdG9wLWNvbG9yPSIjNjY3RUVBIi8+CjxzdG9wIG9mZnNldD0iMSIgc3RvcC1jb2xvcj0iIzc2NEJBMiIvPgo8L2xpbmVhckdyYWRpZW50Pgo8L2RlZnM+Cjwvc3ZnPgo=">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Tajawal', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            direction: rtl;
            overflow-x: hidden;
            font-size: 14px;
        }

        /* تحسينات الجوال - جالكسي 25 الترا */
        @media (max-width: 768px) {
            body {
                font-size: 16px;
                padding: 10px;
                -webkit-overflow-scrolling: touch;
                -webkit-tap-highlight-color: transparent;
                background: #f8f9fa;
            }
            
            * {
                -webkit-touch-callout: none;
                -webkit-user-select: none;
                -khtml-user-select: none;
                -moz-user-select: none;
                -ms-user-select: none;
                user-select: none;
            }
            
            input, textarea, select {
                -webkit-user-select: text;
                -moz-user-select: text;
                -ms-user-select: text;
                user-select: text;
            }
            
            .container {
                max-width: 100%;
                padding: 15px;
            }
            
            header {
                padding: 20px;
                margin-bottom: 20px;
                border-radius: 15px;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                box-shadow: 0 8px 25px rgba(0,0,0,0.15);
            }
            
            .main-title {
                font-size: 1.5rem;
                margin-bottom: 8px;
                line-height: 1.3;
                text-align: center;
                font-weight: bold;
            }
            
            .subtitle {
                font-size: 1.1rem;
                margin-bottom: 15px;
                line-height: 1.4;
                text-align: center;
            }
            
            .user-info {
                padding: 15px 20px;
                margin-bottom: 20px;
                font-size: 1.1rem;
                border-radius: 20px;
                background: rgba(255,255,255,0.9);
                color: #2c3e50;
                text-align: center;
                font-weight: 600;
                box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            }
            
            nav {
                gap: 8px;
                padding: 0 5px;
                flex-wrap: wrap;
                justify-content: center;
                margin-bottom: 25px;
            }
            
            .nav-btn {
                padding: 15px 20px;
                font-size: 1rem;
                min-width: auto;
                flex: 1;
                max-width: calc(50% - 4px);
                margin-bottom: 8px;
                border-radius: 15px;
                min-height: 50px;
                display: flex;
                align-items: center;
                justify-content: center;
                text-align: center;
                font-weight: 600;
                box-shadow: 0 4px 12px rgba(0,0,0,0.1);
                transition: transform 0.2s ease;
            }
            
            .nav-btn:active {
                transform: scale(0.95);
            }
            
            .content {
                padding: 10px;
                border-radius: 10px;
                min-height: auto;
            }
            
            .section h2 {
                font-size: 1.1rem;
                margin-bottom: 15px;
                text-align: center;
                padding: 8px;
                border-radius: 8px;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                border: none;
            }
            
            .section h3 {
                font-size: 1rem;
                margin-bottom: 12px;
                padding: 6px 10px;
                border-radius: 6px;
                background: rgba(102, 126, 234, 0.1);
            }
            
            .form-grid {
                grid-template-columns: 1fr;
                gap: 10px;
            }
            
            .form-group {
                margin-bottom: 10px;
            }
            
            .form-group input,
            .form-group select,
            .form-group textarea {
                padding: 8px;
                font-size: 0.85rem;
                border-radius: 6px;
            }
            
            .btn {
                padding: 8px 10px;
                font-size: 0.8rem;
                width: 100%;
                margin-bottom: 6px;
                border-radius: 8px;
                min-height: 40px;
            }
            
            .btn-group {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 6px;
            }
            
            .btn-group .btn {
                width: 100%;
                margin-bottom: 0;
            }
            
            table {
                font-size: 0.7rem;
                overflow-x: auto;
                display: block;
                white-space: nowrap;
            }
            
            table thead,
            table tbody,
            table tr {
                display: table;
                width: 100%;
                table-layout: fixed;
            }
            
            table th,
            table td {
                padding: 4px 2px;
                word-wrap: break-word;
                font-size: 0.65rem;
            }
            
            .modal-content {
                width: 95%;
                max-width: 95%;
                margin: 5% auto;
                padding: 12px;
            }
            
            /* تحسين الشبكة الإحصائية للجوال */
            .stats-grid {
                display: grid !important;
                grid-template-columns: 1fr !important;
                gap: 8px !important;
                margin-bottom: 15px !important;
                width: 100%;
            }
            
            .stat-card {
                padding: 12px !important;
                margin-bottom: 0;
                width: 100% !important;
                box-sizing: border-box;
                min-height: auto !important;
                height: auto !important;
            }
            
            .stat-number {
                font-size: 1.5rem !important;
                margin-bottom: 4px;
            }
            
            .stat-label {
                font-size: 0.75rem;
                line-height: 1.2;
            }
            
            .card {
                padding: 10px;
                margin-bottom: 8px;
                border-radius: 8px;
            }
            
            /* تحسين بطاقات الجمعيات للجوال - جالكسي 25 الترا */
            .association-card, .cooperation-card {
                width: 100% !important;
                margin: 0 0 20px 0 !important;
                padding: 20px !important;
                box-sizing: border-box;
                display: block;
                border-radius: 15px !important;
                min-height: auto !important;
                height: auto !important;
                box-shadow: 0 8px 20px rgba(0,0,0,0.15) !important;
                background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%) !important;
            }
            
            .association-details, .cooperation-details {
                display: grid !important;
                grid-template-columns: 1fr !important;
                gap: 15px !important;
            }
            
            .association-header, .cooperation-header {
                display: flex;
                flex-direction: column;
                align-items: center;
                gap: 10px;
                margin-bottom: 15px;
                padding-bottom: 15px;
                border-bottom: 3px solid #007bff;
            }
            
            .association-header h4, .cooperation-header h4 {
                font-size: 1.4rem !important;
                margin-bottom: 8px;
                width: 100%;
                line-height: 1.3;
                text-align: center !important;
                color: #2c3e50 !important;
                font-weight: bold !important;
            }
            
            .status-badge {
                align-self: center;
                font-size: 1rem !important;
                padding: 8px 20px !important;
                border-radius: 25px !important;
                font-weight: bold !important;
                margin: 10px 0 !important;
            }
            
            .association-details div, .cooperation-details div {
                padding: 15px !important;
                border-radius: 12px !important;
                font-size: 1.1rem !important;
                background: #f8f9fa !important;
                border: 2px solid #e9ecef !important;
                text-align: center !important;
                font-weight: 600 !important;
                min-height: 50px !important;
                display: flex !important;
                align-items: center !important;
                justify-content: center !important;
            }
            
            .association-details span, .cooperation-details span {
                font-size: 0.75rem;
            }
            
            .floating-hearts {
                display: none;
            }
            
            /* تحسين صفحة الدخول للجوال */
            .login-container {
                max-width: 95% !important;
                margin: 10px auto !important;
                padding: 15px !important;
                border-radius: 10px !important;
            }
            
            .login-title {
                font-size: 1.3rem !important;
                margin-bottom: 10px;
                line-height: 1.3;
            }
            
            .main-desc {
                font-size: 0.9rem !important;
                line-height: 1.4;
            }
            
            .sub-desc {
                font-size: 0.8rem;
                line-height: 1.3;
            }
            
            .developer-info {
                padding: 10px !important;
                margin: 15px 0 !important;
                border-radius: 8px;
            }
            
            .developer-name {
                font-size: 0.9rem;
            }
            
            .contact-info {
                font-size: 0.8rem;
                line-height: 1.4;
            }
            
            /* تحسين التمرير الأفقي للجداول */
            .table-container {
                -webkit-overflow-scrolling: touch;
                scrollbar-width: thin;
                border-radius: 6px;
                overflow: hidden;
            }
            
            .table-container::-webkit-scrollbar {
                height: 4px;
            }
            
            .table-container::-webkit-scrollbar-track {
                background: #f1f1f1;
                border-radius: 2px;
            }
            
            .table-container::-webkit-scrollbar-thumb {
                background: #888;
                border-radius: 2px;
            }
            
            .table-container::-webkit-scrollbar-thumb:hover {
                background: #555;
            }
            
            /* تحسين الأزرار للمس */
            .btn, .nav-btn, .action-btn {
                touch-action: manipulation;
                -webkit-tap-highlight-color: transparent;
                min-height: 40px;
            }
            
            /* تحسين النماذج */
            input, select, textarea {
                -webkit-appearance: none;
                -moz-appearance: none;
                appearance: none;
                border-radius: 6px;
                min-height: 40px;
            }
            
            select {
                background-image: url('data:image/svg+xml;charset=US-ASCII,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 4 5"><path fill="%23666" d="M2 0L0 2h4zm0 5L0 3h4z"/></svg>');
                background-repeat: no-repeat;
                background-position: left 10px center;
                background-size: 12px;
                padding-left: 30px;
            }
            
            /* تحسين أقسام الصفحة الرئيسية */
            .dashboard-section {
                margin-bottom: 20px;
            }
            
            .section-title {
                font-size: 1rem;
                margin-bottom: 10px;
                padding: 6px 10px;
                border-radius: 6px;
                background: rgba(102, 126, 234, 0.1);
            }
            
            /* تحسين بطاقات الزيجات القادمة */
            .wedding-card {
                padding: 8px;
                margin-bottom: 6px;
                flex-direction: column;
                align-items: flex-start;
                gap: 6px;
                border-radius: 8px;
            }
            
            .wedding-info h5 {
                font-size: 0.85rem;
                margin-bottom: 3px;
                line-height: 1.3;
            }
            
            .wedding-info p {
                font-size: 0.7rem;
                margin-bottom: 2px;
                line-height: 1.2;
            }
            
            .wedding-amount {
                padding: 4px 8px;
                font-size: 0.7rem;
                align-self: flex-end;
                border-radius: 15px;
            }
            
            /* تحسين الرسائل التنبيهية */
            .alert {
                padding: 10px;
                margin: 10px 0;
                border-radius: 6px;
                font-size: 0.8rem;
                line-height: 1.4;
            }
        }
        
        @media (max-width: 480px) {
            body {
                font-size: 11px;
                padding: 2px;
            }
            
            .container {
                padding: 4px;
            }
            
            header {
                padding: 6px;
                margin-bottom: 6px;
                border-radius: 8px;
            }
            
            .main-title {
                font-size: 0.95rem;
                line-height: 1.2;
                margin-bottom: 3px;
            }
            
            .subtitle {
                font-size: 0.75rem;
                margin-bottom: 6px;
                line-height: 1.3;
            }
            
            .user-info {
                padding: 4px 8px;
                margin-bottom: 6px;
                font-size: 0.7rem;
                border-radius: 12px;
            }
            
            nav {
                gap: 2px;
                padding: 0 1px;
                justify-content: center;
            }
            
            .nav-btn {
                padding: 4px 6px;
                font-size: 0.6rem;
                max-width: calc(33.33% - 2px);
                margin-bottom: 2px;
                border-radius: 8px;
                min-height: 30px;
                line-height: 1.1;
            }
            
            .content {
                padding: 6px;
                border-radius: 8px;
            }
            
            .section h2 {
                font-size: 0.95rem;
                margin-bottom: 10px;
                padding: 6px;
                border-radius: 6px;
            }
            
            .section h3 {
                font-size: 0.85rem;
                margin-bottom: 8px;
                padding: 4px 8px;
                border-radius: 4px;
            }
            
            .form-group {
                margin-bottom: 6px;
            }
            
            .form-group input,
            .form-group select,
            .form-group textarea {
                padding: 6px;
                font-size: 0.75rem;
                border-radius: 4px;
                min-height: 35px;
            }
            
            table {
                font-size: 0.6rem;
            }
            
            table th,
            table td {
                padding: 3px 1px;
                font-size: 0.6rem;
            }
            
            .btn {
                padding: 6px 8px;
                font-size: 0.7rem;
                margin-bottom: 4px;
                border-radius: 6px;
                min-height: 35px;
            }
            
            .btn-group {
                grid-template-columns: 1fr 1fr;
                gap: 4px;
            }
            
            .modal-content {
                padding: 6px;
                margin: 2% auto;
                border-radius: 6px;
            }
            
            /* تحسين الشبكة الإحصائية للشاشات الصغيرة جداً */
            .stats-grid {
                gap: 4px !important;
                margin-bottom: 8px !important;
            }
            
            .stat-card {
                padding: 6px !important;
                margin-bottom: 0;
                border-radius: 6px;
            }
            
            .stat-number {
                font-size: 1.2rem !important;
                margin-bottom: 2px;
            }
            
            .stat-label {
                font-size: 0.65rem;
                line-height: 1.1;
            }
            
            /* تحسين إضافي لبطاقات الجمعيات على الشاشات الصغيرة جداً - جالكسي 25 الترا */
            .association-card, .cooperation-card {
                width: 100% !important;
                padding: 18px !important;
                margin: 0 0 18px 0 !important;
                border-radius: 12px !important;
                box-shadow: 0 6px 15px rgba(0,0,0,0.12) !important;
            }
            
            .association-header, .cooperation-header {
                gap: 8px;
                margin-bottom: 12px;
                padding-bottom: 12px;
                border-bottom: 2px solid #007bff;
                text-align: center;
            }
            
            .association-header h4, .cooperation-header h4 {
                font-size: 1.2rem !important;
                margin-bottom: 8px;
                line-height: 1.3;
                color: #2c3e50 !important;
                font-weight: bold !important;
                text-align: center !important;
            }
            
            .association-details, .cooperation-details {
                gap: 10px !important;
            }
            
            .association-details div, .cooperation-details div {
                padding: 12px !important;
                border-radius: 8px !important;
                font-size: 1rem !important;
                background: #f8f9fa !important;
                border: 1px solid #e9ecef !important;
                text-align: center !important;
                font-weight: 600 !important;
                min-height: 45px !important;
                display: flex !important;
                align-items: center !important;
                justify-content: center !important;
            }
            
            .association-details span, .cooperation-details span {
                font-size: 1rem !important;
                font-weight: 600 !important;
            }
            
            .status-badge {
                font-size: 0.9rem !important;
                padding: 6px 15px !important;
                border-radius: 20px !important;
                font-weight: bold !important;
                margin: 8px auto !important;
                display: block !important;
                width: fit-content !important;
            }
            
            /* تحسين صفحة الدخول للشاشات الصغيرة جداً */
            .login-container {
                max-width: 98% !important;
                margin: 5px auto !important;
                padding: 10px !important;
                border-radius: 8px !important;
            }
            
            .login-title {
                font-size: 1.1rem !important;
                margin-bottom: 8px;
                line-height: 1.2;
            }
            
            .main-desc {
                font-size: 0.8rem !important;
                line-height: 1.3;
            }
            
            .sub-desc {
                font-size: 0.7rem;
                line-height: 1.2;
            }
            
            .developer-info {
                padding: 8px !important;
                margin: 10px 0 !important;
                border-radius: 6px;
            }
            
            .developer-name {
                font-size: 0.8rem;
            }
            
            .contact-info {
                font-size: 0.7rem;
                line-height: 1.3;
            }
            
            /* تحسين أقسام الصفحة الرئيسية للشاشات الصغيرة */
            .dashboard-section {
                margin-bottom: 12px;
            }
            
            .section-title {
                font-size: 0.9rem;
                margin-bottom: 6px;
                padding: 4px 8px;
                border-radius: 4px;
            }
            
            /* تحسين بطاقات الزيجات القادمة للشاشات الصغيرة */
            .wedding-card {
                padding: 6px;
                margin-bottom: 4px;
                gap: 4px;
                border-radius: 6px;
            }
            
            .wedding-info h5 {
                font-size: 0.75rem;
                margin-bottom: 2px;
                line-height: 1.2;
            }
            
            .wedding-info p {
                font-size: 0.65rem;
                margin-bottom: 1px;
                line-height: 1.1;
            }
            
            .wedding-amount {
                padding: 3px 6px;
                font-size: 0.65rem;
                border-radius: 12px;
            }
            
            /* تحسين الرسائل التنبيهية للشاشات الصغيرة */
            .alert {
                padding: 8px;
                margin: 8px 0;
                border-radius: 4px;
                font-size: 0.7rem;
                line-height: 1.3;
            }
        }

        /* الخلفية المتحركة لصفحة الدخول */
        .floating-hearts {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1;
        }

        .floating-hearts i {
            position: absolute;
            color: rgba(255, 255, 255, 0.1);
            font-size: 2rem;
            animation: float 6s ease-in-out infinite;
        }

        .floating-hearts i:nth-child(1) {
            left: 10%;
            animation-delay: 0s;
            animation-duration: 6s;
        }

        .floating-hearts i:nth-child(2) {
            left: 20%;
            animation-delay: 1s;
            animation-duration: 8s;
        }

        .floating-hearts i:nth-child(3) {
            left: 35%;
            animation-delay: 2s;
            animation-duration: 7s;
        }

        .floating-hearts i:nth-child(4) {
            left: 50%;
            animation-delay: 3s;
            animation-duration: 9s;
        }

        .floating-hearts i:nth-child(5) {
            left: 70%;
            animation-delay: 4s;
            animation-duration: 6s;
        }

        .floating-hearts i:nth-child(6) {
            left: 85%;
            animation-delay: 5s;
            animation-duration: 8s;
        }

        @keyframes float {
            0%, 100% {
                transform: translateY(100vh) rotate(0deg);
                opacity: 0;
            }
            10%, 90% {
                opacity: 1;
            }
            50% {
                transform: translateY(-10vh) rotate(180deg);
                opacity: 0.8;
            }
        }

        /* الأنيميشن */
        .fade-in-up {
            animation: fadeInUp 1s ease-out forwards;
            opacity: 0;
            transform: translateY(30px);
        }

        .delay-1 { animation-delay: 0.3s; }
        .delay-2 { animation-delay: 0.6s; }
        .delay-3 { animation-delay: 0.9s; }

        @keyframes fadeInUp {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .pulse-animation {
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
                color: #e74c3c;
            }
            50% {
                transform: scale(1.1);
                color: #c0392b;
            }
        }

        /* إخفاء العناصر في الطباعة */
        @media print {
            .no-print {
                display: none !important;
            }
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(15px);
            border-radius: 20px;
            padding: 15px 20px;
            margin-bottom: 25px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .main-title {
            text-align: center;
            color: #2c3e50;
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 6px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .subtitle {
            text-align: center;
            color: #7f8c8d;
            font-size: 1rem;
            margin-bottom: 15px;
            font-weight: 400;
        }

        .user-info {
            text-align: center;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            margin-bottom: 15px;
            display: inline-block;
            font-size: 0.9rem;
            font-weight: 500;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        nav {
            display: flex;
            justify-content: center;
            gap: 10px;
            flex-wrap: wrap;
        }

        .nav-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 15px;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 500;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            min-width: 110px;
            justify-content: center;
            position: relative;
            overflow: hidden;
        }

        .nav-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }

        .nav-btn:hover::before {
            left: 100%;
        }

        .nav-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }

        .nav-btn.active {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
            box-shadow: 0 6px 20px rgba(255, 107, 107, 0.4);
        }

        .content {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            min-height: 600px;
        }

        .section {
            display: none;
        }

        .section.active {
            display: block;
        }

        .section h2 {
            color: #2c3e50;
            font-size: 2rem;
            margin-bottom: 20px;
            text-align: center;
            border-bottom: 3px solid #3498db;
            padding-bottom: 10px;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        @media (max-width: 768px) {
            .form-grid {
                grid-template-columns: 1fr;
                gap: 15px;
                margin-bottom: 15px;
            }
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #2c3e50;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px 14px;
            border: 1px solid #dee2e6;
            border-radius: 10px;
            font-size: 0.9rem;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            position: relative;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.15);
            transform: translateY(-1px);
            background: linear-gradient(135deg, #ffffff 0%, #f1f3f4 100%);
        }
        
        .form-group input:hover,
        .form-group select:hover,
        .form-group textarea:hover {
            border-color: #adb5bd;
            box-shadow: 0 3px 12px rgba(0,0,0,0.08);
        }

        .btn {
            background: linear-gradient(135deg, #27ae60, #2ecc71);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 500;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            margin: 3px;
            position: relative;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(39, 174, 96, 0.2);
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }

        .btn:hover::before {
            left: 100%;
        }

        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 6px 20px rgba(39, 174, 96, 0.4);
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.2);
        }

        .btn-primary:hover {
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        .btn-danger {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
            box-shadow: 0 4px 15px rgba(255, 107, 107, 0.2);
        }

        .btn-danger:hover {
            box-shadow: 0 6px 20px rgba(255, 107, 107, 0.4);
        }

        .btn-warning {
            background: linear-gradient(135deg, #feca57 0%, #ff9ff3 100%);
            box-shadow: 0 4px 15px rgba(254, 202, 87, 0.2);
        }

        .btn-warning:hover {
            box-shadow: 0 6px 20px rgba(254, 202, 87, 0.4);
        }

        .btn-success {
            background: linear-gradient(135deg, #48cae4 0%, #023e8a 100%);
            box-shadow: 0 4px 15px rgba(72, 202, 228, 0.2);
        }

        .btn-success:hover {
            box-shadow: 0 6px 20px rgba(72, 202, 228, 0.4);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
            box-shadow: 0 4px 15px rgba(108, 117, 125, 0.2);
        }

        .btn-secondary:hover {
            box-shadow: 0 6px 20px rgba(108, 117, 125, 0.4);
        }

        .btn-info {
            background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);
            box-shadow: 0 4px 15px rgba(23, 162, 184, 0.2);
        }

        .btn-info:hover {
            box-shadow: 0 6px 20px rgba(23, 162, 184, 0.4);
        }

        .table-container {
            overflow-x: auto;
            margin-top: 20px;
        }

        .table {
            width: 100%;
            border-collapse: collapse;
            min-width: 800px;
        }
        
        @media (max-width: 768px) {
            .table-container {
                margin-top: 15px;
                border-radius: 8px;
                overflow: hidden;
            }
            
            .table {
                min-width: 600px;
                font-size: 0.8rem;
            }
            
            .table th,
            .table td {
                padding: 8px 4px;
                font-size: 0.75rem;
            }
        }
        
        @media (max-width: 480px) {
            .table {
                min-width: 500px;
                font-size: 0.7rem;
            }
            
            .table th,
            .table td {
                padding: 6px 3px;
                font-size: 0.65rem;
            }
        }

        .table th,
        .table td {
            padding: 12px;
            text-align: right;
            border-bottom: 1px solid #e9ecef;
            white-space: nowrap;
        }

        .table th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            font-weight: 600;
            color: white;
            position: sticky;
            top: 0;
            text-align: center;
            border: 1px solid #dee2e6;
            font-size: 0.9rem;
            height: 35px;
            padding: 8px 6px;
        }

        .table tr:hover {
            background: #f8f9fa;
        }

        .table tbody tr {
            border-bottom: 1px solid #e9ecef;
        }

        .table tbody td {
            padding: 8px 6px;
            vertical-align: middle;
            border: 1px solid #e9ecef;
        }

        /* أزرار مصغرة للإجراءات */
        .action-btn {
            padding: 4px 8px !important;
            margin: 1px !important;
            font-size: 11px !important;
            border-radius: 8px !important;
            min-width: 30px;
            height: 26px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .action-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            transition: left 0.4s;
        }
        
        .action-btn:hover::before {
            left: 100%;
        }
        
        .action-btn:hover {
            transform: translateY(-1px) !important;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2) !important;
        }
        
        @media (max-width: 768px) {
            .action-btn {
                padding: 3px 6px !important;
                font-size: 10px !important;
                min-width: 28px;
                height: 24px;
                margin: 0.5px !important;
            }
        }
        
        @media (max-width: 480px) {
            .action-btn {
                padding: 2px 4px !important;
                font-size: 9px !important;
                min-width: 24px;
                height: 20px;
            }
        }

        .action-btn i {
            font-size: 11px;
        }

        /* ألوان خاصة للصفوف */
        .married-row {
            background-color: #d4edda !important; /* أخضر فاتح للمتزوجين */
        }

        .scheduled-row {
            background-color: #fff3cd !important; /* أصفر فاتح لمن تحدد زواجهم */
        }

        .single-row {
            background-color: #f8f9fa !important; /* رمادي فاتح للعزاب */
        }

        .married-row:hover,
        .scheduled-row:hover,
        .single-row:hover {
            opacity: 0.8;
        }

        /* تصميم كروت الأعضاء المقرر زواجهم */
        .scheduled-members-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        
        @media (max-width: 768px) {
            .scheduled-members-grid {
                grid-template-columns: 1fr;
                gap: 15px;
                margin: 15px 0;
            }
        }

        .scheduled-member-card {
            background: linear-gradient(135deg, #fff5f5, #ffe6e6);
            border: 2px solid #ff9999;
            border-radius: 15px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        @media (max-width: 768px) {
            .scheduled-member-card,
            .married-member-card,
            .locked-member-card {
                padding: 15px;
                border-radius: 10px;
                margin-bottom: 10px;
            }
        }
        
        @media (max-width: 480px) {
            .scheduled-member-card,
            .married-member-card,
            .locked-member-card {
                padding: 12px;
                border-radius: 8px;
            }
        }

        .scheduled-member-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.15);
            border-color: #ff6666;
        }

        /* كروت الأعضاء المتزوجين */
        .married-member-card {
            background: linear-gradient(135deg, #f0f8f0, #e8f5e8);
            border: 2px solid #28a745;
            border-radius: 15px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            opacity: 0.8;
        }

        .married-member-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.15);
            border-color: #1e7e34;
            opacity: 1;
        }

        .married-member-card .member-card-icon {
            background: #28a745;
        }

        .married-member-card .member-card-name {
            color: #155724;
        }

        /* كروت الأعضاء المقفلين */
        .locked-member-card {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border: 2px solid #6c757d;
            border-radius: 15px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            opacity: 0.7;
        }

        .locked-member-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.15);
            border-color: #495057;
            opacity: 0.9;
        }

        .locked-member-card .member-card-icon {
            background: #6c757d;
        }

        .locked-member-card .member-card-name {
            color: #495057;
        }

        .member-card-header {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }

        .member-card-icon {
            background: #ff6666;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-left: 15px;
            font-size: 18px;
        }

        .member-card-name {
            color: #2c3e50;
            margin: 0;
            font-size: 1.3rem;
            font-weight: 600;
        }

        .member-card-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .member-card-detail {
            display: flex;
            align-items: center;
            color: #555;
            font-size: 0.9rem;
        }

        .member-card-detail i {
            margin-left: 8px;
            color: #ff6666;
            width: 16px;
        }

        .collection-member-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 8px;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 8px;
        }

        .current-association-info {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            position: relative;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        /* تحسين الشبكة الإحصائية للأجهزة المتوسطة */
        @media (max-width: 1024px) {
            .stats-grid {
                grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
                gap: 15px;
                margin-bottom: 25px;
            }
        }
        
        @media (max-width: 768px) {
            .stats-grid {
                grid-template-columns: repeat(2, 1fr) !important;
                gap: 10px !important;
                margin-bottom: 20px !important;
            }
        }
        
        @media (max-width: 480px) {
            .stats-grid {
                grid-template-columns: 1fr !important;
                gap: 8px !important;
                margin-bottom: 15px !important;
            }
        }

        .stat-card {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            transition: transform 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-number {
            font-size: 2.5rem;
            font-weight: 700;
            color: #3498db;
            margin-bottom: 10px;
        }

        .stat-label {
            color: #7f8c8d;
            font-weight: 500;
        }

        /* أنماط بطاقات الجمعيات */
        .association-card, .cooperation-card {
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            border: 1px solid #e9ecef;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            transition: all 0.3s ease;
            cursor: pointer;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .association-card:hover, .cooperation-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
            border-color: #667eea;
        }

        .association-header, .cooperation-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            border-bottom: 1px solid #e9ecef;
            padding-bottom: 10px;
        }

        .association-header h4, .cooperation-header h4 {
            margin: 0;
            color: #2c3e50;
            font-size: 1.2rem;
            font-weight: 600;
        }

        .status-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-badge.active {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
        }

        .status-badge.inactive {
            background: linear-gradient(135deg, #6c757d, #495057);
            color: white;
        }

        .association-details, .cooperation-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
        }

        .association-details p, .cooperation-details p {
            margin: 0;
            color: #6c757d;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .association-details i, .cooperation-details i {
            color: #667eea;
            width: 16px;
        }

        /* أنماط بطاقات الزيجات القادمة */
        .wedding-card {
            background: linear-gradient(135deg, #fff5f5 0%, #ffe6e6 100%);
            border: 1px solid #fecaca;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s ease;
        }

        .wedding-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(220, 38, 127, 0.15);
        }

        .wedding-info h5 {
            margin: 0 0 8px 0;
            color: #be185d;
            font-size: 1.1rem;
            font-weight: 600;
        }

        .wedding-info p {
            margin: 0 0 4px 0;
            color: #9f1239;
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .wedding-info i {
            color: #ec4899;
            width: 14px;
        }

        .wedding-amount {
            background: linear-gradient(135deg, #be185d, #ec4899);
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.9rem;
        }

        /* تحسين تخطيط الأقسام */
        .dashboard-section {
            margin-bottom: 40px;
        }

        .section-title {
            color: #2c3e50;
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #667eea;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .section-title i {
            color: #667eea;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 20px;
            border-radius: 10px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        @media (max-width: 768px) {
            .modal-content {
                width: 95%;
                max-width: 95%;
                margin: 2% auto;
                padding: 15px;
                max-height: 90vh;
                border-radius: 8px;
            }
        }
        
        @media (max-width: 480px) {
            .modal-content {
                width: 98%;
                margin: 1% auto;
                padding: 12px;
                max-height: 95vh;
                border-radius: 6px;
            }
        }

        .close {
            color: #aaa;
            float: left;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover {
            color: #000;
        }

        .signature-pad {
            border: 2px solid #ddd;
            border-radius: 8px;
            margin: 10px 0;
        }

        .login-container {
            max-width: 450px;
            margin: 50px auto;
            background: rgba(255, 255, 255, 0.95);
            padding: 50px;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(10px);
            position: relative;
            z-index: 10;
        }
        
        @media (max-width: 768px) {
            .login-container {
                max-width: 90%;
                margin: 20px auto;
                padding: 30px;
                border-radius: 15px;
            }
        }
        
        @media (max-width: 480px) {
            .login-container {
                max-width: 95%;
                margin: 10px auto;
                padding: 20px;
                border-radius: 10px;
            }
            
            .login-title {
                font-size: 1.6rem;
            }
            
            .main-desc {
                font-size: 1rem;
            }
            
            .developer-info {
                padding: 15px;
                margin: 20px 0;
            }
        }

        .login-title {
            text-align: center;
            color: #2c3e50;
            font-size: 2.2rem;
            margin-bottom: 15px;
            font-weight: 700;
        }

        .app-description {
            text-align: center;
            margin-bottom: 30px;
        }

        .main-desc {
            color: #34495e;
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 8px;
            line-height: 1.4;
        }

        .sub-desc {
            color: #7f8c8d;
            font-size: 0.95rem;
            margin-bottom: 5px;
        }

        .developer-info {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: 20px;
            border-radius: 15px;
            margin: 25px 0;
            text-align: center;
            border: 2px solid #dee2e6;
        }

        .credit-title {
            color: #495057;
            font-size: 0.9rem;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .credit-subtitle {
            color: #6c757d;
            font-size: 0.85rem;
            margin-bottom: 8px;
        }

        .developer-name {
            color: #2c3e50;
            font-size: 1.1rem;
            font-weight: 700;
            margin-bottom: 15px;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
        }

        .dedication {
            border-top: 1px solid #dee2e6;
            padding-top: 15px;
        }

        .dedication-text {
            color: #495057;
            font-size: 0.95rem;
            font-weight: 600;
            margin-bottom: 8px;
            font-style: italic;
        }

        .blessing {
            color: #28a745;
            font-size: 0.9rem;
            font-weight: 600;
            margin-bottom: 0;
        }

        .contact-info {
            text-align: center;
            color: #6c757d;
            font-size: 0.9rem;
            margin-top: 20px;
        }

        /* تحسين الحقول */
        .form-group {
            position: relative;
            margin-bottom: 25px;
        }

        .form-group input {
            padding-right: 45px;
            transition: all 0.3s ease;
            border: 2px solid #e9ecef;
        }

        .form-group input:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .input-icon {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #6c757d;
            transition: color 0.3s ease;
        }

        .form-group input:focus + .input-icon {
            color: #667eea;
        }

        /* تحسين الزر */
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            padding: 15px 30px;
            font-size: 1.1rem;
            font-weight: 600;
            border-radius: 10px;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.3);
        }

        .btn-ripple {
            position: absolute;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: scale(0);
            animation: ripple 0.6s linear;
        }

        @keyframes ripple {
            to {
                transform: scale(4);
                opacity: 0;
            }
        }

        /* تصميم قسم الكشوفات */
        .current-association-info {
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            padding: 15px 20px;
            border-radius: 10px;
            border-left: 4px solid #2196f3;
            margin-bottom: 20px;
        }

        .current-association-info h3 {
            margin: 0 0 5px 0;
            color: #1976d2;
            font-size: 1.2rem;
        }

        .current-association-info p {
            margin: 0;
            color: #424242;
            font-size: 0.9rem;
        }

        .cooperation-info {
            background: linear-gradient(135deg, #e8f5e8 0%, #c8e6c9 100%);
            border-left-color: #4caf50;
        }

        .cooperation-info h3 {
            color: #2e7d32;
        }

        .report-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            border: 1px solid #dee2e6;
        }

        .report-section h3 {
            color: #495057;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #dee2e6;
        }

        .print-area {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        @media print {
            body * {
                visibility: hidden;
            }
            .print-area, .print-area * {
                visibility: visible;
            }
            .print-area {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                box-shadow: none;
            }
            .no-print {
                display: none !important;
            }
        }

        .search-box {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 1rem;
            margin-bottom: 20px;
        }

        .filter-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .filter-btn {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border: 1px solid #dee2e6;
            padding: 6px 14px;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-size: 0.85rem;
            font-weight: 500;
            position: relative;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        
        .filter-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
            transition: left 0.4s;
        }
        
        .filter-btn:hover::before {
            left: 100%;
        }
        
        .filter-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            background: linear-gradient(135deg, #e9ecef 0%, #dee2e6 100%);
        }

        .filter-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: #667eea;
            box-shadow: 0 3px 10px rgba(102, 126, 234, 0.3);
        }
        
        .filter-btn.active:hover {
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        @media (max-width: 768px) {
            .main-title {
                font-size: 2rem;
            }
            
            nav {
                gap: 8px;
            }
            
            .nav-btn {
                padding: 10px 16px;
                font-size: 0.85rem;
                min-width: 120px;
            }
            
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr) !important;
                gap: 8px !important;
            }
            
            /* تحسين إضافي للأجهزة المتوسطة */
            .association-card, .cooperation-card {
                margin-bottom: 10px;
                padding: 15px;
            }
            
            .association-header h4, .cooperation-header h4 {
                font-size: 1.1rem;
            }
            
            .association-details p, .cooperation-details p {
                font-size: 0.85rem;
            }
        }

        .member-tab-section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            background: #f8f9fa;
        }

        .member-tab-section h4 {
            color: #2c3e50;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #3498db;
        }

        #remainingTimeDisplay {
            text-align: center;
            font-size: 1.1rem;
        }

        #remainingTimeDisplay.urgent {
            background: #f8d7da !important;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        #remainingTimeDisplay.warning {
            background: #fff3cd !important;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        #remainingTimeDisplay.normal {
            background: #d4edda !important;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        @media print {
            body {
                background: white;
            }

            .container {
                max-width: none;
                padding: 0;
            }

            header nav,
            .btn,
            .search-box,
            .filter-buttons {
                display: none !important;
            }

            .content {
                background: white;
                box-shadow: none;
                border-radius: 0;
            }

            .table {
                font-size: 12px;
            }

            .table th,
            .table td {
                padding: 8px 4px;
            }
        }
    </style>
</head>
<body>
    <!-- الخلفية المتحركة -->
    <div class="floating-hearts">
        <i class="fas fa-heart"></i>
        <i class="fas fa-heart"></i>
        <i class="fas fa-heart"></i>
        <i class="fas fa-heart"></i>
        <i class="fas fa-heart"></i>
        <i class="fas fa-heart"></i>
    </div>

    <!-- شاشة تسجيل الدخول -->
    <div id="loginScreen" class="login-container">
        <div class="login-header">
            <h1 class="login-title fade-in-up">
                <i class="fas fa-heart pulse-animation"></i>
                تطبيق معاونة وجمعية الزواج
            </h1>
            <div class="app-description fade-in-up delay-1">
                <p class="main-desc">تطبيق يساعد الشباب على إنشاء الجمعيات والمعاونات</p>
                <p class="sub-desc">وإدارة حساباتها بسهولة ويسر</p>
            </div>
        </div>

        <form id="loginForm" class="fade-in-up delay-2">
            <div class="form-group">
                <label for="loginId">رقم السجل المدني</label>
                <input type="text" id="loginId" placeholder="أدخل رقم السجل المدني" required>
                <i class="fas fa-id-card input-icon"></i>
            </div>
            <button type="submit" class="btn btn-primary" style="width: 100%;">
                <i class="fas fa-sign-in-alt"></i> دخول
                <span class="btn-ripple"></span>
            </button>
        </form>

        <div class="fade-in-up delay-3">
            <div class="developer-info">
                <div class="app-credit">
                    <p class="credit-title">التطبيق</p>
                    <p class="credit-subtitle">من إعداد وتصميم</p>
                    <p class="developer-name">الأستاذ / ناصر مسعود آل مستنير</p>
                </div>
                <div class="dedication">
                    <p class="dedication-text">إهداء لشباب القبيلة و للعموم</p>
                    <p class="blessing">بارك الله فيكم وأعانكم على الخير</p>
                </div>
            </div>
            <div class="contact-info">
                <p>للحصول على حساب أو للدخول كمدير أو كعضو، تواصل مع المدير</p>
                <small style="color: #6c757d;">جميع بيانات الدخول محمية ومخصصة لكل مستخدم</small>
            </div>
        </div>
    </div>

    <!-- التطبيق الرئيسي -->
    <div id="mainApp" class="container" style="display: none;">
        <header>
            <div class="user-info" id="userWelcome">
                <i class="fas fa-user"></i> مرحباً بك
            </div>
            <h1 class="main-title" id="pageTitle">تطبيق جمعية الزواج</h1>
            <p class="subtitle">نظام إدارة شامل لجمعيات الزواج مع جميع الميزات المتقدمة</p>
            
            <nav id="mainNavigation">
                <!-- قائمة احتياطية -->
                <button class="nav-btn active" onclick="showSection('home')">
                    <i class="fas fa-home"></i> الرئيسية
                </button>
                <button class="nav-btn" onclick="showSection('terms')">
                    <i class="fas fa-file-contract"></i> القوانين
                </button>
                <button class="nav-btn btn-danger" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i> خروج
                </button>
            </nav>
        </header>

        <div class="content">
            <!-- قسم الرئيسية -->
            <div id="home" class="section active">
                <h2><i class="fas fa-tachometer-alt"></i> لوحة التحكم الرئيسية</h2>
                

                
                <!-- قسم الجمعيات -->
                <div style="margin-bottom: 40px;">
                    <h3 style="color: #2c3e50; margin-bottom: 20px; border-bottom: 2px solid #3498db; padding-bottom: 10px;">
                        <i class="fas fa-building"></i> الجمعيات المسجلة
                    </h3>
                    <div id="homeAssociationsList" class="stats-grid">
                        <!-- سيتم ملؤها بـ JavaScript -->
                    </div>
                </div>
                
                <!-- قسم المعاونات -->
                <div style="margin-bottom: 40px;">
                    <h3 style="color: #2c3e50; margin-bottom: 20px; border-bottom: 2px solid #27ae60; padding-bottom: 10px;">
                        <i class="fas fa-handshake"></i> المعاونات المسجلة
                    </h3>
                    <div id="homeCooperationsList" class="stats-grid">
                        <!-- سيتم ملؤها بـ JavaScript -->
                    </div>
                </div>
                
                <!-- الأعضاء المقرر زواجهم قريباً -->
                <div style="margin-bottom: 40px;">
                    <h3 style="color: #2c3e50; margin-bottom: 20px; border-bottom: 2px solid #e74c3c; padding-bottom: 10px;">
                        <i class="fas fa-heart"></i> الأعضاء المقرر زواجهم قريباً
                    </h3>
                    <div id="homeUpcomingWeddings">
                        <!-- سيتم ملؤها بـ JavaScript -->
                    </div>
                </div>
                
                <div class="alert alert-info">
                    <strong><i class="fas fa-info-circle"></i> مرحباً بك في تطبيق جمعية الزواج المتكامل!</strong><br>
                    يمكنك الآن إدارة جميع عمليات الجمعية من مكان واحد مع ميزات متقدمة مثل:
                    إدارة الجمعيات المتعددة، نظام المستخدمين والصلاحيات، توليد أرقام السجل المدني، 
                    النسخ الاحتياطية، والكشوفات التفصيلية.
                </div>
            </div>

            <!-- قسم البيانات الشخصية للأعضاء -->
            <div id="myProfile" class="section">
                <h2>بياناتي الشخصية</h2>
                <div id="memberProfileContent">
                    <!-- سيتم ملؤها بـ JavaScript -->
                </div>
            </div>

            <!-- قسم إدارة الجمعيات والمعاونات -->
            <div id="associations" class="section">
                <h2>إدارة الجمعيات والمعاونات</h2>

                <div style="text-align: center; margin-bottom: 30px;">
                    <button class="btn btn-primary" onclick="showAddAssociationModal('association')">
                        <i class="fas fa-plus"></i> إضافة جمعية جديدة
                    </button>
                </div>

                <div id="associationsList">
                    <!-- سيتم ملؤها بـ JavaScript -->
                </div>
            </div>

            <!-- قسم المعونات -->
            <div id="register" class="section">
                <h2>المعونات</h2>

                <!-- أزرار إدارة المعونات -->
                <div style="text-align: center; margin-bottom: 30px;">
                    <button class="btn btn-primary" onclick="showAddAssociationModal('cooperation')">
                        <i class="fas fa-handshake"></i> إضافة معاونة جديدة
                    </button>
                </div>

                <!-- قائمة المعونات -->
                <div id="cooperationsList">
                    <!-- سيتم ملؤها بـ JavaScript -->
                </div>
            </div>

            <!-- قسم قائمة الأعضاء -->
            <div id="members" class="section">
                <div class="section-header">
                    <h2><i class="fas fa-users"></i> قائمة الأعضاء</h2>
                    <div class="header-actions" id="memberListActions">
                        <!-- سيتم ملء الأزرار بـ JavaScript حسب نوع الجمعية -->
                    </div>
                </div>

                <div style="margin-bottom: 20px;">
                    <input type="text" class="search-box" id="memberSearch" placeholder="البحث في الأعضاء...">

                    <div class="filter-buttons" id="memberFilters">
                        <!-- سيتم ملؤها بـ JavaScript حسب نوع الجمعية -->
                    </div>
                </div>

                <div class="table-container">
                    <div id="membersTable">
                        <!-- سيتم ملؤها بـ JavaScript -->
                    </div>
                </div>
            </div>

            <!-- قسم التحصيل -->
            <div id="collection" class="section">
                <h2><i class="fas fa-money-bill-wave"></i> التحصيل المالي</h2>

                <div class="alert alert-warning" id="noCollectionAssociationAlert" style="display: none;">
                    <i class="fas fa-exclamation-triangle"></i>
                    <strong>تنبيه:</strong> يجب اختيار جمعية أولاً من قسم "الجمعيات" لعرض التحصيل المالي.
                </div>

                <div id="collectionContent" style="display: none;">
                    <!-- قسم الأعضاء المقرر زواجهم -->
                    <div id="scheduledMembersSection" style="margin-bottom: 30px;">
                        <h3><i class="fas fa-heart"></i> الأعضاء المقرر زواجهم</h3>
                        <div id="scheduledMembersCards">
                            <!-- سيتم ملؤها بـ JavaScript -->
                        </div>
                    </div>

                    <!-- جدول التحصيل المالي -->
                    <div id="collectionTableSection" style="display: none;">
                        <div class="collection-member-header">
                            <h3 id="collectionMemberName">تحصيل مالي للعضو: </h3>
                            <button class="btn btn-secondary" onclick="closeCollectionTable()">
                                <i class="fas fa-arrow-right"></i> العودة للقائمة
                            </button>
                        </div>

                        <!-- إحصائيات التحصيل -->
                        <div id="collectionStats" class="stats-grid" style="margin-bottom: 20px;">
                            <!-- سيتم ملؤها بـ JavaScript -->
                        </div>



                        <!-- جدول التحصيل من جميع الأعضاء -->
                        <div class="table-container">
                            <div id="memberCollectionTable">
                                <!-- سيتم ملؤها بـ JavaScript -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- قسم الكشوفات -->
            <div id="reports" class="section">
                <div class="section-header">
                    <h2><i class="fas fa-chart-bar"></i> الكشوفات والتقارير</h2>
                    <div id="currentAssociationInfo" class="current-association-info">
                        <!-- سيتم ملؤها بـ JavaScript -->
                    </div>
                </div>

                <div class="alert alert-warning" id="noAssociationAlert" style="display: none;">
                    <i class="fas fa-exclamation-triangle"></i>
                    <strong>تنبيه:</strong> يجب اختيار جمعية أو معاونة أولاً من قسم "الجمعيات" لعرض الكشوفات الخاصة بها.
                </div>

                <div id="reportsContent" style="display: none;">
                    <!-- الإحصائيات الديناميكية -->
                    <div class="stats-grid" id="reportsStatsGrid">
                        <!-- سيتم ملؤها بـ JavaScript حسب نوع الجمعية -->
                    </div>

                    <!-- أزرار التقارير الديناميكية -->
                    <div style="text-align: center; margin: 30px 0;" id="reportButtons">
                        <!-- سيتم ملؤها بـ JavaScript حسب نوع الجمعية -->
                    </div>

                    <!-- محتوى التقرير -->
                    <div id="reportContent">
                        <!-- سيتم ملؤها بـ JavaScript -->
                    </div>
                </div>
            </div>

            <!-- قسم القوانين -->
            <div id="terms" class="section">
                <h2>قوانين وشروط الجمعية</h2>

                <div style="text-align: center; margin-bottom: 20px;">
                    <button class="btn btn-primary" onclick="editTerms()">
                        <i class="fas fa-edit"></i> تعديل القوانين
                    </button>
                    <button class="btn" onclick="printTerms()">
                        <i class="fas fa-print"></i> طباعة القوانين
                    </button>
                </div>

                <div id="termsContent" style="background: #f8f9fa; padding: 20px; border-radius: 8px; line-height: 1.8;">
                    <!-- سيتم تحميل المحتوى بواسطة JavaScript -->
                </div>
            </div>

            <!-- قسم إدارة المستخدمين -->
            <div id="users" class="section">
                <h2>إدارة المستخدمين</h2>

                <!-- إحصائيات المستخدمين -->
                <div id="usersStats" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px;">
                    <!-- سيتم ملؤها بـ JavaScript -->
                </div>

                <div style="text-align: center; margin-bottom: 30px;">
                    <button class="btn btn-primary" onclick="showAddUserModal()">
                        <i class="fas fa-user-plus"></i> إضافة مستخدم جديد
                    </button>
                    <button class="btn" onclick="generateUserIds()">
                        <i class="fas fa-id-card"></i> توليد أرقام سجل للأعضاء
                    </button>
                </div>

                <div class="table-container">
                    <div id="usersTable">
                        <!-- سيتم ملؤها بـ JavaScript -->
                    </div>
                </div>
            </div>

            <!-- قسم توليد أرقام السجل المدني -->
            <div id="idGenerator" class="section">
                <h2>أرقام السجل المدني</h2>

                <div class="alert alert-info">
                    <strong>معلومات مهمة:</strong><br>
                    يتم توليد أرقام سجل مدني صالحة للأعضاء المسجلين لاستخدامها في تسجيل الدخول.
                    هذه الأرقام مولدة تلقائياً وتتبع معايير التحقق السعودية.
                </div>

                <div style="text-align: center; margin: 30px 0;">
                    <button class="btn btn-primary" onclick="generateAllIds()">
                        <i class="fas fa-magic"></i> توليد أرقام لجميع الأعضاء
                    </button>
                    <button class="btn" onclick="printIdsList()">
                        <i class="fas fa-print"></i> طباعة كشف الأرقام
                    </button>
                    <button class="btn" onclick="exportIdsToExcel()">
                        <i class="fas fa-file-excel"></i> تصدير إلى Excel
                    </button>
                </div>

                <div class="table-container">
                    <div id="idsTable">
                        <!-- سيتم ملؤها بـ JavaScript -->
                    </div>
                </div>
            </div>

            <!-- قسم النسخ الاحتياطية -->
            <div id="backup" class="section">
                <h2>النسخ الاحتياطية</h2>

                <div class="alert alert-info">
                    <strong>أهمية النسخ الاحتياطية:</strong><br>
                    احرص على عمل نسخة احتياطية بشكل دوري لحماية بياناتك من الفقدان.
                    يمكنك تصدير جميع البيانات واستيرادها في أي وقت.
                </div>

                <div style="text-align: center; margin: 40px 0;">
                    <button class="btn btn-primary" onclick="exportAllData()">
                        <i class="fas fa-download"></i> تصدير نسخة احتياطية كاملة
                    </button>
                    <button class="btn" onclick="document.getElementById('importFile').click()">
                        <i class="fas fa-upload"></i> استيراد نسخة احتياطية
                    </button>
                    <input type="file" id="importFile" accept=".json" style="display: none;" onchange="importAllData(event)">
                </div>

                <div class="alert alert-warning" style="margin: 20px 0;">
                    <strong>⚠️ إعادة تعيين التطبيق:</strong><br>
                    هذا الخيار سيحذف جميع البيانات ويعيد التطبيق إلى حالته المصنعية الأولى.
                    <strong>تأكد من عمل نسخة احتياطية قبل المتابعة!</strong>
                </div>

                <div style="text-align: center; margin: 20px 0;">
                    <button class="btn btn-danger" onclick="resetToFactory()" style="background: #dc3545; border-color: #dc3545;">
                        <i class="fas fa-exclamation-triangle"></i> مسح جميع البيانات (إعادة تعيين مصنعية)
                    </button>
                </div>

                <div id="backupHistory">
                    <h3>سجل النسخ الاحتياطية</h3>
                    <div id="backupList">
                        <!-- سيتم ملؤها بـ JavaScript -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- النوافذ المنبثقة -->

    <!-- نافذة إضافة جمعية/معاونة -->
    <div id="addAssociationModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('addAssociationModal')">&times;</span>
            <h3 id="associationModalTitle">إضافة جمعية جديدة</h3>
            <form id="associationForm">
                <input type="hidden" id="assocType" value="association">
                <input type="hidden" id="assocId" value="">

                <div class="form-group">
                    <label for="assocName">الاسم *</label>
                    <input type="text" id="assocName" required>
                </div>
                <div class="form-group">
                    <label for="assocDescription">الوصف</label>
                    <textarea id="assocDescription" rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label for="assocDate">تاريخ الإنشاء *</label>
                    <input type="date" id="assocDate" required>
                </div>
                <div class="form-group" id="amountGroup">
                    <label for="assocAmount">المبلغ المتفق عليه (ريال) *</label>
                    <input type="number" id="assocAmount" min="0" step="0.01">
                    <small style="color: #7f8c8d;">المبلغ الذي يدفعه كل عضو في الجمعية</small>
                </div>
                <div class="form-group">
                    <label for="assocPresident">الرئيس/المسؤول</label>
                    <input type="text" id="assocPresident">
                </div>
                <div class="form-group">
                    <label for="assocSecretary">أمين السر</label>
                    <input type="text" id="assocSecretary">
                </div>
                <div class="form-group">
                    <label for="assocTreasurer">أمين الصندوق</label>
                    <input type="text" id="assocTreasurer">
                </div>
                <div style="text-align: center; margin-top: 20px;">
                    <button type="submit" class="btn">
                        <i class="fas fa-save"></i> <span id="saveButtonText">حفظ الجمعية</span>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- نافذة نسخ ولصق البيانات -->
    <div id="pasteModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('pasteModal')">&times;</span>
            <h3>نسخ ولصق بيانات الأعضاء</h3>
            <div class="alert alert-info">
                <strong>🚀 مرونة كاملة - الصق أي شيء!</strong><br><br>

                <strong>✅ يمكنك لصق:</strong><br>
                • قائمة أسماء بسيطة (سطر لكل اسم)<br>
                • بيانات من Excel مباشرة<br>
                • أي تنسيق بأي فواصل<br>
                • حتى لو كان عمود واحد فقط!<br><br>

                <strong>📋 أمثلة للنسخ:</strong><br><br>

                <strong>أسماء فقط:</strong><br>
                أحمد محمد السعد<br>
                فاطمة علي أحمد<br>
                محمد عبدالله<br><br>

                <strong>من Excel (Tab):</strong><br>
                أحمد محمد&nbsp;&nbsp;&nbsp;&nbsp;0501234567&nbsp;&nbsp;&nbsp;&nbsp;28<br>
                فاطمة علي&nbsp;&nbsp;&nbsp;&nbsp;0509876543&nbsp;&nbsp;&nbsp;&nbsp;25<br><br>

                <strong>بالفواصل:</strong><br>
                أحمد محمد, 0501234567, 28, ذكر<br>
                فاطمة علي, 0509876543, 25, أنثى<br><br>

                <strong>🤖 النظام ذكي:</strong> يتعرف على الأسماء النسائية ويولد أرقام هواتف تلقائياً عند الحاجة!
            </div>
            <div class="form-group">
                <label for="pasteData">الصق البيانات هنا</label>
                <textarea id="pasteData" rows="15" placeholder="الصق بيانات الأعضاء هنا..."></textarea>
            </div>
            <div style="text-align: center; margin-top: 20px;">
                <button class="btn" onclick="processPastedData()">
                    <i class="fas fa-check"></i> معالجة البيانات
                </button>
                <button class="btn btn-warning" onclick="closeModal('pasteModal')">
                    <i class="fas fa-times"></i> إلغاء
                </button>
            </div>
        </div>
    </div>

    <!-- نافذة إضافة مستخدم -->
    <div id="addUserModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('addUserModal')">&times;</span>
            <h3>إضافة مستخدم جديد</h3>
            <form id="userForm">
                <div class="form-group">
                    <label for="userName">الاسم الكامل *</label>
                    <input type="text" id="userName" required>
                </div>
                <div class="form-group">
                    <label for="userRole">الدور *</label>
                    <select id="userRole" required>
                        <option value="">اختر الدور</option>
                        <option value="admin">مدير - صلاحيات كاملة</option>
                        <option value="supervisor">مشرف - إدارة الأعضاء والتحصيل</option>
                        <option value="member">عضو - عرض البيانات فقط</option>
                        <option value="guest">زائر - عرض محدود</option>
                    </select>
                    <small style="color: #6c757d; font-size: 0.8rem;">
                        سيتم توليد رقم سجل مدني تلقائياً للمستخدم الجديد
                    </small>
                </div>
                <div class="form-group">
                    <label for="userPhone">رقم الهاتف</label>
                    <input type="tel" id="userPhone">
                </div>
                <div style="text-align: center; margin-top: 20px;">
                    <button type="submit" class="btn">
                        <i class="fas fa-save"></i> حفظ المستخدم
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- نافذة تعديل القوانين -->
    <div id="editTermsModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('editTermsModal')">&times;</span>
            <h3>تعديل القوانين</h3>
            <form id="termsForm">
                <div class="form-group">
                    <label for="termsEditor">محتوى القوانين</label>
                    <textarea id="termsEditor" rows="15" style="width: 100%;"></textarea>
                </div>
                <div style="text-align: center; margin-top: 20px;">
                    <button type="submit" class="btn">
                        <i class="fas fa-save"></i> حفظ التعديلات
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- نافذة الاتفاقية للأعضاء -->
    <div id="memberAgreementModal" class="modal" style="z-index: 10000;">
        <div class="modal-content" style="max-width: 800px; max-height: 90vh; overflow-y: auto;">
            <h3 style="text-align: center; color: #2c3e50; margin-bottom: 20px;">
                <i class="fas fa-file-contract"></i> اتفاقية الجمعية
            </h3>
            
            <div class="alert alert-warning" style="margin-bottom: 20px; padding: 15px; background-color: #fff3cd; border: 1px solid #ffeaa7; border-radius: 5px;">
                <i class="fas fa-exclamation-triangle"></i>
                <strong>يجب عليك قراءة قوانين الجمعية والموافقة عليها للدخول على حسابك الشخصي</strong>
            </div>
            
            <div id="agreementContent" style="background: #f8f9fa; padding: 20px; border-radius: 5px; margin-bottom: 20px; max-height: 400px; overflow-y: auto; border: 1px solid #dee2e6;">
                <!-- سيتم تحميل محتوى الاتفاقية هنا -->
            </div>
            
            <div style="text-align: center; margin: 20px 0;">
                <label style="display: flex; align-items: center; justify-content: center; font-size: 16px; font-weight: bold; color: #2c3e50;">
                    <input type="checkbox" id="agreementCheckbox" style="margin-left: 10px; transform: scale(1.2);">
                    أوافق على جميع بنود وشروط الاتفاقية أعلاه
                </label>
            </div>
            
            <div style="text-align: center; margin-top: 20px;">
                <button type="button" class="btn btn-success" id="confirmAgreementBtn" onclick="confirmAgreement()" disabled>
                    <i class="fas fa-check"></i> موافق والدخول للحساب
                </button>
            </div>
        </div>
    </div>

    <!-- نافذة تسجيل عضو معاونة فردي -->
    <div id="addCooperationMemberModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('addCooperationMemberModal')">&times;</span>
            <h3>تسجيل عضو معاونة جديد</h3>
            <form id="cooperationMemberForm">
                <div class="form-group">
                    <label for="cooperationMemberName">الاسم الكامل *</label>
                    <input type="text" id="cooperationMemberName" required placeholder="أدخل الاسم الكامل">
                </div>
                <div style="text-align: center; margin-top: 20px;">
                    <button type="submit" class="btn">
                        <i class="fas fa-user-plus"></i> تسجيل العضو
                    </button>
                    <button type="button" class="btn btn-warning" onclick="closeModal('addCooperationMemberModal')">
                        <i class="fas fa-times"></i> إلغاء
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- نافذة الاستيراد الجماعي للمعاونة -->
    <div id="bulkCooperationImportModal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <span class="close" onclick="closeModal('bulkCooperationImportModal')">&times;</span>
            <h3>استيراد أعضاء المعاونة جماعياً</h3>

            <div class="alert alert-info">
                <i class="fas fa-magic"></i>
                <strong>🚀 استيراد ذكي - مرونة كاملة!</strong>
                <div style="margin: 10px 0;">
                    <strong>✅ يمكنك لصق:</strong>
                    <ul style="margin: 5px 0 0 20px;">
                        <li><strong>أسماء فقط:</strong> كل اسم في سطر منفصل</li>
                        <li><strong>بيانات من Excel:</strong> أعمدة متعددة (اسم، مبلغ، بنك، إلخ)</li>
                        <li><strong>بيانات مختلطة:</strong> أي تنسيق - سيتم التعرف عليه تلقائياً!</li>
                    </ul>
                </div>
                <div style="margin: 10px 0;">
                    <strong>🎯 ترتيب الأعمدة المحدد:</strong>
                    <ol style="margin: 5px 0 0 20px; background: #f8f9fa; padding: 10px; border-radius: 5px;">
                        <li>🔢 <strong>رقم تسلسلي</strong> (اختياري - سيتم تجاهله)</li>
                        <li>📝 <strong>الاسم</strong> - العمود الأول بعد الرقم</li>
                        <li>💰 <strong>المبلغ</strong> - العمود الثاني</li>
                        <li>📤 <strong>نوع التحويل</strong> - العمود الثالث</li>
                        <li>🏦 <strong>البنك</strong> - العمود الرابع</li>
                        <li>👤 <strong>المستلم</strong> - العمود الخامس</li>
                    </ol>
                </div>
                <div style="margin: 10px 0;">
                    <strong>✨ مميزات:</strong>
                    <ul style="margin: 5px 0 0 20px;">
                        <li>🚫 <strong>تجاهل الأرقام التسلسلية</strong> تلقائياً (1، 2، 3، إلخ)</li>
                        <li>📋 <strong>نسخ من Excel</strong> مباشرة مع الحفاظ على الترتيب</li>
                        <li>🔄 <strong>مرونة في الفواصل:</strong> Tab، فاصلة، فاصلة منقوطة</li>
                    </ul>
                </div>
                <div style="background: #e8f5e8; padding: 8px; border-radius: 5px; margin-top: 10px;">
                    <strong>💡 نصيحة:</strong> انسخ والصق أي شيء - النظام سيفهمه!
                </div>
            </div>

            <div class="form-group">
                <label for="bulkCooperationNames">البيانات (بالترتيب المحدد أعلاه)</label>
                <textarea id="bulkCooperationNames" rows="10" placeholder="مثال 1 - أسماء فقط:
جاسر حمد
محمد حسين
صالح حمد

مثال 2 - بيانات كاملة (الترتيب: اسم، مبلغ، نوع تحويل، بنك، مستلم):
جاسر حمد	1000	تحويل بنكي	أهلي	صالح مسعود
محمد حسين	1000	تحويل بنكي	أهلي	صالح مسعود
صالح حمد	1000	تحويل بنكي	أهلي	صالح مسعود

مثال 3 - مع أرقام تسلسلية (سيتم تجاهلها):
1	جاسر حمد	1000	تحويل بنكي	أهلي	صالح مسعود
2	محمد حسين	1000	تحويل بنكي	راجحي	صالح مسعود"></textarea>
            </div>

            <div id="cooperationPreview" style="display: none;">
                <h4>معاينة الأعضاء المستوردين:</h4>
                <div id="cooperationPreviewTable"></div>
            </div>

            <div style="text-align: center; margin-top: 20px;">
                <button type="button" class="btn" onclick="previewCooperationImport()">
                    <i class="fas fa-eye"></i> معاينة
                </button>
                <button type="button" class="btn btn-success" onclick="confirmCooperationImport()" style="display: none;" id="confirmCooperationBtn">
                    <i class="fas fa-check"></i> تأكيد الاستيراد
                </button>
                <button type="button" class="btn btn-warning" onclick="closeModal('bulkCooperationImportModal')">
                    <i class="fas fa-times"></i> إلغاء
                </button>
            </div>
        </div>
    </div>

    <!-- نافذة تعديل العضو المبسطة -->
    <div id="editMemberModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('editMemberModal')">&times;</span>
            <h3 id="editMemberTitle">تعديل العضو</h3>
            <form id="editMemberForm">
                <input type="hidden" id="editMemberId">
                <div class="form-group">
                    <label for="editMemberName">الاسم الكامل *</label>
                    <input type="text" id="editMemberName" required>
                </div>
                <div class="form-group">
                    <label for="editMemberPhone">رقم الهاتف</label>
                    <input type="tel" id="editMemberPhone">
                </div>
                <div class="form-group">
                    <label for="editMemberGeneralNotes">ملاحظات عامة</label>
                    <textarea id="editMemberGeneralNotes" rows="3" placeholder="أدخل أي ملاحظات عامة خاصة بالعضو..."></textarea>
                    <small style="color: #dc3545;">ملاحظة: هذه ملاحظات عامة منفصلة عن ملاحظات التحصيل</small>
                </div>
                <div style="text-align: center; margin-top: 20px;">
                    <button type="submit" class="btn">
                        <i class="fas fa-save"></i> حفظ التعديلات
                    </button>
                    <button type="button" class="btn btn-warning" onclick="closeModal('editMemberModal')">
                        <i class="fas fa-times"></i> إلغاء
                    </button>
                </div>
            </form>
        </div>
    </div>



    <!-- نافذة تفاصيل العضو -->
    <div id="memberDetailsModal" class="modal">
        <div class="modal-content" style="max-width: 900px; max-height: 90vh; overflow-y: auto;">
            <span class="close" onclick="closeModal('memberDetailsModal')">&times;</span>
            <h3 id="memberDetailsTitle">تفاصيل العضو</h3>

            <!-- أزرار التبديل بين الأقسام -->
            <div style="text-align: center; margin: 20px 0; border-bottom: 2px solid #e9ecef; padding-bottom: 15px;">
                <button class="btn btn-primary" id="personalInfoTab" onclick="showMemberTab('personalInfo')">
                    <i class="fas fa-user"></i> البيانات الشخصية
                </button>
                <button class="btn" id="bankInfoTab" onclick="showMemberTab('bankInfo')">
                    <i class="fas fa-university"></i> البيانات البنكية
                </button>
                <button class="btn" id="marriageInfoTab" onclick="showMemberTab('marriageInfo')">
                    <i class="fas fa-heart"></i> بيانات الزواج
                </button>
                <button class="btn" id="statisticsTab" onclick="showMemberTab('statistics')">
                    <i class="fas fa-chart-bar"></i> الإحصائيات
                </button>
            </div>

            <!-- قسم البيانات الشخصية -->
            <div id="personalInfoSection" class="member-tab-section">
                <h4><i class="fas fa-user"></i> البيانات الشخصية</h4>
                <form id="personalInfoForm">
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="detailName">الاسم الكامل</label>
                            <input type="text" id="detailName">
                        </div>
                        <div class="form-group">
                            <label for="detailPhone">رقم الهاتف</label>
                            <input type="tel" id="detailPhone">
                        </div>
                        <div class="form-group">
                            <label for="detailStatus">الحالة الاجتماعية</label>
                            <select id="detailStatus">
                                <option value="أعزب">أعزب</option>
                                <option value="عزباء">عزباء</option>
                                <option value="مطلق">مطلق</option>
                                <option value="مطلقة">مطلقة</option>
                                <option value="أرمل">أرمل</option>
                                <option value="أرملة">أرملة</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="detailCity">المدينة</label>
                            <input type="text" id="detailCity">
                        </div>
                        <div class="form-group">
                            <label for="detailGender">الجنس</label>
                            <select id="detailGender">
                                <option value="ذكر">ذكر</option>
                                <option value="أنثى">أنثى</option>
                            </select>
                        </div>
                    </div>
                </form>
            </div>

            <!-- قسم البيانات البنكية -->
            <div id="bankInfoSection" class="member-tab-section" style="display: none;">
                <h4><i class="fas fa-university"></i> البيانات البنكية</h4>
                <form id="bankInfoForm">
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="detailIban">رقم الآيبان (IBAN)</label>
                            <input type="text" id="detailIban" placeholder="SA0000000000000000000000" maxlength="24">
                        </div>
                        <div class="form-group">
                            <label for="detailAccountNumber">رقم الحساب</label>
                            <input type="text" id="detailAccountNumber">
                        </div>
                        <div class="form-group">
                            <label for="detailBankName">اسم البنك</label>
                            <select id="detailBankName">
                                <option value="">اختر البنك</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="detailAccountHolder">اسم صاحب الحساب</label>
                            <input type="text" id="detailAccountHolder">
                        </div>
                    </div>
                </form>
            </div>

            <!-- قسم بيانات الزواج -->
            <div id="marriageInfoSection" class="member-tab-section" style="display: none;">
                <h4><i class="fas fa-heart"></i> بيانات الزواج</h4>
                <form id="marriageInfoForm">
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="detailMaritalStatus">حالة الزواج</label>
                            <select id="detailMaritalStatus" onchange="updateMarriageFields()">
                                <option value="أعزب">أعزب</option>
                                <option value="تم تحديد الزواج">تم تحديد الزواج</option>
                                <option value="تزوج">تزوج</option>
                                <option value="متزوج">متزوج</option>
                            </select>
                        </div>
                        <div class="form-group" id="marriageDateGroup" style="display: none;">
                            <label for="detailMarriageDate">تاريخ الزواج</label>
                            <input type="date" id="detailMarriageDate" onchange="calculateRemainingTime()">
                        </div>
                        <div class="form-group" id="remainingTimeGroup" style="display: none;">
                            <label>المدة المتبقية</label>
                            <div id="remainingTimeDisplay" style="padding: 10px; background: #f8f9fa; border-radius: 5px; font-weight: bold;"></div>
                        </div>
                        <div class="form-group" id="cancelMarriageGroup" style="display: none;">
                            <button type="button" class="btn btn-danger" onclick="cancelMarriageDate()">
                                <i class="fas fa-times"></i> إلغاء موعد الزواج
                            </button>
                        </div>
                    </div>
                </form>
            </div>

            <!-- قسم الإحصائيات -->
            <div id="statisticsSection" class="member-tab-section" style="display: none;">
                <h4><i class="fas fa-chart-bar"></i> الإحصائيات المالية</h4>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number" id="paidAmount">0</div>
                        <div class="stat-label">المبالغ المدفوعة للمتزوجين (ريال)</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="remainingAmount">0</div>
                        <div class="stat-label">المبالغ المتبقية للأعضاء غير المتزوجين (ريال)</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="totalAmount">0</div>
                        <div class="stat-label">المبالغ المستلمة من الأعضاء (ريال)</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="paymentPercentage">0%</div>
                        <div class="stat-label">نسبة المساهمة</div>
                    </div>
                    <div class="stat-card" id="receiptStatusCard">
                        <div class="stat-number" id="receiptStatus">❌</div>
                        <div class="stat-label">حالة استلام الجمعية</div>
                    </div>
                </div>

                <div style="margin-top: 30px;">
                    <h5>سجل المدفوعات</h5>
                    <div id="paymentHistory">
                        <!-- سيتم ملؤها بـ JavaScript -->
                    </div>
                </div>
            </div>

            <!-- أزرار الحفظ -->
            <div style="text-align: center; margin-top: 30px; padding-top: 20px; border-top: 2px solid #e9ecef;">
                <button class="btn" onclick="saveMemberDetails()">
                    <i class="fas fa-save"></i> حفظ التعديلات
                </button>
                <button class="btn btn-warning" onclick="closeModal('memberDetailsModal')">
                    <i class="fas fa-times"></i> إغلاق
                </button>
            </div>
        </div>
    </div>

    <!-- نافذة تسجيل عضو فردي مباشر -->
    <div id="directSingleRegistrationModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('directSingleRegistrationModal')">&times;</span>
            <h3>تسجيل عضو فردي</h3>
            <form id="directSingleMemberForm">
                <div class="form-group">
                    <label for="directMemberName">الاسم الكامل *</label>
                    <input type="text" id="directMemberName" required>
                </div>
                <div class="form-group">
                    <label for="directMemberPhone">رقم الهاتف</label>
                    <input type="tel" id="directMemberPhone">
                </div>
                <div class="form-group">
                    <label for="directMemberStatus">الحالة الاجتماعية</label>
                    <select id="directMemberStatus">
                        <option value="أعزب">أعزب</option>
                        <option value="عزباء">عزباء</option>
                        <option value="مطلق">مطلق</option>
                        <option value="مطلقة">مطلقة</option>
                        <option value="أرمل">أرمل</option>
                        <option value="أرملة">أرملة</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="directMemberCity">المدينة</label>
                    <input type="text" id="directMemberCity">
                </div>
                <div style="text-align: center; margin-top: 20px;">
                    <button type="submit" class="btn">
                        <i class="fas fa-save"></i> حفظ العضو
                    </button>
                    <button type="button" class="btn btn-warning" onclick="closeModal('directSingleRegistrationModal')">
                        <i class="fas fa-times"></i> إلغاء
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- نافذة الاستيراد الجماعي المباشر -->
    <div id="directBulkRegistrationModal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <span class="close" onclick="closeModal('directBulkRegistrationModal')">&times;</span>
            <h3>استيراد أعضاء جماعي</h3>
            
            <div class="alert alert-info">
                <strong>🚀 مرونة كاملة - الصق أي شيء!</strong><br><br>
                <strong>✅ يمكنك لصق:</strong><br>
                • قائمة أسماء بسيطة (سطر لكل اسم)<br>
                • بيانات من Excel مباشرة<br>
                • أي تنسيق بأي فواصل<br>
                • حتى لو كان عمود واحد فقط!<br><br>
                <strong>📋 أمثلة:</strong><br>
                أحمد محمد السعد<br>
                فاطمة علي أحمد<br>
                محمد عبدالله, 0501234567<br>
            </div>
            
            <div class="form-group">
                <label for="directBulkData">الصق بيانات الأعضاء هنا</label>
                <textarea id="directBulkData" rows="10" placeholder="الصق بيانات الأعضاء هنا..."></textarea>
            </div>
            
            <div style="text-align: center; margin: 20px 0;">
                <button class="btn" onclick="processDirectBulkData()">
                    <i class="fas fa-check"></i> معالجة البيانات
                </button>
                <button class="btn btn-warning" onclick="closeModal('directBulkRegistrationModal')">
                    <i class="fas fa-times"></i> إلغاء
                </button>
            </div>
            
            <!-- منطقة عرض المعاينة -->
            <div id="directBulkPreview" style="display: none;">
                <h4>معاينة الأعضاء</h4>
                <div id="directBulkPreviewTable"></div>
                <div style="text-align: center; margin-top: 20px;">
                    <button class="btn btn-success" onclick="saveDirectBulkMembers()">
                        <i class="fas fa-save"></i> حفظ جميع الأعضاء
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // المتغيرات العامة
        let currentUser = null;
        let currentAssociation = null;
        let associations = JSON.parse(localStorage.getItem('associations') || '[]');
        let members = JSON.parse(localStorage.getItem('members') || '[]');
        let users = JSON.parse(localStorage.getItem('users') || '[]');
        let collections = JSON.parse(localStorage.getItem('collections') || '[]');
        let terms = localStorage.getItem('terms') || getDefaultTerms();
        let currentFilter = 'all';

        // دالة فتح نافذة التسجيل الفردي للجمعيات
        function openSingleRegistration() {
            console.log('openSingleRegistration called:', {
                currentAssociation: currentAssociation,
                type: currentAssociation ? currentAssociation.type : 'no association'
            });
            if (!currentAssociation) {
                console.log('No association selected - showing error');
                showAlert('يرجى تحديد جمعية أولاً', 'error');
                return;
            }
            console.log('Opening directSingleRegistrationModal');
            openModal('directSingleRegistrationModal');
        }

        // دالة فتح نافذة الاستيراد الجماعي للجمعيات
        function openBulkRegistration() {
            console.log('openBulkRegistration called:', {
                currentAssociation: currentAssociation,
                type: currentAssociation ? currentAssociation.type : 'no association'
            });
            if (!currentAssociation) {
                console.log('No association selected - showing error');
                showAlert('يرجى تحديد جمعية أولاً', 'error');
                return;
            }
            console.log('Opening directBulkRegistrationModal');
            openModal('directBulkRegistrationModal');
        }

        // تهيئة التطبيق
        window.addEventListener('load', function() {
            // التحقق من وجود جلسة نشطة أولاً
            const hasActiveSession = checkActiveSession();
            if (!hasActiveSession) {
                initializeApp();
            }

            // جعل الدوال متاحة عالمياً
            window.moveCollectionMember = moveCollectionMember;
            window.toggleMemberLock = toggleMemberLock;
            window.showMemberNotes = showMemberNotes;
            window.clearCollectionData = clearCollectionData;
            window.updateCollectionData = updateCollectionData;
        });

        // حفظ الحالة عند إغلاق الصفحة
        window.addEventListener('beforeunload', function() {
            if (currentUser) {
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
                if (currentAssociation) {
                    localStorage.setItem('currentAssociation', JSON.stringify(currentAssociation));
                }
                const activeSection = document.querySelector('.section.active');
                if (activeSection) {
                    localStorage.setItem('currentSection', activeSection.id);
                }
            }
        });

        // فحص الجلسة النشطة
        function checkActiveSession() {
            const savedUser = localStorage.getItem('currentUser');
            const savedAssociation = localStorage.getItem('currentAssociation');
            const savedSection = localStorage.getItem('currentSection');

            if (savedUser) {
                try {
                    const parsedUser = JSON.parse(savedUser);
                    
                    // تحديث البيانات أولاً
                    users = JSON.parse(localStorage.getItem('users') || '[]');
                    associations = JSON.parse(localStorage.getItem('associations') || '[]');
                    members = JSON.parse(localStorage.getItem('members') || '[]');
                    
                    // التحقق من وجود المستخدم في قاعدة البيانات
                    const userExists = users.find(u => 
                        (u.id === parsedUser.id) || 
                        (u.civilId === parsedUser.civilId && parsedUser.civilId !== '')
                    );
                    
                    if (!userExists) {
                        console.log('المستخدم المحفوظ لم يعد موجوداً في قاعدة البيانات');
                        clearSession();
                        return false;
                    }
                    
                    // تحديث بيانات المستخدم الحالي
                    currentUser = userExists;
                    currentUser.lastLogin = new Date().toISOString();
                    
                    // تحديث آخر دخول في قاعدة البيانات
                    const userIndex = users.findIndex(u => u.id === currentUser.id);
                    if (userIndex !== -1) {
                        users[userIndex].lastLogin = currentUser.lastLogin;
                        saveUsers();
                    }
                    
                    // حفظ المستخدم المحدث
                    localStorage.setItem('currentUser', JSON.stringify(currentUser));
                    
                    if (savedAssociation) {
                        try {
                            currentAssociation = JSON.parse(savedAssociation);
                        } catch (e) {
                            console.error('خطأ في تحميل بيانات الجمعية:', e);
                            currentAssociation = associations[0] || null;
                        }
                    }

                    // إخفاء شاشة الدخول وإظهار التطبيق
                    document.getElementById('loginScreen').style.display = 'none';
                    document.getElementById('mainApp').style.display = 'block';
                    document.getElementById('userWelcome').innerHTML = `<i class="fas fa-user"></i> مرحباً ${currentUser.name}`;

                    // إنشاء القائمة حسب الصلاحيات
                    setTimeout(() => {
                        buildNavigationMenu();
                    }, 100);

                    // تحديث الإحصائيات
                    updateStats();

                    // الانتقال للقسم المحفوظ
                    if (savedSection) {
                        setTimeout(() => {
                            showSection(savedSection);
                        }, 200);
                    } else {
                        updateTitle('home');
                    }

                    console.log('تم استعادة الجلسة بنجاح للمستخدم:', currentUser.name);
                    return true;
                } catch (error) {
                    console.error('خطأ في استعادة الجلسة:', error);
                    clearSession();
                }
            }
            return false;
        }

        // مسح الجلسة
        function clearSession() {
            localStorage.removeItem('currentUser');
            localStorage.removeItem('currentAssociation');
            localStorage.removeItem('currentSection');
            currentUser = null;
            currentAssociation = null;
        }

        function initializeApp() {
            // تحميل البيانات من localStorage أولاً
            users = JSON.parse(localStorage.getItem('users') || '[]');
            associations = JSON.parse(localStorage.getItem('associations') || '[]');
            members = JSON.parse(localStorage.getItem('members') || '[]');
            collections = JSON.parse(localStorage.getItem('collections') || '[]');
            terms = JSON.parse(localStorage.getItem('terms') || '[]');
            
            // حذف البيانات الافتراضية إذا كانت موجودة
            associations = associations.filter(assoc => assoc.name !== 'جمعية الزواج الرئيسية');
            users = users.filter(user => user.id !== 'admin');
            
            // حفظ البيانات المحدثة
            localStorage.setItem('associations', JSON.stringify(associations));
            localStorage.setItem('users', JSON.stringify(users));
            
            console.log('تم تحميل البيانات:', {
                users: users.length,
                associations: associations.length,
                members: members.length
            });
            
            // لا يوجد مستخدمين افتراضيين - المستخدم ينشئ الحسابات بنفسه

            // إذا لم تكن هناك جلسة نشطة، عرض الإحصائيات الافتراضية
            if (!currentUser) {
                updateStats();
                updateTitle('home');
            }

            // لا توجد جمعيات افتراضية - المستخدم ينشئ الجمعيات بنفسه
            
            // تعيين الجمعية الحالية إذا لم تكن محددة
            if (!currentAssociation && associations.length > 0) {
                currentAssociation = associations[0];
                if (currentUser) {
                    localStorage.setItem('currentAssociation', JSON.stringify(currentAssociation));
                }
            }

            // تحديد تاريخ اليوم في حقل التحصيل
            const collectionDateField = document.getElementById('collectionDate');
            if (collectionDateField) {
                collectionDateField.value = new Date().toISOString().split('T')[0];
            }

            // تحديث حقل المبلغ حسب الجمعية الحالية
            updateMemberAmountField();
        }

        // وظائف تسجيل الدخول
        document.getElementById('loginForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const loginId = document.getElementById('loginId').value.trim();

            // إضافة مؤثر الريبل للزر
            const button = e.target.querySelector('button[type="submit"]');
            addRippleEffect(button, e);

            if (loginId === 'admin') {
                let adminUser = users.find(u => u.id === 'admin');
                
                // التحقق من وجود المدير وتكامل بياناته
                if (!adminUser || typeof adminUser.role === 'undefined') {
                    // إذا لم يكن موجوداً أو بياناته غير مكتملة، يتم إنشاؤه أو تحديثه
                    const adminData = {
                        id: 'admin',
                        name: 'المدير العام',
                        role: 'admin',
                        phone: '',
                        civilId: 'admin',
                        createdAt: adminUser ? adminUser.createdAt : new Date().toISOString(),
                        lastLogin: new Date().toISOString()
                    };

                    if (adminUser) {
                        // تحديث المستخدم الموجود
                        Object.assign(adminUser, adminData);
                    } else {
                        // إضافة مستخدم جديد
                        adminUser = adminData;
                        users.push(adminUser);
                    }
                    saveUsers();
                } else {
                    // تحديث تاريخ آخر دخول
                    adminUser.lastLogin = new Date().toISOString();
                    saveUsers();
                }

                currentUser = adminUser;
                login();
            } else {
                // تحديث قائمة المستخدمين والأعضاء قبل البحث
                users = JSON.parse(localStorage.getItem('users') || '[]');
                members = JSON.parse(localStorage.getItem('members') || '[]');
                console.log('البحث عن المستخدم برقم السجل المدني:', loginId);
                console.log('عدد المستخدمين المتاحين:', users.length);
                console.log('عدد الأعضاء المتاحين:', members.length);
                
                // البحث عن المستخدم برقم السجل المدني
                let user = users.find(u => u.civilId === loginId);
                console.log('نتيجة البحث في المستخدمين:', user ? 'تم العثور على المستخدم' : 'لم يتم العثور على المستخدم');
                
                // إذا لم يتم العثور على المستخدم، البحث في الأعضاء وإنشاء مستخدم جديد
                if (!user) {
                    const member = members.find(m => m.civilId === loginId);
                    console.log('البحث في الأعضاء:', member ? 'تم العثور على العضو' : 'لم يتم العثور على العضو');
                    
                    if (member) {
                        // إنشاء مستخدم جديد من بيانات العضو
                        user = {
                            id: member.id,
                            name: member.name,
                            role: 'member',
                            phone: member.phone,
                            civilId: member.civilId,
                            createdAt: new Date().toISOString(),
                            lastLogin: new Date().toISOString()
                        };
                        
                        users.push(user);
                        saveUsers();
                        console.log('تم إنشاء مستخدم جديد من بيانات العضو');
                    }
                }
                
                if (user) {
                    currentUser = user;
                    user.lastLogin = new Date().toISOString();
                    saveUsers();
                    console.log('تم تسجيل الدخول بنجاح للمستخدم:', user.name);
                    login();
                } else {
                    console.log('فشل في العثور على المستخدم. البيانات المتاحة:');
                    console.log('- عدد المستخدمين:', users.length);
                    console.log('- عدد الأعضاء:', members.length);
                    console.log('- أرقام السجل المدني للمستخدمين:', users.map(u => u.civilId));
                    console.log('- أرقام السجل المدني للأعضاء:', members.filter(m => m.civilId).map(m => m.civilId));
                    
                    // محاولة أخيرة للبحث في الأعضاء بدون تمييز الأحرف
                    const memberByName = members.find(m => m.name && m.name.toLowerCase().includes(loginId.toLowerCase()));
                    if (memberByName) {
                        showAlert(`تم العثور على عضو بالاسم "${memberByName.name}" ولكن لا يوجد له رقم سجل مدني. يرجى التواصل مع المدير لتوليد رقم سجل مدني.`, 'warning');
                    } else {
                        showAlert('رقم السجل المدني غير صحيح أو غير مسجل. يرجى التأكد من الرقم أو التواصل مع المدير.', 'error');
                    }
                }
            }
        });

        // وظيفة إضافة مؤثر الريبل
        function addRippleEffect(button, event) {
            const ripple = button.querySelector('.btn-ripple');
            if (ripple) {
                const rect = button.getBoundingClientRect();
                const size = Math.max(rect.width, rect.height);
                const x = event.clientX - rect.left - size / 2;
                const y = event.clientY - rect.top - size / 2;

                ripple.style.width = ripple.style.height = size + 'px';
                ripple.style.left = x + 'px';
                ripple.style.top = y + 'px';
                ripple.style.transform = 'scale(0)';
                ripple.style.animation = 'ripple 0.6s linear';

                setTimeout(() => {
                    ripple.style.animation = '';
                }, 600);
            }
        }

        function login() {
            // فحص ما إذا كان المستخدم عضو ولم يوافق على الاتفاقية
            if (currentUser.role === 'member' && !hasAgreedToTerms(currentUser.id)) {
                // إظهار نافذة الاتفاقية
                showMemberAgreement(currentUser.id);
                return;
            }
            
            // إكمال عملية تسجيل الدخول
            completeLogin();
        }

        function logout() {
            if (confirm('هل أنت متأكد من تسجيل الخروج؟')) {
                currentUser = null;
                currentAssociation = null;

                // مسح الحالة المحفوظة
                localStorage.removeItem('currentUser');
                localStorage.removeItem('currentAssociation');
                localStorage.removeItem('currentSection');

                document.getElementById('loginScreen').style.display = 'block';
                document.getElementById('mainApp').style.display = 'none';
                document.getElementById('loginId').value = '';
                showSection('home');
            }
        }

        // وظائف التنقل
        function goToRegister(mode) {
            const registerNavButton = document.querySelector('.nav-btn[onclick="showSection(\'register\')"]');
            if (registerNavButton) {
                registerNavButton.click();
            } else {
                // Fallback
                showSection('register');
            }
            showRegistrationMode(mode);
        }

        function showSection(sectionId) {
            // التحقق من الصلاحيات
            // الأقسام المتاحة للجميع
            const publicSections = ['home', 'terms'];

            const sectionPermissions = {
                'home': 'view_all',
                'myProfile': 'view_own_details',
                'associations': 'manage_associations',
                'register': 'add_member',
                'members': 'view_all',
                'collection': 'manage_collections',
                'reports': 'view_reports',
                'terms': 'view_all',
                'users': 'manage_users',
                'idGenerator': 'manage_users',
                'backup': 'manage_users'
            };

            // التحقق من الصلاحيات
            if (!publicSections.includes(sectionId)) {
                const requiredPermission = sectionPermissions[sectionId];
                if (requiredPermission && !hasPermission(requiredPermission)) {
                    // للأعضاء، السماح بالوصول لقسم البيانات الشخصية
                    if (sectionId === 'myProfile' && currentUser && currentUser.role === 'member') {
                        // السماح بالوصول
                    } else {
                        showAlert('ليس لديك صلاحية للوصول لهذا القسم', 'error');
                        return;
                    }
                }
            }

            // إخفاء جميع الأقسام
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });

            // إزالة الفئة النشطة من جميع الأزرار
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('active');
            });

            // عرض القسم المحدد
            document.getElementById(sectionId).classList.add('active');

            // تفعيل الزر المحدد
            if (event && event.target) {
                event.target.classList.add('active');
            } else {
                // البحث عن الزر المناسب وتفعيله
                const targetButton = document.querySelector(`[onclick="showSection('${sectionId}')"]`);
                if (targetButton) {
                    targetButton.classList.add('active');
                }
            }

            // تحديث العنوان
            updateTitle(sectionId);

            // حفظ القسم الحالي
            if (currentUser) {
                localStorage.setItem('currentSection', sectionId);
            }

            // تحديث المحتوى حسب القسم
            switch(sectionId) {
                case 'home':
                    updateStats();
                    break;
                case 'myProfile':
                    displayMemberProfile();
                    break;
                case 'associations':
                    displayAssociations();
                    break;
                case 'members':
                    displayMembers();
                    updateMemberListActions(); // تحديث أزرار إضافة الأعضاء
                    break;
                case 'register':
                    displayCooperations();
                    break;
                case 'collection':
                    updateCollectionSection();
                    break;
                case 'reports':
                    updateReportsSection();
                    break;
                case 'terms':
                    loadCustomTerms();
                    break;
                case 'users':
                    displayUsers();
                    break;
                case 'idGenerator':
                    displayIds();
                    break;
                case 'backup':
                displayBackupHistory();
                break;
        }
        
        // إضافة الفوتر للقسم الحالي
        addFooterToSection(sectionId);
    }

        // إضافة الفوتر لجميع الأقسام
        function addFooterToSection(sectionId) {
            const section = document.getElementById(sectionId);
            if (!section) return;
            
            // إزالة الفوتر السابق إن وجد
            const existingFooter = section.querySelector('.app-footer');
            if (existingFooter) {
                existingFooter.remove();
            }
            
            // إنشاء الفوتر الجديد
            const footer = document.createElement('div');
            footer.className = 'app-footer';
            footer.style.cssText = `
                text-align: center;
                margin-top: 40px;
                padding: 20px;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                border-radius: 10px;
                box-shadow: 0 4px 15px rgba(0,0,0,0.2);
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            `;
            
            footer.innerHTML = `
                <p style="margin: 0; font-size: 18px; font-weight: bold;">تطبيق معاونة وجمعية الزواج النسخة الاولى</p>
                <p style="margin: 10px 0 0 0; font-size: 14px; opacity: 0.9;">اعداد وتصميم الأستاذ / ناصر مسعود آل مستنير</p>
                <p style="margin: 5px 0 0 0; font-size: 12px; opacity: 0.8;">📱 0505723776 | ✉️ yam287@gmail.com</p>
            `;
            
            // إضافة الفوتر في نهاية القسم
            section.appendChild(footer);
        }

        // تحديث عنوان الصفحة
        function updateTitle(sectionId) {
            const titles = {
                'home': 'تطبيق جمعية الزواج - الرئيسية',
                'associations': 'تطبيق جمعية الزواج - إدارة الجمعيات',
                'register': 'تطبيق جمعية الزواج - المعونات',
                'members': 'تطبيق جمعية الزواج - قائمة الأعضاء',
                'collection': 'تطبيق جمعية الزواج - التحصيل المالي',
                'reports': 'تطبيق جمعية الزواج - الكشوفات والتقارير',
                'terms': 'تطبيق جمعية الزواج - القوانين',
                'users': 'تطبيق جمعية الزواج - إدارة المستخدمين',
                'idGenerator': 'تطبيق جمعية الزواج - أرقام السجل المدني',
                'backup': 'تطبيق جمعية الزواج - النسخ الاحتياطية'
            };

            const associationName = currentAssociation ? ` - ${currentAssociation.name}` : '';
            document.getElementById('pageTitle').textContent = (titles[sectionId] || 'تطبيق جمعية الزواج') + associationName;
        }

        // وظائف الحفظ
        function saveAssociations() {
            localStorage.setItem('associations', JSON.stringify(associations));
        }

        function saveMembers() {
            localStorage.setItem('members', JSON.stringify(members));
        }

        function saveUsers() {
            localStorage.setItem('users', JSON.stringify(users));
        }

        function saveCollections() {
            localStorage.setItem('collections', JSON.stringify(collections));
        }

        function saveTerms() {
            localStorage.setItem('terms', terms);
        }

        // وظائف الإحصائيات
        function updateStats() {
            // إحصائيات عامة
            const totalMembers = members.length;
            const marriedMembers = members.filter(m => m.maritalStatus === 'متزوج' || m.maritalStatus === 'تزوج').length;
            const scheduledMembers = members.filter(m => m.weddingDate && m.weddingDate.trim() !== '' && m.weddingDate !== 'لم يحدد التاريخ').length;
            const remainingMembers = members.filter(m => m.maritalStatus !== 'متزوج' && m.maritalStatus !== 'تزوج' && (!m.weddingDate || m.weddingDate.trim() === '' || m.weddingDate === 'لم يحدد التاريخ')).length;
            const totalAmount = members.reduce((sum, m) => sum + (parseFloat(m.amount) || 0), 0);
            // حساب المبالغ المدفوعة من قسم التحصيل المالي
            const collections = JSON.parse(localStorage.getItem('associationCollections') || '[]');
            const totalPaidAmount = members.reduce((sum, member) => {
                // التحقق من وجود تحصيل مالي فعلي للعضو
                const memberCollections = collections.filter(c => 
                    c.beneficiaryId === member.id &&
                    parseFloat(c.amount) > 0
                );
                
                if (memberCollections.length > 0) {
                    const totalCollected = memberCollections.reduce((total, c) => total + parseFloat(c.amount), 0);
                    // إذا تم تحصيل المبلغ الكامل أو أكثر، فالعضو استلم المبلغ الكامل
                    if (totalCollected >= 44000) {
                        return sum + 44000;
                    } else {
                        // إضافة المبلغ المحصل حتى لو لم يكن كاملاً
                        return sum + totalCollected;
                    }
                }
                
                // التحقق من حالة الدفع المسجلة يدوياً
                if (member.paymentStatus === 'استلم') {
                    return sum + 44000;
                }
                
                return sum;
            }, 0);
            
            const totalUnpaidAmount = members.reduce((sum, member) => {
                // التحقق من وجود تحصيل مالي فعلي للعضو
                const memberCollections = collections.filter(c => 
                    c.beneficiaryId === member.id &&
                    parseFloat(c.amount) > 0
                );
                
                // إذا كان العضو مؤهل للاستلام ولم يتم تحصيل المبلغ الكامل له
                if ((member.maritalStatus === 'متزوج' || member.maritalStatus === 'تزوج') || 
                    (member.maritalStatus === 'تم تحديد الزواج' && member.marriageDate)) {
                    
                    if (memberCollections.length > 0) {
                        const totalCollected = memberCollections.reduce((total, c) => total + parseFloat(c.amount), 0);
                        // إذا لم يتم تحصيل المبلغ الكامل، فهو مستحق للباقي
                        if (totalCollected < 44000) {
                            return sum + (44000 - totalCollected);
                        }
                    } else {
                        // إذا لم يتم تحصيل أي مبلغ وحالة الدفع ليست 'استلم'
                        if (member.paymentStatus !== 'استلم') {
                            return sum + 44000;
                        }
                    }
                }
                
                return sum;
            }, 0);
            
            // إحصائيات الجمعيات والمعاونات
            const totalAssociations = associations.filter(a => a.type !== 'cooperation').length;
            const totalCooperations = associations.filter(a => a.type === 'cooperation').length;
            const activeAssociations = associations.filter(a => a.type !== 'cooperation' && a.status === 'نشطة').length;
            const activeCooperations = associations.filter(a => a.type === 'cooperation' && a.status === 'نشطة').length;

            // حساب إحصائيات الجمعيات
            const associationMembers = members.filter(m => {
                const assoc = associations.find(a => a.id === m.associationId);
                return assoc && assoc.type !== 'cooperation';
            });
            const associationMarriedMembers = associationMembers.filter(m => m.maritalStatus === 'متزوج' || m.maritalStatus === 'تزوج').length;
            const associationScheduledMembers = associationMembers.filter(m => m.weddingDate && m.weddingDate.trim() !== '' && m.weddingDate !== 'لم يحدد التاريخ').length;
            const associationRemainingMembers = associationMembers.filter(m => m.maritalStatus !== 'متزوج' && m.maritalStatus !== 'تزوج' && (!m.weddingDate || m.weddingDate.trim() === '' || m.weddingDate === 'لم يحدد التاريخ')).length;
            const associationTotalAmount = associationMembers.reduce((sum, m) => sum + (parseFloat(m.amount) || 0), 0);
            // حساب المبالغ المدفوعة من قسم التحصيل المالي للجمعيات
                const associationPaidAmount = associationMembers.reduce((sum, member) => {
                    // التحقق من وجود تحصيل مالي فعلي للعضو في جمعيته
                    const memberCollections = collections.filter(c => 
                        c.beneficiaryId === member.id &&
                        c.associationId === member.associationId &&
                        parseFloat(c.amount) > 0
                    );
                    
                    if (memberCollections.length > 0) {
                        const totalCollected = memberCollections.reduce((total, c) => total + parseFloat(c.amount), 0);
                        // إذا تم تحصيل المبلغ الكامل أو أكثر، فالعضو استلم
                        if (totalCollected >= 44000) {
                            return sum + 44000;
                        }
                    }
                    
                    // التحقق من حالة الدفع المسجلة يدوياً
                    if (member.paymentStatus === 'استلم') {
                        return sum + 44000;
                    }
                    
                    return sum;
                }, 0);

            // حساب إحصائيات المعاونات
            const cooperationMembers = members.filter(m => {
                const assoc = associations.find(a => a.id === m.associationId);
                return assoc && assoc.type === 'cooperation';
            });
            const cooperationTotalAmount = cooperationMembers.reduce((sum, m) => sum + (parseFloat(m.amount) || 0), 0);
            const cooperationContributors = cooperationMembers.filter(m => m.amount && parseFloat(m.amount) > 0).length;



            // تحديث قائمة الجمعيات في الصفحة الرئيسية
            const associationsList = associations.filter(a => a.type !== 'cooperation');
            const homeAssociationsContainer = document.getElementById('homeAssociationsList');
            if (associationsList.length === 0) {
                homeAssociationsContainer.innerHTML = '<p style="text-align: center; color: #7f8c8d; padding: 20px;">لا توجد جمعيات مسجلة</p>';
            } else {
                homeAssociationsContainer.innerHTML = associationsList.map(association => {
                    const assocMembers = members.filter(m => m.associationId === association.id);
                    const marriedCount = assocMembers.filter(m => m.maritalStatus === 'متزوج' || m.maritalStatus === 'تزوج').length;
                    const scheduledCount = assocMembers.filter(m => 
                        (m.maritalStatus === 'تم تحديد الزواج' && m.marriageDate) ||
                        (m.weddingDate && m.weddingDate.trim() !== '' && m.weddingDate !== 'لم يحدد التاريخ')
                    ).length;
                    const remainingCount = assocMembers.filter(m => m.maritalStatus !== 'متزوج' && m.maritalStatus !== 'تزوج' && (!m.weddingDate || m.weddingDate.trim() === '' || m.weddingDate === 'لم يحدد التاريخ')).length;
                    
                    // حساب المبالغ الصحيحة
                    const memberContribution = 1000; // المبلغ الذي يدفعه كل عضو
                    const memberReward = 44000; // المبلغ الذي يستلمه العضو عند الزواج
                    const totalAssociationAmount = assocMembers.length * memberReward; // إجمالي مبلغ الجمعية
                    
                    // المبالغ المدفوعة للأعضاء (المتزوجين والمحددين للزواج)
                    const eligibleMembers = assocMembers.filter(m => 
                        (m.maritalStatus === 'متزوج' || m.maritalStatus === 'تزوج') || 
                        (m.maritalStatus === 'تم تحديد الزواج' && m.marriageDate) ||
                        (m.weddingDate && m.weddingDate.trim() !== '' && m.weddingDate !== 'لم يحدد التاريخ')
                    );
                    
                    // حساب المبالغ المدفوعة الفعلية من قسم التحصيل المالي
                    const collections = JSON.parse(localStorage.getItem('associationCollections') || '[]');
                    const paidAmount = eligibleMembers.reduce((sum, member) => {
                        // التحقق من وجود تحصيل مالي فعلي للعضو في هذه الجمعية
                        const memberCollections = collections.filter(c => 
                            c.beneficiaryId === member.id && 
                            c.associationId === association.id &&
                            parseFloat(c.amount) > 0
                        );
                        
                        // إذا كان العضو متزوج وتم تحصيل مبالغ له
                        if (memberCollections.length > 0) {
                            const totalCollected = memberCollections.reduce((total, c) => total + parseFloat(c.amount), 0);
                            // إذا تم تحصيل المبلغ الكامل أو أكثر، فالعضو استلم المبلغ الكامل
                            if (totalCollected >= memberReward) {
                                return sum + memberReward;
                            } else {
                                // إضافة المبلغ المحصل حتى لو لم يكن كاملاً
                                return sum + totalCollected;
                            }
                        }
                        
                        // التحقق من حالة الدفع المسجلة يدوياً
                        if (member.paymentStatus === 'استلم') {
                            return sum + memberReward;
                        }
                        
                        return sum;
                    }, 0);
                    
                    // المبالغ المستحقة للأعضاء المؤهلين الذين لم يستلموا
                    const unpaidAmount = eligibleMembers.reduce((sum, member) => {
                        // التحقق من وجود تحصيل مالي فعلي للعضو
                        const memberCollections = collections.filter(c => 
                            c.beneficiaryId === member.id && 
                            c.associationId === association.id &&
                            parseFloat(c.amount) > 0
                        );
                        
                        // إذا كان العضو متزوج ولم يتم تحصيل المبلغ الكامل له
                        if (memberCollections.length > 0) {
                            const totalCollected = memberCollections.reduce((total, c) => total + parseFloat(c.amount), 0);
                            // إذا لم يتم تحصيل المبلغ الكامل، فهو مستحق للباقي
                            if (totalCollected < memberReward) {
                                return sum + (memberReward - totalCollected);
                            }
                        } else {
                            // إذا لم يتم تحصيل أي مبلغ وحالة الدفع ليست 'استلم'
                            if (member.paymentStatus !== 'استلم') {
                                return sum + memberReward;
                            }
                        }
                        
                        return sum;
                    }, 0);
                    
                    // المبلغ المتبقي في الجمعية
                    const remainingAmount = totalAssociationAmount - paidAmount;
                    
                    // أسماء المحددين للزواج (من بيانات الأعضاء الفعلية)
                    const scheduledNames = assocMembers.filter(m => 
                        (m.maritalStatus === 'تم تحديد الزواج' && m.marriageDate) ||
                        (m.weddingDate && m.weddingDate.trim() !== '' && m.weddingDate !== 'لم يحدد التاريخ')
                    ).map(m => m.name);
                    
                    return `
                        <div class="association-card" onclick="selectAssociation('${association.id}')" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 15px; padding: 20px; margin: 10px; box-shadow: 0 8px 25px rgba(0,0,0,0.15); cursor: pointer; transition: transform 0.3s ease;" onmouseover="this.style.transform='translateY(-5px)'" onmouseout="this.style.transform='translateY(0)'">
                            <div class="association-header" style="margin-bottom: 15px; border-bottom: 1px solid rgba(255,255,255,0.2); padding-bottom: 10px;">
                                <h4 style="margin: 0; font-size: 1.2rem; font-weight: bold;">${association.name}</h4>
                                <span class="status-badge" style="background: ${association.status === 'نشطة' ? '#28a745' : '#dc3545'}; color: white; padding: 4px 8px; border-radius: 12px; font-size: 0.8rem; margin-top: 5px; display: inline-block;">${association.status}</span>
                            </div>
                            <div class="association-stats" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-bottom: 15px;">
                                <div style="text-align: center; background: rgba(255,255,255,0.1); padding: 8px; border-radius: 8px;">
                                    <div style="font-size: 1.5rem; font-weight: bold;">${assocMembers.length}</div>
                                    <div style="font-size: 0.8rem; opacity: 0.9;">إجمالي الأعضاء</div>
                                </div>
                                <div style="text-align: center; background: rgba(255,255,255,0.1); padding: 8px; border-radius: 8px;">
                                    <div style="font-size: 1.5rem; font-weight: bold;">${marriedCount}</div>
                                    <div style="font-size: 0.8rem; opacity: 0.9;">المتزوجون</div>
                                </div>
                                <div style="text-align: center; background: rgba(255,255,255,0.1); padding: 8px; border-radius: 8px;">
                                    <div style="font-size: 1.5rem; font-weight: bold;">${scheduledCount}</div>
                                    <div style="font-size: 0.8rem; opacity: 0.9;">تم تحديد زواجهم</div>
                                </div>
                                <div style="text-align: center; background: rgba(255,255,255,0.1); padding: 8px; border-radius: 8px;">
                                    <div style="font-size: 1.5rem; font-weight: bold;">${remainingCount}</div>
                                    <div style="font-size: 0.8rem; opacity: 0.9;">المتبقي</div>
                                </div>
                            </div>
                            <div class="financial-stats" style="background: rgba(255,255,255,0.1); padding: 12px; border-radius: 10px;">
                                <div style="text-align: center; margin-bottom: 12px; border-bottom: 1px solid rgba(255,255,255,0.2); padding-bottom: 8px;">
                                    <div style="font-size: 1.4rem; font-weight: bold; color: #ffd700;">${totalAssociationAmount.toLocaleString()}</div>
                                    <div style="font-size: 0.8rem; opacity: 0.9;">إجمالي مبلغ الجمعية</div>
                                </div>
                                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; margin-bottom: 8px;">
                                    <div style="text-align: center;">
                                        <div style="font-size: 1.1rem; font-weight: bold;">${paidAmount.toLocaleString()}</div>
                                        <div style="font-size: 0.7rem; opacity: 0.9;">المبالغ المدفوعة</div>
                                    </div>
                                    <div style="text-align: center;">
                                        <div style="font-size: 1.1rem; font-weight: bold;">${unpaidAmount.toLocaleString()}</div>
                                        <div style="font-size: 0.7rem; opacity: 0.9;">المبالغ المستحقة</div>
                                    </div>
                                </div>
                                <div style="text-align: center; border-top: 1px solid rgba(255,255,255,0.2); padding-top: 8px;">
                                    <div style="font-size: 1.2rem; font-weight: bold; color: #90EE90;">${remainingAmount.toLocaleString()}</div>
                                    <div style="font-size: 0.7rem; opacity: 0.9;">المتبقي في الجمعية</div>
                                </div>
                                ${scheduledNames.length > 0 ? `
                                <div style="text-align: center; border-top: 1px solid rgba(255,255,255,0.2); padding-top: 8px; margin-top: 8px;">
                                    <div style="font-size: 0.8rem; opacity: 0.9; margin-bottom: 4px;">المحددون للزواج:</div>
                                    <div style="font-size: 0.9rem; font-weight: bold; color: #ffd700;">${scheduledNames.join(', ')}</div>
                                </div>
                                ` : ''}
                            </div>
                        </div>
                    `;
                }).join('');
            }

            // تحديث قائمة الجمعيات في صفحة الجمعيات
            const associationsContainer = document.getElementById('associationsList');
            if (associationsContainer) {
                if (associationsList.length === 0) {
                    associationsContainer.innerHTML = '<p style="text-align: center; color: #7f8c8d; padding: 20px;">لا توجد جمعيات مسجلة</p>';
                } else {
                    associationsContainer.innerHTML = associationsList.map(association => {
                        const assocMembers = members.filter(m => m.associationId === association.id);
                        const totalAmount = assocMembers.reduce((sum, m) => sum + (parseFloat(m.amount) || 0), 0);
                        
                        return `
                        <div class="association-card" onclick="selectAssociation('${association.id}')" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 15px; padding: 20px; margin: 10px; box-shadow: 0 8px 25px rgba(0,0,0,0.15); cursor: pointer; transition: transform 0.3s ease;" onmouseover="this.style.transform='translateY(-5px)'" onmouseout="this.style.transform='translateY(0)'">
                            <div class="association-header" style="margin-bottom: 15px; border-bottom: 1px solid rgba(255,255,255,0.2); padding-bottom: 10px;">
                                <h4 style="margin: 0; font-size: 1.2rem; font-weight: bold;">${association.name}</h4>
                                <span class="status-badge" style="background: ${(association.status || 'نشطة') === 'نشطة' ? '#28a745' : '#dc3545'}; color: white; padding: 4px 8px; border-radius: 12px; font-size: 0.8rem; margin-top: 5px; display: inline-block;">${association.status || 'نشطة'}</span>
                            </div>
                            <div class="association-details" style="display: grid; grid-template-columns: 1fr; gap: 8px;">
                                <div style="display: flex; align-items: center; background: rgba(255,255,255,0.1); padding: 8px; border-radius: 8px;">
                                    <i class="fas fa-users" style="margin-left: 8px; color: #ffd700;"></i>
                                    <span>${assocMembers.length} عضو</span>
                                </div>
                                <div style="display: flex; align-items: center; background: rgba(255,255,255,0.1); padding: 8px; border-radius: 8px;">
                                    <i class="fas fa-calendar" style="margin-left: 8px; color: #ffd700;"></i>
                                    <span>${association.createdDate || association.date || 'غير محدد'}</span>
                                </div>
                                <div style="display: flex; align-items: center; background: rgba(255,255,255,0.1); padding: 8px; border-radius: 8px;">
                                    <i class="fas fa-money-bill-wave" style="margin-left: 8px; color: #ffd700;"></i>
                                    <span>${totalAmount.toLocaleString()} ريال</span>
                                </div>
                            </div>
                        </div>
                        `;
                    }).join('');
                }
            }

            // تحديث قائمة المعاونات في الصفحة الرئيسية
            const cooperationsList = associations.filter(a => a.type === 'cooperation');
            const homeCooperationsContainer = document.getElementById('homeCooperationsList');
            if (cooperationsList.length === 0) {
                homeCooperationsContainer.innerHTML = '<p style="text-align: center; color: #7f8c8d; padding: 20px;">لا توجد معاونات مسجلة</p>';
            } else {
                homeCooperationsContainer.innerHTML = cooperationsList.map(cooperation => {
                    const coopMembers = members.filter(m => m.associationId === cooperation.id);
                    const contributors = coopMembers.filter(m => m.amount && parseFloat(m.amount) > 0);
                    const nonContributors = coopMembers.filter(m => !m.amount || parseFloat(m.amount) === 0);
                    const totalAmount = coopMembers.reduce((sum, m) => sum + (parseFloat(m.amount) || 0), 0);
                    const averageContribution = contributors.length > 0 ? totalAmount / contributors.length : 0;
                    
                    // إحصائيات المستلمين
                    const receiverStats = {};
                    coopMembers.forEach(member => {
                        if (member.amount && parseFloat(member.amount) > 0) {
                            const receiver = member.receiver || 'غير محدد';
                            receiverStats[receiver] = (receiverStats[receiver] || 0) + parseFloat(member.amount);
                        }
                    });
                    
                    return `
                        <div class="cooperation-card" onclick="selectAssociation('${cooperation.id}')" style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); color: white; border-radius: 15px; padding: 20px; margin: 10px; box-shadow: 0 8px 25px rgba(0,0,0,0.15); cursor: pointer; transition: transform 0.3s ease;" onmouseover="this.style.transform='translateY(-5px)'" onmouseout="this.style.transform='translateY(0)'">
                            <div class="cooperation-header" style="margin-bottom: 15px; border-bottom: 1px solid rgba(255,255,255,0.2); padding-bottom: 10px;">
                                <h4 style="margin: 0; font-size: 1.2rem; font-weight: bold;">${cooperation.name}</h4>
                                <span class="status-badge" style="background: ${cooperation.status === 'نشطة' ? '#28a745' : '#dc3545'}; color: white; padding: 4px 8px; border-radius: 12px; font-size: 0.8rem; margin-top: 5px; display: inline-block;">${cooperation.status}</span>
                            </div>
                            <div class="cooperation-stats" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-bottom: 15px;">
                                <div style="text-align: center; background: rgba(255,255,255,0.1); padding: 8px; border-radius: 8px;">
                                    <div style="font-size: 1.5rem; font-weight: bold;">${coopMembers.length}</div>
                                    <div style="font-size: 0.8rem; opacity: 0.9;">إجمالي الأعضاء</div>
                                </div>
                                <div style="text-align: center; background: rgba(255,255,255,0.1); padding: 8px; border-radius: 8px;">
                                    <div style="font-size: 1.5rem; font-weight: bold;">${contributors.length}</div>
                                    <div style="font-size: 0.8rem; opacity: 0.9;">المساهمون</div>
                                </div>
                                <div style="text-align: center; background: rgba(255,255,255,0.1); padding: 8px; border-radius: 8px;">
                                    <div style="font-size: 1.5rem; font-weight: bold;">${nonContributors.length}</div>
                                    <div style="font-size: 0.8rem; opacity: 0.9;">غير المساهمين</div>
                                </div>
                                <div style="text-align: center; background: rgba(255,255,255,0.1); padding: 8px; border-radius: 8px;">
                                    <div style="font-size: 1.5rem; font-weight: bold;">${averageContribution.toLocaleString()}</div>
                                    <div style="font-size: 0.8rem; opacity: 0.9;">متوسط المساهمة</div>
                                </div>
                            </div>
                            <div class="financial-stats" style="background: rgba(255,255,255,0.1); padding: 12px; border-radius: 10px;">
                                <div style="text-align: center; margin-bottom: 10px;">
                                    <div style="font-size: 1.5rem; font-weight: bold; color: #ffd700;">${totalAmount.toLocaleString()}</div>
                                    <div style="font-size: 0.9rem; opacity: 0.9;">إجمالي المبلغ المجموع</div>
                                </div>
                                ${Object.keys(receiverStats).length > 0 ? `
                                    <div style="border-top: 1px solid rgba(255,255,255,0.2); padding-top: 8px;">
                                        <div style="font-size: 0.8rem; opacity: 0.9; margin-bottom: 5px;">توزيع المبالغ:</div>
                                        ${Object.entries(receiverStats).map(([receiver, amount]) => `
                                            <div style="display: flex; justify-content: space-between; font-size: 0.8rem; margin-bottom: 2px;">
                                                <span>${receiver}</span>
                                                <span>${amount.toLocaleString()} ريال</span>
                                            </div>
                                        `).join('')}
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    `;
                }).join('');
            }

            // تحديث قائمة المعاونات في صفحة المعاونات
            const cooperationsContainer = document.getElementById('cooperationsList');
            if (cooperationsContainer) {
                if (cooperationsList.length === 0) {
                    cooperationsContainer.innerHTML = '<p style="text-align: center; color: #7f8c8d; padding: 20px;">لا توجد معاونات مسجلة</p>';
                } else {
                    cooperationsContainer.innerHTML = cooperationsList.map(cooperation => {
                        const coopMembers = members.filter(m => m.associationId === cooperation.id);
                        const totalAmount = coopMembers.reduce((sum, m) => sum + (parseFloat(m.amount) || 0), 0);
                        
                        return `
                        <div class="cooperation-card" onclick="selectAssociation('${cooperation.id}')" style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); color: white; border-radius: 15px; padding: 20px; margin: 10px; box-shadow: 0 8px 25px rgba(0,0,0,0.15); cursor: pointer; transition: transform 0.3s ease;" onmouseover="this.style.transform='translateY(-5px)'" onmouseout="this.style.transform='translateY(0)'">
                            <div class="cooperation-header" style="margin-bottom: 15px; border-bottom: 1px solid rgba(255,255,255,0.2); padding-bottom: 10px;">
                                <h4 style="margin: 0; font-size: 1.2rem; font-weight: bold;">${cooperation.name}</h4>
                                <span class="status-badge" style="background: ${(cooperation.status || 'نشطة') === 'نشطة' ? '#28a745' : '#dc3545'}; color: white; padding: 4px 8px; border-radius: 12px; font-size: 0.8rem; margin-top: 5px; display: inline-block;">${cooperation.status || 'نشطة'}</span>
                            </div>
                            <div class="cooperation-details" style="display: grid; grid-template-columns: 1fr; gap: 8px;">
                                <div style="display: flex; align-items: center; background: rgba(255,255,255,0.1); padding: 8px; border-radius: 8px;">
                                    <i class="fas fa-handshake" style="margin-left: 8px; color: #ffd700;"></i>
                                    <span>${coopMembers.length} مساهم</span>
                                </div>
                                <div style="display: flex; align-items: center; background: rgba(255,255,255,0.1); padding: 8px; border-radius: 8px;">
                                    <i class="fas fa-calendar" style="margin-left: 8px; color: #ffd700;"></i>
                                    <span>${cooperation.createdDate || cooperation.date || 'غير محدد'}</span>
                                </div>
                                <div style="display: flex; align-items: center; background: rgba(255,255,255,0.1); padding: 8px; border-radius: 8px;">
                                    <i class="fas fa-donate" style="margin-left: 8px; color: #ffd700;"></i>
                                    <span>${totalAmount.toLocaleString()} ريال</span>
                                </div>
                            </div>
                        </div>
                        `;
                    }).join('');
                }
            }

            // تحديث قائمة الزيجات القادمة (فقط أعضاء الجمعيات وليس المعاونات)
            const upcomingWeddings = members.filter(m => {
                // البحث عن الأعضاء الذين لديهم تاريخ زواج محدد ومن الجمعيات فقط
                const association = associations.find(a => a.id === m.associationId);
                return m.weddingDate && m.weddingDate.trim() !== '' && m.weddingDate !== 'لم يحدد التاريخ' && association && association.type !== 'cooperation';
            });
            const weddingsContainer = document.getElementById('homeUpcomingWeddings');
            if (upcomingWeddings.length === 0) {
                weddingsContainer.innerHTML = '<p style="text-align: center; color: #7f8c8d; padding: 20px;">لا توجد زيجات مجدولة</p>';
            } else {
                weddingsContainer.innerHTML = upcomingWeddings.map(member => {
                    const association = associations.find(a => a.id === member.associationId);
                    
                    // حساب الأيام المتبقية للزواج
                    let daysRemaining = '';
                    if (member.weddingDate) {
                        const weddingDate = new Date(member.weddingDate);
                        const today = new Date();
                        const timeDiff = weddingDate.getTime() - today.getTime();
                        const daysDiff = Math.ceil(timeDiff / (1000 * 3600 * 24));
                        
                        if (daysDiff > 0) {
                            daysRemaining = `(متبقي ${daysDiff} يوم)`;
                        } else if (daysDiff === 0) {
                            daysRemaining = '(اليوم)';
                        } else {
                            daysRemaining = `(مضى ${Math.abs(daysDiff)} يوم)`;
                        }
                    }
                    
                    return `
                        <div class="wedding-card" style="background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%); color: white; border-radius: 15px; padding: 20px; margin: 10px; box-shadow: 0 8px 25px rgba(0,0,0,0.15); transition: transform 0.3s ease;" onmouseover="this.style.transform='translateY(-5px)'" onmouseout="this.style.transform='translateY(0)'">
                            <div class="wedding-info">
                                <h5 style="margin: 0 0 10px 0; font-size: 1.2rem; font-weight: bold;">${member.name}</h5>
                                <p style="margin: 5px 0; opacity: 0.9;"><i class="fas fa-heart"></i> ${association ? association.name : 'غير محدد'}</p>
                                <p style="margin: 5px 0; opacity: 0.9;"><i class="fas fa-calendar-alt"></i> ${member.weddingDate} ${daysRemaining}</p>
                                <p style="margin: 5px 0; opacity: 0.9;"><i class="fas fa-info-circle"></i> الحالة: ${member.maritalStatus || 'غير محدد'}</p>
                            </div>
                            <div class="wedding-amount" style="text-align: center; margin-top: 15px; padding-top: 15px; border-top: 1px solid rgba(255,255,255,0.2);">
                                <span style="font-size: 1.3rem; font-weight: bold; color: #ffd700;">${(parseFloat(member.amount) || 0).toLocaleString()} ريال</span>
                            </div>
                        </div>
                    `;
                }).join('');
            }
            
            // تم حذف الإحصائيات العامة من الصفحة الرئيسية
        }
        
        // تم حذف دالة updateGeneralStatistics

        // وظائف الأعضاء
        // تم حذف الكود المعطل الذي كان يحاول الوصول إلى عنصر غير موجود (memberForm)

        function displayMembers() {
            const container = document.getElementById('membersTable');
            const allMembers = filterMembersByAssociation();

            // تحديث الفلاتر والأزرار حسب نوع الجمعية
            updateMemberFilters();
            updateMemberListActions();

            // فلترة الأعضاء
            const filteredMembers = allMembers.filter(member => {
                if (currentFilter === 'all') return true;

                if (currentAssociation && currentAssociation.type === 'cooperation') {
                    // فلاتر المعاونات
                    if (currentFilter === 'ساهم') {
                        return member.amount && parseFloat(member.amount) > 0;
                    } else if (currentFilter === 'لم يساهم') {
                        return !member.amount || parseFloat(member.amount) === 0;
                    }
                } else {
                    // فلاتر الجمعيات
                    if (currentFilter === 'استلم' || currentFilter === 'لم يستلم') {
                        return member.paymentStatus === currentFilter;
                    }
                    return member.maritalStatus === currentFilter;
                }
                return true;
            });

            if (filteredMembers.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #7f8c8d;">لا توجد أعضاء مطابقة للفلتر المحدد</p>';
                return;
            }

            // إعادة ترقيم الترتيب إذا لم يكن موجوداً
            filteredMembers.forEach((member, index) => {
                if (member.order === undefined || member.order === null) {
                    member.order = index;
                }
            });

            // ترتيب الأعضاء حسب التاريخ مع إعطاء الأولوية للمتزوجين
            filteredMembers.sort((a, b) => {
                // المتزوجون أولاً (الأقدم)
                if (a.maritalStatus === 'متزوج' && b.maritalStatus !== 'متزوج') {
                    return -1;
                }
                if (b.maritalStatus === 'متزوج' && a.maritalStatus !== 'متزوج') {
                    return 1;
                }
                
                // ترتيب حسب التاريخ من الأقدم للأحدث
                const dateA = new Date(a.joinDate || a.createdAt || '1900-01-01');
                const dateB = new Date(b.joinDate || b.createdAt || '1900-01-01');
                const dateComparison = dateA - dateB;
                
                // إذا كانت التواريخ متساوية، ترتيب حسب الترتيب المحفوظ
                if (dateComparison === 0) {
                    return (a.order || 0) - (b.order || 0);
                }
                
                return dateComparison;
            });

            let html = '';

            // جدول مختلف للمعاونات
            if (currentAssociation && currentAssociation.type === 'cooperation') {
                // إحصائيات المعاونة
                const totalMembers = allMembers.length;
                const contributors = allMembers.filter(m => m.amount && parseFloat(m.amount) > 0).length;
                const nonContributors = totalMembers - contributors;
                const totalAmount = allMembers.reduce((sum, m) => sum + (parseFloat(m.amount) || 0), 0);

                // إحصائيات المسؤولين
                const receiverStats = {};
                const bankStats = {};

                allMembers.forEach(member => {
                    if (member.amount && parseFloat(member.amount) > 0) {
                        // إحصائيات المستلمين
                        const receiver = member.receiver || 'غير محدد';
                        receiverStats[receiver] = (receiverStats[receiver] || 0) + parseFloat(member.amount);

                        // إحصائيات البنوك
                        if (member.transferType !== 'نقداً' && member.bank) {
                            bankStats[member.bank] = (bankStats[member.bank] || 0) + parseFloat(member.amount);
                        }
                    }
                });

                html = `
                    <!-- إحصائيات المعاونة -->
                    <div class="stats-grid" style="margin-bottom: 30px;">
                        <div class="stat-card">
                            <div class="stat-number">${totalMembers}</div>
                            <div class="stat-label">إجمالي الأعضاء</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${contributors}</div>
                            <div class="stat-label">المساهمون</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${nonContributors}</div>
                            <div class="stat-label">غير المساهمين</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${totalAmount.toLocaleString()}</div>
                            <div class="stat-label">المبلغ الإجمالي (ريال)</div>
                        </div>
                `;

                // إحصائيات المسؤولين
                Object.keys(receiverStats).forEach(receiver => {
                    if (receiver !== 'غير محدد') {
                        html += `
                            <div class="stat-card">
                                <div class="stat-number">${receiverStats[receiver].toLocaleString()}</div>
                                <div class="stat-label">${receiver}</div>
                            </div>
                        `;
                    }
                });

                // إحصائيات البنوك
                Object.keys(bankStats).forEach(bank => {
                    html += `
                        <div class="stat-card">
                            <div class="stat-number">${bankStats[bank].toLocaleString()}</div>
                            <div class="stat-label">${bank}</div>
                        </div>
                    `;
                });

                html += `</div>`;

                html += `
                    <div class="alert alert-info">
                        <i class="fas fa-handshake"></i> <strong>أعضاء المعاونة:</strong> ${currentAssociation.name}
                        <small style="display: block; margin-top: 5px;">المبالغ حرة لكل عضو حسب قدرته</small>
                    </div>
                    <table class="table" style="border-collapse: collapse; width: 100%; margin-top: 20px;">
                        <thead>
                            <tr style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; height: 50px;">
                                <th style="width: 40px; padding: 8px 6px; text-align: center; border: 1px solid #dee2e6; font-size: 0.9rem; font-weight: 600;">م</th>
                                <th style="padding: 8px 10px; text-align: center; border: 1px solid #dee2e6; font-size: 0.9rem; font-weight: 600;">اسم العضو</th>
                                <th style="width: 100px; padding: 4px; text-align: center; border: 1px solid #dee2e6; font-size: 0.9rem; font-weight: 600;">
                                    <div style="margin-bottom: 4px;">المبلغ</div>
                                    <input type="number" id="bulkAmount" placeholder="تعبئة جماعية"
                                           style="width: 100%; padding: 2px; border: 1px solid rgba(255,255,255,0.3); border-radius: 3px; font-size: 0.7rem; background: rgba(255,255,255,0.1); color: white;"
                                           onchange="applyBulkAmount()"
                                           onkeypress="if(event.key==='Enter') applyBulkAmount()">
                                </th>
                                <th style="width: 140px; padding: 4px; text-align: center; border: 1px solid #dee2e6; font-size: 0.9rem; font-weight: 600;">
                                    <div style="margin-bottom: 4px;">نوع التحويل</div>
                                    <select id="bulkTransferType" style="width: 100%; padding: 2px; border: 1px solid rgba(255,255,255,0.3); border-radius: 3px; font-size: 0.7rem; background: rgba(255,255,255,0.1); color: #333;"
                                            onchange="if(this.value) applyBulkData()">
                                        <option value="">اختر</option>
                                        <option value="نقداً">نقداً</option>
                                        <option value="تحويل بنكي">تحويل بنكي</option>
                                        <option value="شيك">شيك</option>
                                        <option value="تحويل إلكتروني">تحويل إلكتروني</option>
                                        <option value="واصل">واصل</option>
                                        <option value="أخرى">أخرى</option>
                                    </select>
                                </th>
                                <th style="width: 120px; padding: 4px; text-align: center; border: 1px solid #dee2e6; font-size: 0.9rem; font-weight: 600;">
                                    <div style="margin-bottom: 4px;">البنك</div>
                                    <select id="bulkBank" style="width: 100%; padding: 2px; border: 1px solid rgba(255,255,255,0.3); border-radius: 3px; font-size: 0.7rem; background: rgba(255,255,255,0.1); color: #333;"
                                            onchange="if(this.value) applyBulkData()">
                                        <option value="">اختر</option>
                                        <option value="جمعية">جمعية</option>
                                        <option value="مناولة">مناولة</option>
                                        <option value="أخرى">أخرى</option>
                                        <option disabled>──────────</option>
                                        <option value="البنك الأهلي السعودي">البنك الأهلي السعودي</option>
                                        <option value="بنك الراجحي">بنك الراجحي</option>
                                        <option value="بنك الرياض">بنك الرياض</option>
                                        <option value="البنك السعودي للاستثمار (SAIB)">البنك السعودي للاستثمار (SAIB)</option>
                                        <option value="البنك السعودي الفرنسي">البنك السعودي الفرنسي</option>
                                        <option value="البنك العربي الوطني">البنك العربي الوطني</option>
                                        <option value="بنك ساب (SABB)">بنك ساب (SABB)</option>
                                        <option value="بنك الجزيرة">بنك الجزيرة</option>
                                        <option value="بنك البلاد">بنك البلاد</option>
                                        <option value="البنك الأول">البنك الأول</option>
                                        <option value="بنك الإنماء">بنك الإنماء</option>
                                        <option value="مصرف الإنماء">مصرف الإنماء</option>
                                        <option value="البنك السعودي البريطاني (ساب سابقاً)">البنك السعودي البريطاني (ساب سابقاً)</option>
                                        <option value="بنك الخليج الدولي">بنك الخليج الدولي</option>
                                        <option value="مصرف الراجحي">مصرف الراجحي</option>
                                        <option value="بنك الاستثمار العربي السعودي">بنك الاستثمار العربي السعودي</option>
                                        <option value="البنك التجاري الكويتي - السعودية">البنك التجاري الكويتي - السعودية</option>
                                    </select>
                                </th>
                                <th style="width: 130px; padding: 4px; text-align: center; border: 1px solid #dee2e6; font-size: 0.9rem; font-weight: 600;">
                                    <div style="margin-bottom: 4px;">المستلم</div>
                                    <select id="bulkReceiver" style="width: 100%; padding: 2px; border: 1px solid rgba(255,255,255,0.3); border-radius: 3px; font-size: 0.7rem; background: rgba(255,255,255,0.1); color: #333;"
                                            onchange="if(this.value) applyBulkData()">
                                        <option value="">اختر</option>
                                        ${currentAssociation && currentAssociation.secretary ? `<option value="${currentAssociation.secretary}">${currentAssociation.secretary}</option>` : ''}
                                        ${currentAssociation && currentAssociation.treasurer ? `<option value="${currentAssociation.treasurer}">${currentAssociation.treasurer}</option>` : ''}
                                        ${currentAssociation && currentAssociation.president ? `<option value="${currentAssociation.president}">${currentAssociation.president}</option>` : ''}
                                        <option value="العريس">العريس</option>
                                        <option value="والد العريس">والد العريس</option>
                                        <option value="آخر">آخر</option>
                                    </select>
                                </th>
                                <th style="width: 100px; padding: 8px 6px; text-align: center; border: 1px solid #dee2e6; font-size: 0.9rem; font-weight: 600;">الإجراءات</th>
                            </tr>
                        </thead>
                        <tbody id="cooperationMembersBody">
                `;

                // ترتيب الأعضاء: الذين لديهم ملاحظات في الأسفل
                const sortedCooperationMembers = [...filteredMembers].sort((a, b) => {
                    const aHasNotes = (a.generalNotes && a.generalNotes.trim() !== '') || (a.notes && a.notes.trim() !== '');
                    const bHasNotes = (b.generalNotes && b.generalNotes.trim() !== '') || (b.notes && b.notes.trim() !== '');

                    if (aHasNotes && !bHasNotes) return 1;  // a للأسفل
                    if (!aHasNotes && bHasNotes) return -1; // b للأسفل

                    return 0; // نفس الترتيب
                });

                sortedCooperationMembers.forEach((member, index) => {
                    const transferTypes = ['نقداً', 'تحويل بنكي', 'شيك', 'تحويل إلكتروني', 'واصل', 'أخرى'];
                    const hasAmount = member.amount && parseFloat(member.amount) > 0;
                    // ملاحظات العضو العامة (منفصلة عن ملاحظات التحصيل)
                    const hasGeneralNotes = member.generalNotes && member.generalNotes.trim();

                    let rowStyle = '';
                    if (hasGeneralNotes) {
                        rowStyle = 'background-color: #ffeaea;'; // أحمر خفيف للملاحظات العامة
                    } else if (hasAmount) {
                        rowStyle = 'background-color: #e8f5e8;'; // أخضر خفيف للمساهمين
                    }

                    html += `
                        <tr id="member-row-${member.id}" style="${rowStyle}">
                            <td><strong>${index + 1}</strong></td>
                            <td>
                                <div><strong>${member.name}</strong></div>
                                <small style="color: #7f8c8d;">${member.phone || 'لا يوجد رقم'}</small>
                                ${hasGeneralNotes ? `<div style="font-size: 0.8rem; color: #dc3545; margin-top: 2px;"><i class="fas fa-sticky-note"></i> ${member.generalNotes}</div>` : ''}
                            </td>
                            <td>
                                <input type="number"
                                       value="${member.amount || ''}"
                                       min="0"
                                       step="0.01"
                                       placeholder="0"
                                       style="width: 100px; padding: 4px; border: 1px solid #ddd; border-radius: 4px;"
                                       onchange="updateMemberAmount('${member.id}', this.value)">
                            </td>
                            <td>
                                <select onchange="updateMemberTransferType('${member.id}', this.value)"
                                        style="width: 100%; padding: 4px; border: 1px solid #ddd; border-radius: 4px; font-size: 0.9rem;">
                                    ${transferTypes.map(type =>
                                        `<option value="${type}" ${(member.transferType || 'نقداً') === type ? 'selected' : ''}>${type}</option>`
                                    ).join('')}
                                </select>
                            </td>
                            <td>
                                <select onchange="updateMemberBank('${member.id}', this.value)"
                                        style="width: 100%; padding: 4px; border: 1px solid #ddd; border-radius: 4px; font-size: 0.9rem;"
                                        ${(member.transferType || 'نقداً') === 'نقداً' ? 'disabled' : ''}>
                                    <option value="">اختر الوجهة</option>
                                    ${getBankOptions(member.bank || '')}
                                </select>
                            </td>
                            <td>
                                <select onchange="updateMemberReceiver('${member.id}', this.value)"
                                        style="width: 100%; padding: 4px; border: 1px solid #ddd; border-radius: 4px; font-size: 0.9rem;">
                                    <option value="">اختر المستلم</option>
                                    ${getReceiverOptions(member.receiver || '')}
                                </select>
                            </td>
                            <td>
                                ${hasPermission('edit_member') || canAccessMemberData(member.id) ? `
                                    <button class="btn btn-warning" onclick="showEditMemberModal('${member.id}')" title="تعديل" style="padding: 4px 8px; font-size: 0.8rem;">
                                        <i class="fas fa-edit" style="font-size: 0.8rem;"></i>
                                    </button>
                                ` : ''}
                                ${hasPermission('delete_member') ? `
                                    <button class="btn btn-danger" onclick="deleteMember('${member.id}')" title="حذف" style="padding: 4px 8px; font-size: 0.8rem;">
                                        <i class="fas fa-trash" style="font-size: 0.8rem;"></i>
                                    </button>
                                ` : ''}
                                ${hasPermission('edit_member') ? `
                                    <button class="btn" onclick="moveMemberUp('${member.id}')" title="للأعلى" ${index === 0 ? 'disabled' : ''} style="padding: 4px 8px; font-size: 0.8rem;">
                                        <i class="fas fa-arrow-up" style="font-size: 0.8rem;"></i>
                                    </button>
                                    <button class="btn" onclick="moveMemberDown('${member.id}')" title="للأسفل" ${index === sortedCooperationMembers.length - 1 ? 'disabled' : ''} style="padding: 4px 8px; font-size: 0.8rem;">
                                        <i class="fas fa-arrow-down" style="font-size: 0.8rem;"></i>
                                    </button>
                                ` : ''}
                            </td>
                        </tr>
                    `;
                });

                html += `
                        </tbody>
                    </table>
                `;
            } else {
                // جدول الجمعيات العادي
                html = `
                    <div class="alert alert-info">
                        <i class="fas fa-building"></i> <strong>أعضاء الجمعية:</strong> ${currentAssociation ? currentAssociation.name : ''}
                        <small style="display: block; margin-top: 5px;">المبلغ الثابت: ${currentAssociation && currentAssociation.amount ? currentAssociation.amount.toLocaleString() : '0'} ريال لكل عضو</small>
                    </div>
                    <table class="table" style="border-collapse: collapse; width: 100%; margin-top: 20px;">
                        <thead>
                            <tr style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; height: 35px;">
                                <th style="width: 40px; padding: 8px 6px; text-align: center; border: 1px solid #dee2e6; font-size: 0.9rem; font-weight: 600;">م</th>
                                <th style="padding: 8px 10px; text-align: center; border: 1px solid #dee2e6; font-size: 0.9rem; font-weight: 600;">اسم العضو</th>
                                <th style="width: 100px; padding: 8px 6px; text-align: center; border: 1px solid #dee2e6; font-size: 0.9rem; font-weight: 600;">رقم الجوال</th>
                                <th style="width: 90px; padding: 8px 6px; text-align: center; border: 1px solid #dee2e6; font-size: 0.9rem; font-weight: 600;">رقم الحساب</th>
                                <th style="width: 80px; padding: 8px 6px; text-align: center; border: 1px solid #dee2e6; font-size: 0.9rem; font-weight: 600;">اسم البنك</th>
                                <th style="width: 90px; padding: 8px 6px; text-align: center; border: 1px solid #dee2e6; font-size: 0.9rem; font-weight: 600;">حالة الزواج</th>
                                <th style="width: 100px; padding: 8px 6px; text-align: center; border: 1px solid #dee2e6; font-size: 0.9rem; font-weight: 600;">المتبقي على الزواج</th>
                                <th style="width: 100px; padding: 8px 6px; text-align: center; border: 1px solid #dee2e6; font-size: 0.9rem; font-weight: 600;">الإجراءات</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

                // ترتيب الأعضاء: المتزوجون أولاً، ثم المقرر زواجهم، ثم العزاب
                const sortedMembers = [...filteredMembers].sort((a, b) => {
                    // تحديث حالة الزواج تلقائياً
                    updateMaritalStatusAutomatically(a);
                    updateMaritalStatusAutomatically(b);

                    // الأعضاء الذين لديهم ملاحظات يذهبون للأسفل
                    const aHasNotes = (a.notes && a.notes.trim() !== '') || (a.generalNotes && a.generalNotes.trim() !== '');
                    const bHasNotes = (b.notes && b.notes.trim() !== '') || (b.generalNotes && b.generalNotes.trim() !== '');

                    if (aHasNotes && !bHasNotes) return 1;  // a للأسفل
                    if (!aHasNotes && bHasNotes) return -1; // b للأسفل

                    // إذا كان كلاهما لديه ملاحظات أو لا يوجد لديهما ملاحظات، رتب حسب حالة الزواج
                    const statusOrder = { 'تزوج': 1, 'متزوج': 1, 'تم تحديد الزواج': 2, 'أعزب': 3 };
                    const aOrder = statusOrder[a.maritalStatus] || 3;
                    const bOrder = statusOrder[b.maritalStatus] || 3;

                    if (aOrder !== bOrder) {
                        return aOrder - bOrder;
                    }

                    // إذا كانت نفس الحالة، رتب حسب تاريخ الزواج للمتزوجين والمقرر زواجهم
                    if (a.maritalStatus === 'متزوج' || a.maritalStatus === 'تزوج' || a.maritalStatus === 'تم تحديد الزواج') {
                        if (a.marriageDate && b.marriageDate) {
                            const today = new Date();
                            const aMarriageDate = new Date(a.marriageDate);
                            const bMarriageDate = new Date(b.marriageDate);
                            
                            // حساب المسافة من التاريخ الحالي (الأقرب أولاً)
                            const aDistance = Math.abs(aMarriageDate - today);
                            const bDistance = Math.abs(bMarriageDate - today);
                            
                            return aDistance - bDistance;
                        }
                    }

                    return 0;
                });

                sortedMembers.forEach((member, index) => {
                    // تحديث حالة الزواج تلقائياً
                    updateMaritalStatusAutomatically(member);

                    // حساب المتبقي على الزواج
                    let remainingTime = '-';
                    if (member.maritalStatus === 'تم تحديد الزواج' && member.marriageDate) {
                        const today = new Date();
                        const weddingDate = new Date(member.marriageDate);
                        const timeDiff = weddingDate.getTime() - today.getTime();
                        const daysDiff = Math.ceil(timeDiff / (1000 * 3600 * 24));

                        if (daysDiff > 0) {
                            remainingTime = `${daysDiff} يوم`;
                        } else if (daysDiff === 0) {
                            remainingTime = 'اليوم';
                        } else {
                            remainingTime = 'انتهى';
                        }
                    }

                    // تحديد لون الصف حسب حالة الزواج والملاحظات
                    const hasNotes = (member.notes && member.notes.trim() !== '') || (member.generalNotes && member.generalNotes.trim() !== '');
                    let rowClass = '';
                    let rowStyle = '';

                    if (hasNotes) {
                        rowStyle = 'background-color: #ffeaea;'; // أحمر خفيف للملاحظات
                    } else if (member.maritalStatus === 'متزوج' || member.maritalStatus === 'تزوج') {
                        rowClass = 'married-row';
                    } else if (member.maritalStatus === 'تم تحديد الزواج') {
                        rowClass = 'scheduled-row';
                    } else {
                        rowClass = 'single-row';
                    }

                    html += `
                        <tr class="${rowClass}" style="${rowStyle}">
                            <td style="text-align: center;"><strong>${index + 1}</strong></td>
                            <td>
                                <div><strong>${member.name}</strong></div>
                                ${hasNotes ? `<small style="color: #dc3545; font-size: 0.8rem;"><i class="fas fa-sticky-note"></i> ${member.generalNotes || member.notes || ''}</small>` : ''}
                            </td>
                            <td style="text-align: center;">${member.phone || '-'}</td>
                            <td style="text-align: center;">${member.accountNumber || '-'}</td>
                            <td style="text-align: center;">${member.bankName || '-'}</td>
                            <td style="text-align: center;">${member.maritalStatus || 'أعزب'}</td>
                            <td style="text-align: center;">${remainingTime}</td>
                            <td style="text-align: center;">
                                <button class="btn btn-primary action-btn" onclick="showMemberDetails('${member.id}')" title="تفاصيل العضو">
                                    <i class="fas fa-eye"></i>
                                </button>
                                ${hasPermission('delete_member') ? `
                                    <button class="btn btn-danger action-btn" onclick="deleteMember('${member.id}')" title="حذف العضو">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                ` : ''}
                            </td>
                        </tr>
                    `;
                });

                html += '</tbody></table>';
            }

            container.innerHTML = html;

            // إعداد البحث بعد عرض الجدول
            setupMemberSearch();

            // تحديث الإحصائيات
            updateStats();
            
            // تحديث قوائم المستلمين لضمان ظهور الأسهم
            updateReceiverDropdowns();
        }

        function filterMembersByAssociation() {
            return members.filter(m => m.associationId === currentAssociation.id);
        }

        // دالة تحديث حالة الزواج تلقائياً
        function updateMaritalStatusAutomatically(member) {
            if (!member.marriageDate) {
                if (member.maritalStatus !== 'أعزب' && member.maritalStatus !== 'متزوج') {
                    member.maritalStatus = 'أعزب';
                }
                return;
            }

            const today = new Date();
            const weddingDate = new Date(member.marriageDate);
            const timeDiff = weddingDate.getTime() - today.getTime();
            const daysDiff = Math.ceil(timeDiff / (1000 * 3600 * 24));

            if (daysDiff < 0) {
                // تاريخ الزواج مضى، يصبح تزوج (إلا إذا كان متزوج سابقاً)
                if (member.maritalStatus !== 'تزوج' && member.maritalStatus !== 'متزوج') {
                    member.maritalStatus = 'تزوج';
                    saveMembers(); // حفظ التغيير
                    updateStats(); // تحديث الإحصائيات
                }
            } else {
                // تاريخ الزواج لم يحن بعد، يصبح تم تحديد الزواج (إلا إذا كان متزوج سابقاً)
                if (member.maritalStatus !== 'تم تحديد الزواج' && member.maritalStatus !== 'متزوج') {
                    member.maritalStatus = 'تم تحديد الزواج';
                    saveMembers(); // حفظ التغيير
                    updateStats(); // تحديث الإحصائيات
                }
            }
        }

        // دالة تحديث حالة الزواج في الساعة 10 مساءً
        function checkAndUpdateMaritalStatusAt10PM() {
            const now = new Date();
            const hour = now.getHours();
            
            // إذا كانت الساعة 10 مساءً (22:00)
            if (hour === 22) {
                const today = now.toISOString().split('T')[0]; // تاريخ اليوم بصيغة YYYY-MM-DD
                
                // البحث عن الأعضاء الذين تاريخ زواجهم اليوم وحالتهم "تم تحديد زواجهم"
                members.forEach(member => {
                    if (member.marriageDate === today && member.maritalStatus === 'تم تحديد الزواج') {
                        member.maritalStatus = 'متزوج';
                        console.log(`تم تحديث حالة العضو ${member.name} إلى متزوج`);
                    }
                });
                
                saveMembers();
                updateStats();
                
                // إذا كان المستخدم في صفحة الأعضاء، قم بتحديث العرض
                if (currentSection === 'members') {
                    displayMembers();
                }
            }
        }

        // تشغيل فحص تحديث حالة الزواج كل دقيقة
        setInterval(checkAndUpdateMaritalStatusAt10PM, 60000); // كل 60 ثانية

        function filterMembers(filter) {
            currentFilter = filter;

            // تحديث أزرار الفلتر
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');

            displayMembers();
        }

        function deleteMember(id) {
            if (!checkPermissionAndAlert('delete_member', 'ليس لديك صلاحية لحذف الأعضاء')) {
                return;
            }

            if (confirm('هل أنت متأكد من حذف هذا العضو؟')) {
                members = members.filter(member => member.id !== id);
                saveMembers();
                displayMembers();
                updateStats();
                showAlert('تم حذف العضو بنجاح!', 'success');
            }
        }

        // وظائف البنوك السعودية
        function getSaudiBanks() {
            return [
                'البنك الأهلي السعودي',
                'بنك الراجحي',
                'بنك الرياض',
                'البنك السعودي للاستثمار (SAIB)',
                'البنك السعودي الفرنسي',
                'البنك العربي الوطني',
                'بنك ساب (SABB)',
                'بنك الجزيرة',
                'بنك البلاد',
                'البنك الأول',
                'بنك الإنماء',
                'مصرف الإنماء',
                'البنك السعودي البريطاني (ساب سابقاً)',
                'بنك الخليج الدولي',
                'مصرف الراجحي',
                'بنك الاستثمار العربي السعودي',
                'البنك التجاري الكويتي - السعودية'
            ].sort();
        }

        // وظائف تحديث بيانات الأعضاء في المعاونات
        function updateMemberAmount(memberId, amount) {
            const member = members.find(m => m.id === memberId);
            if (member) {
                member.amount = parseFloat(amount) || 0;
                saveMembers();
                updateStats();

                // تحديث لون الصف حسب الملاحظات والمبلغ
                updateRowColor(memberId, member);
            }
        }

        function updateRowColor(memberId, member) {
            const row = document.getElementById(`member-row-${memberId}`);
            if (row) {
                const hasNotes = member.notes && member.notes.trim();
                const hasAmount = member.amount && parseFloat(member.amount) > 0;

                if (hasNotes) {
                    row.style.backgroundColor = '#ffeaea'; // أحمر خفيف للملاحظات
                } else if (hasAmount) {
                    row.style.backgroundColor = '#e8f5e8'; // أخضر خفيف للمساهمين
                } else {
                    row.style.backgroundColor = ''; // إزالة اللون
                }
            }
        }

        function updateMemberDisplayData(memberId, member) {
            const row = document.getElementById(`member-row-${memberId}`);
            if (row) {
                // تحديث الاسم والهاتف والملاحظات في العمود الثاني
                const nameCell = row.cells[1]; // العمود الثاني (الاسم)
                if (nameCell) {
                    const hasGeneralNotes = member.generalNotes && member.generalNotes.trim();
                    nameCell.innerHTML = `
                        <div><strong>${member.name}</strong></div>
                        <small style="color: #7f8c8d;">${member.phone || 'لا يوجد رقم'}</small>
                        ${hasGeneralNotes ? `<div style="font-size: 0.8rem; color: #dc3545; margin-top: 2px;"><i class="fas fa-sticky-note"></i> ${member.generalNotes}</div>` : ''}
                    `;
                }
            }
        }

        function updateMemberTransferType(memberId, transferType) {
            const member = members.find(m => m.id === memberId);
            if (member) {
                member.transferType = transferType;

                // إذا كان نقداً، نمسح البنك ونعطل القائمة
                if (transferType === 'نقداً') {
                    member.bank = '';
                    const bankSelect = document.querySelector(`#member-row-${memberId} select[onchange*="updateMemberBank"]`);
                    if (bankSelect) {
                        bankSelect.disabled = true;
                        bankSelect.value = '';
                    }
                } else {
                    // تفعيل قائمة البنوك
                    const bankSelect = document.querySelector(`#member-row-${memberId} select[onchange*="updateMemberBank"]`);
                    if (bankSelect) {
                        bankSelect.disabled = false;
                    }
                }

                saveMembers();
                updateCooperationStats(); // تحديث الإحصائيات فقط
            }
        }

        function updateMemberBank(memberId, bank) {
            const member = members.find(m => m.id === memberId);
            if (member) {
                member.bank = bank;
                saveMembers();
                updateCooperationStats(); // تحديث الإحصائيات فقط
            }
        }

        function updateMemberReceiver(memberId, receiver) {
            const member = members.find(m => m.id === memberId);
            if (member) {
                member.receiver = receiver;
                saveMembers();
                updateCooperationStats(); // تحديث الإحصائيات فقط
            }
        }

        // دالة تطبيق البيانات الجماعية
        function applyBulkData() {
            const amount = document.getElementById('bulkAmount').value;
            const transferType = document.getElementById('bulkTransferType').value;
            const bank = document.getElementById('bulkBank').value;
            const receiver = document.getElementById('bulkReceiver').value;

            if (!amount && !transferType && !bank && !receiver) {
                return; // لا تظهر تنبيه إذا كانت الحقول فارغة
            }

            const associationMembers = filterMembersByAssociation();
            let updatedCount = 0;
            let fieldName = '';

            associationMembers.forEach(member => {
                let updated = false;

                if (amount && amount.trim() !== '') {
                    member.amount = parseFloat(amount) || 0;
                    updated = true;
                    fieldName = 'المبلغ';
                    
                    // تحديث حقل المبلغ في الواجهة
                    const amountInput = document.querySelector(`#member-row-${member.id} input[type="number"]`);
                    if (amountInput) {
                        amountInput.value = member.amount;
                    }
                    
                    // تحديث لون الصف
                    updateRowColor(member.id, member);
                }

                if (transferType && transferType !== '') {
                    member.transferType = transferType;
                    updated = true;
                    fieldName = 'نوع التحويل';
                    
                    // تحديث قائمة نوع التحويل في الواجهة
                    const transferTypeSelect = document.querySelector(`#member-row-${member.id} select[onchange*="updateMemberTransferType"]`);
                    if (transferTypeSelect) {
                        transferTypeSelect.value = transferType;
                        
                        // إذا كان نقداً، تعطيل قائمة البنوك
                        if (transferType === 'نقداً') {
                            member.bank = '';
                            const bankSelect = document.querySelector(`#member-row-${member.id} select[onchange*="updateMemberBank"]`);
                            if (bankSelect) {
                                bankSelect.disabled = true;
                                bankSelect.value = '';
                            }
                        } else {
                            // تفعيل قائمة البنوك
                            const bankSelect = document.querySelector(`#member-row-${member.id} select[onchange*="updateMemberBank"]`);
                            if (bankSelect) {
                                bankSelect.disabled = false;
                            }
                        }
                    }
                }

                if (bank && bank !== '') {
                    member.bank = bank;
                    updated = true;
                    fieldName = 'البنك';
                    
                    // تحديث قائمة البنك في الواجهة
                    const bankSelect = document.querySelector(`#member-row-${member.id} select[onchange*="updateMemberBank"]`);
                    if (bankSelect && !bankSelect.disabled) {
                        bankSelect.value = bank;
                    }
                }

                if (receiver && receiver !== '') {
                    member.receiver = receiver;
                    updated = true;
                    fieldName = 'المستلم';
                    
                    // تحديث قائمة المستلم في الواجهة
                    const receiverSelect = document.querySelector(`#member-row-${member.id} select[onchange*="updateMemberReceiver"]`);
                    if (receiverSelect) {
                        receiverSelect.value = receiver;
                    }
                }

                if (updated) {
                    updatedCount++;
                }
            });

            if (updatedCount > 0) {
                saveMembers();
                updateStats();
                
                // تحديث قوائم المستلمين لضمان ظهور الأسهم
                updateReceiverDropdowns();

                // مسح الحقل الذي تم تطبيقه فقط
                if (amount) document.getElementById('bulkAmount').value = '';
                if (transferType) document.getElementById('bulkTransferType').value = '';
                if (bank) document.getElementById('bulkBank').value = '';
                if (receiver) document.getElementById('bulkReceiver').value = '';

                showAlert(`تم تطبيق ${fieldName} على ${updatedCount} عضو`, 'success');
            }
        }

        // دالة التعبئة التلقائية لعمود المبلغ فقط
        function applyBulkAmount() {
            const amount = document.getElementById('bulkAmount').value;
            
            if (!amount || amount.trim() === '') {
                return;
            }

            const associationMembers = filterMembersByAssociation();
            let updatedCount = 0;

            associationMembers.forEach(member => {
                member.amount = parseFloat(amount) || 0;
                
                // تحديث حقل المبلغ في الواجهة
                const amountInput = document.querySelector(`#member-row-${member.id} input[type="number"]`);
                if (amountInput) {
                    amountInput.value = member.amount;
                }
                
                // تحديث لون الصف
                updateRowColor(member.id, member);
                
                updatedCount++;
            });

            if (updatedCount > 0) {
                saveMembers();
                updateStats();
                
                // مسح حقل المبلغ
                document.getElementById('bulkAmount').value = '';

                showAlert(`تم تطبيق المبلغ ${parseFloat(amount).toLocaleString()} ريال على ${updatedCount} عضو`, 'success');
            }
        }

        function getReceiverOptions(selectedReceiver) {
            let options = '';

            // إضافة أمين السر وأمين الصندوق أولاً
            if (currentAssociation) {
                if (currentAssociation.secretary) {
                    options += `<option value="${currentAssociation.secretary}" ${selectedReceiver === currentAssociation.secretary ? 'selected' : ''}>${currentAssociation.secretary}</option>`;
                }
                if (currentAssociation.treasurer) {
                    options += `<option value="${currentAssociation.treasurer}" ${selectedReceiver === currentAssociation.treasurer ? 'selected' : ''}>${currentAssociation.treasurer}</option>`;
                }
                // إضافة الرئيس إذا كان موجوداً
                if (currentAssociation.president) {
                    options += `<option value="${currentAssociation.president}" ${selectedReceiver === currentAssociation.president ? 'selected' : ''}>${currentAssociation.president}</option>`;
                }
            }

            // إضافة العريس
            options += `<option value="العريس" ${selectedReceiver === 'العريس' ? 'selected' : ''}>العريس</option>`;
            
            // إضافة والد العريس
            options += `<option value="والد العريس" ${selectedReceiver === 'والد العريس' ? 'selected' : ''}>والد العريس</option>`;
            
            // إضافة خيار آخر
            options += `<option value="آخر" ${selectedReceiver === 'آخر' ? 'selected' : ''}>آخر</option>`;
            
            return options;
        }

        function getBankOptions(selectedBank) {
            // خيارات خاصة
            const specialOptions = ['جمعية', 'مناولة', 'أخرى'];
            let options = '';

            // إضافة الخيارات الخاصة
            specialOptions.forEach(option => {
                options += `<option value="${option}" ${selectedBank === option ? 'selected' : ''}>${option}</option>`;
            });

            // إضافة فاصل
            options += '<option disabled>──────────</option>';

            // إضافة البنوك السعودية
            const banks = getSaudiBanks();
            banks.forEach(bank => {
                options += `<option value="${bank}" ${selectedBank === bank ? 'selected' : ''}>${bank}</option>`;
            });

            return options;
        }

        function updateMemberFilters() {
            const filtersContainer = document.getElementById('memberFilters');

            if (currentAssociation && currentAssociation.type === 'cooperation') {
                // فلاتر المعاونات
                filtersContainer.innerHTML = `
                    <button class="filter-btn active" onclick="filterMembers('all')">الكل</button>
                    <button class="filter-btn" onclick="filterMembers('ساهم')">ساهم</button>
                    <button class="filter-btn" onclick="filterMembers('لم يساهم')">لم يساهم</button>
                `;
            } else {
                // فلاتر الجمعيات
                filtersContainer.innerHTML = `
                    <button class="filter-btn active" onclick="filterMembers('all')">الكل</button>
                    <button class="filter-btn" onclick="filterMembers('لم يتزوج')">لم يتزوج</button>
                    <button class="filter-btn" onclick="filterMembers('تم تحديد الزواج')">تم تحديد الزواج</button>
                    <button class="filter-btn" onclick="filterMembers('تزوج')">تزوج</button>
                    <button class="filter-btn" onclick="filterMembers('استلم')">استلم المبلغ</button>
                    <button class="filter-btn" onclick="filterMembers('لم يستلم')">لم يستلم المبلغ</button>
                `;
            }
        }

        function updateMemberListActions() {
            const actionsContainer = document.getElementById('memberListActions');
            
            // إضافة رسالة تشخيصية
            console.log('updateMemberListActions called:', {
                currentAssociation: currentAssociation,
                type: currentAssociation ? currentAssociation.type : 'no association'
            });

            if (currentAssociation && currentAssociation.type === 'cooperation') {
                // أزرار المعاونات - إضافة أزرار التسجيل والاستيراد الجماعي
                actionsContainer.innerHTML = `
                    <button class="btn" onclick="openModal('addCooperationMemberModal')">
                        <i class="fas fa-user-plus"></i> إضافة عضو معاونة
                    </button>
                    <button class="btn btn-success" onclick="openModal('bulkCooperationImportModal')">
                        <i class="fas fa-users"></i> استيراد جماعي
                    </button>
                `;
                console.log('Cooperation buttons added');
            } else if (currentAssociation && currentAssociation.type === 'association') {
                // أزرار الجمعيات - تعمل مباشرة بدون الانتقال لقسم آخر
                actionsContainer.innerHTML = `
                    <button class="btn" onclick="openSingleRegistration()">
                        <i class="fas fa-user-plus"></i> تسجيل عضو فردي
                    </button>
                    <button class="btn btn-success" onclick="openBulkRegistration()">
                        <i class="fas fa-users"></i> استيراد جماعي
                    </button>
                `;
                console.log('Association buttons added');
            } else {
                // لا توجد جمعية محددة
                actionsContainer.innerHTML = `
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle"></i>
                        <strong>تنبيه:</strong> يجب اختيار جمعية أو معاونة أولاً من قسم "الجمعيات" لإظهار أزرار إضافة الأعضاء.
                    </div>
                `;
                console.log('No association selected - warning message shown');
            }
        }

        // وظيفة تحديث الإحصائيات فقط للمعاونات
        function updateCooperationStats() {
            if (!currentAssociation || currentAssociation.type !== 'cooperation') return;

            const allMembers = filterMembersByAssociation();
            const totalMembers = allMembers.length;
            const contributors = allMembers.filter(m => m.amount && parseFloat(m.amount) > 0).length;
            const nonContributors = totalMembers - contributors;
            const totalAmount = allMembers.reduce((sum, m) => sum + (parseFloat(m.amount) || 0), 0);

            // إحصائيات المسؤولين
            const receiverStats = {};
            const bankStats = {};

            allMembers.forEach(member => {
                if (member.amount && parseFloat(member.amount) > 0) {
                    // إحصائيات المستلمين
                    const receiver = member.receiver || 'غير محدد';
                    receiverStats[receiver] = (receiverStats[receiver] || 0) + parseFloat(member.amount);

                    // إحصائيات البنوك/الوجهات
                    if (member.transferType !== 'نقداً' && member.bank) {
                        bankStats[member.bank] = (bankStats[member.bank] || 0) + parseFloat(member.amount);
                    }
                }
            });

            // تحديث الإحصائيات في الصفحة
            const statsGrid = document.querySelector('.stats-grid');
            if (statsGrid) {
                let html = `
                    <div class="stat-card">
                        <div class="stat-number">${totalMembers}</div>
                        <div class="stat-label">إجمالي الأعضاء</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${contributors}</div>
                        <div class="stat-label">المساهمون</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${nonContributors}</div>
                        <div class="stat-label">غير المساهمين</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${totalAmount.toLocaleString()}</div>
                        <div class="stat-label">المبلغ الإجمالي (ريال)</div>
                    </div>
                `;

                // إحصائيات المسؤولين
                Object.keys(receiverStats).forEach(receiver => {
                    if (receiver !== 'غير محدد') {
                        html += `
                            <div class="stat-card">
                                <div class="stat-number">${receiverStats[receiver].toLocaleString()}</div>
                                <div class="stat-label">${receiver}</div>
                            </div>
                        `;
                    }
                });

                // إحصائيات البنوك/الوجهات
                Object.keys(bankStats).forEach(bank => {
                    html += `
                        <div class="stat-card">
                            <div class="stat-number">${bankStats[bank].toLocaleString()}</div>
                            <div class="stat-label">${bank}</div>
                        </div>
                    `;
                });

                statsGrid.innerHTML = html;
            }
        }

        // وظائف ترتيب الأعضاء
        function moveMemberUp(memberId) {
            const associationMembers = filterMembersByAssociation();

            // إعادة ترقيم الترتيب إذا لم يكن موجوداً
            associationMembers.forEach((member, index) => {
                if (member.order === undefined || member.order === null) {
                    member.order = index;
                }
            });

            // ترتيب الأعضاء حسب الترتيب الحالي
            associationMembers.sort((a, b) => a.order - b.order);
            const memberIndex = associationMembers.findIndex(m => m.id === memberId);

            if (memberIndex > 0) {
                // تبديل الترتيب مع العضو الذي قبله
                const currentMember = associationMembers[memberIndex];
                const previousMember = associationMembers[memberIndex - 1];

                const tempOrder = currentMember.order;
                currentMember.order = previousMember.order;
                previousMember.order = tempOrder;

                saveMembers();
                displayMembers();
                showAlert('تم تحريك العضو للأعلى', 'success');
            }
        }

        function moveMemberDown(memberId) {
            const associationMembers = filterMembersByAssociation();

            // إعادة ترقيم الترتيب إذا لم يكن موجوداً
            associationMembers.forEach((member, index) => {
                if (member.order === undefined || member.order === null) {
                    member.order = index;
                }
            });

            // ترتيب الأعضاء حسب الترتيب الحالي
            associationMembers.sort((a, b) => a.order - b.order);
            const memberIndex = associationMembers.findIndex(m => m.id === memberId);

            if (memberIndex < associationMembers.length - 1) {
                // تبديل الترتيب مع العضو الذي بعده
                const currentMember = associationMembers[memberIndex];
                const nextMember = associationMembers[memberIndex + 1];

                const tempOrder = currentMember.order;
                currentMember.order = nextMember.order;
                nextMember.order = tempOrder;

                saveMembers();
                displayMembers();
                showAlert('تم تحريك العضو للأسفل', 'success');
            }
        }

        // وظائف البحث المحسنة
        let searchTimeout;
        function setupMemberSearch() {
            const memberSearch = document.getElementById('memberSearch');
            if (memberSearch) {
                // إزالة المستمعين السابقين لتجنب التكرار
                memberSearch.removeEventListener('input', memberSearchHandler);
                memberSearch.addEventListener('input', memberSearchHandler);
            }
        }

        function memberSearchHandler(e) {
            // إلغاء البحث السابق لتجنب التأخير
            clearTimeout(searchTimeout);

            searchTimeout = setTimeout(() => {
                const searchTerm = e.target.value.toLowerCase().trim();
                const rows = document.querySelectorAll('#membersTable tbody tr, #membersTable tr:not(:first-child)');

                rows.forEach(row => {
                    const text = row.textContent.toLowerCase();
                    row.style.display = text.includes(searchTerm) ? '' : 'none';
                });
            }, 300); // تأخير 300ms لتجنب البحث المستمر
        }

        // وظائف التحصيل المالي الجديدة
        let currentCollectionMember = null;

        function updateCollectionSection() {
            if (!currentAssociation) {
                document.getElementById('noCollectionAssociationAlert').style.display = 'block';
                document.getElementById('collectionContent').style.display = 'none';
                return;
            }

            document.getElementById('noCollectionAssociationAlert').style.display = 'none';
            document.getElementById('collectionContent').style.display = 'block';

            if (currentAssociation.type === 'cooperation') {
                // للمعاونات - عرض رسالة توضيحية
                document.getElementById('scheduledMembersSection').innerHTML = `
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i>
                        <strong>ملاحظة:</strong> التحصيل المالي متاح للجمعيات فقط. المعاونات لها نظام مساهمات منفصل في قائمة الأعضاء.
                    </div>
                `;
                document.getElementById('collectionTableSection').style.display = 'none';
            } else {
                // للجمعيات - عرض الأعضاء المقرر زواجهم
                displayScheduledMembers();
            }
        }

        function displayScheduledMembers() {
            const associationMembers = filterMembersByAssociation();
            // تشمل الأعضاء المقرر زواجهم والمتزوجين أو الذين لديهم تحصيل
            const eligibleMembers = associationMembers.filter(m => {
                const marriageData = getMarriageDataFromCollection(m.id);
                return marriageData.maritalStatus === 'تم تحديد الزواج' ||
                       marriageData.maritalStatus === 'متزوج' ||
                       marriageData.maritalStatus === 'تزوج' ||
                       marriageData.hasCollection;
            });

            const container = document.getElementById('scheduledMembersCards');

            if (eligibleMembers.length === 0) {
                container.innerHTML = `
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle"></i>
                        <strong>لا توجد أعضاء مقرر زواجهم أو متزوجين حالياً</strong><br>
                        يمكنك تحديد موعد الزواج من تفاصيل العضو في قائمة الأعضاء.
                    </div>
                `;
                return;
            }

            let html = '<div class="scheduled-members-grid">';

            eligibleMembers.forEach(member => {
                // سحب البيانات من جدول التحصيل
                const marriageData = getMarriageDataFromCollection(member.id);
                let remainingDays = '';
                let marriageDate = marriageData.marriageDate || '';

                if (marriageDate) {
                    const today = new Date();
                    const weddingDate = new Date(marriageDate);
                    const timeDiff = weddingDate.getTime() - today.getTime();
                    const diffDays = Math.ceil(timeDiff / (1000 * 3600 * 24));

                    if (diffDays > 0) {
                        remainingDays = `${diffDays} يوم`;
                    } else if (diffDays === 0) {
                        remainingDays = 'اليوم';
                    } else {
                        remainingDays = 'انتهى';
                    }

                    // تحويل التاريخ للعرض
                    marriageDate = new Date(marriageDate).toLocaleDateString('ar-SA');
                }

                // حساب إجمالي التحصيل للعضو
                const totalCollected = getTotalCollectionForBeneficiary(member.id);
                const fixedAmount = currentAssociation.amount || 0;
                const remaining = fixedAmount - totalCollected;
                const associationMembers = filterMembersByAssociation();

                // تحديد نوع الكارت حسب حالة الزواج والإقفال (من بيانات التحصيل)
                const isMarried = marriageData.maritalStatus === 'متزوج' || marriageData.maritalStatus === 'تزوج';
                const isLocked = member.collectionLocked === true;

                let cardClass, iconClass, statusText;
                if (isLocked) {
                    cardClass = 'locked-member-card';
                    iconClass = 'fas fa-lock';
                    statusText = '(مقفل)';
                } else if (isMarried) {
                    cardClass = 'married-member-card';
                    iconClass = 'fas fa-check-circle';
                    statusText = marriageData.maritalStatus === 'متزوج' ? '(متزوج سابقاً)' : '(تزوج)';
                } else {
                    cardClass = 'scheduled-member-card';
                    iconClass = 'fas fa-heart';
                    statusText = '';
                }

                html += `
                    <div class="${cardClass}" onclick="showMemberCollection('${member.id}')">
                        <div class="member-card-header">
                            <div class="member-card-icon">
                                <i class="${iconClass}"></i>
                            </div>
                            <h4 class="member-card-name">${member.name} ${statusText}</h4>
                        </div>

                        <div class="member-card-details">
                            ${isMarried ? `
                                <div class="member-card-detail">
                                    <i class="fas fa-calendar"></i>
                                    <span>${marriageDate}</span>
                                </div>
                                <div class="member-card-detail">
                                    <i class="fas fa-users"></i>
                                    <span>مبلغ الجمعية: ${(fixedAmount * associationMembers.length).toLocaleString()} ريال</span>
                                </div>
                                <div class="member-card-detail">
                                    <i class="fas fa-hand-holding-usd"
                                       style="color: ${getGroomReceiptAmount(member.id) > 0 ? '#27ae60' : '#e74c3c'}; cursor: help;"
                                       title="استلم العريس: ${getGroomReceiptAmount(member.id).toLocaleString()} ريال"></i>
                                    <span style="color: ${getGroomReceiptAmount(member.id) > 0 ? '#27ae60' : '#e74c3c'};">
                                        ${getGroomReceiptAmount(member.id).toLocaleString()} ريال
                                    </span>
                                </div>
                                <div class="member-card-detail">
                                    <i class="fas fa-sticky-note"></i>
                                    <span>الملاحظات: ${getCollectionNotesCount(member.id)}</span>
                                </div>
                                <div class="member-card-detail">
                                    <i class="fas fa-user-tie"></i>
                                    <span>مسؤول الجمعية: ${getOfficialReceiverName(member.id)}</span>
                                </div>
                            ` : `
                                <div class="member-card-detail">
                                    <i class="fas fa-calendar"></i>
                                    <span>${marriageDate}</span>
                                </div>
                                <div class="member-card-detail">
                                    <i class="fas fa-clock"></i>
                                    <span>${remainingDays}</span>
                                </div>
                                <div class="member-card-detail">
                                    <i class="fas fa-money-bill"></i>
                                    <span>${fixedAmount.toLocaleString()} ريال</span>
                                </div>
                                <div class="member-card-detail">
                                    <i class="fas fa-check-circle"></i>
                                    <span style="color: ${remaining <= 0 ? '#27ae60' : '#e74c3c'};">
                                        ${remaining <= 0 ? 'مكتمل' : `متبقي: ${remaining.toLocaleString()}`}
                                    </span>
                                </div>
                            `}
                        </div>
                    </div>
                `;
            });

            html += '</div>';
            container.innerHTML = html;
        }

        function showMemberCollection(memberId) {
            const member = members.find(m => m.id === memberId);
            if (!member) return;

            currentCollectionMember = member;

            // إخفاء قسم الكروت وإظهار جدول التحصيل
            document.getElementById('scheduledMembersSection').style.display = 'none';
            document.getElementById('collectionTableSection').style.display = 'block';

            // تحديث عنوان الجدول
            const lockStatus = member.collectionLocked ? ' (مقفل)' : '';
            document.getElementById('collectionMemberName').textContent = `تحصيل مالي للعضو: ${member.name}${lockStatus}`;

            // عرض جدول التحصيل
            displayMemberCollectionTable(memberId);
        }

        function closeCollectionTable() {
            document.getElementById('scheduledMembersSection').style.display = 'block';
            document.getElementById('collectionTableSection').style.display = 'none';
            currentCollectionMember = null;
        }

        function displayMemberCollectionTable(memberId) {
            const container = document.getElementById('memberCollectionTable');
            const associationMembers = filterMembersByAssociation();

            if (associationMembers.length === 0) {
                container.innerHTML = `
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i>
                        <strong>لا توجد أعضاء في هذه الجمعية</strong>
                    </div>
                `;
                return;
            }

            // حساب الإحصائيات
            const totalMembers = associationMembers.length;
            const contributingMembers = associationMembers.filter(m => {
                const collectionData = getCollectionDataForMember(m.id, memberId);
                return collectionData.amount > 0;
            }).length;
            const totalAmount = associationMembers.reduce((sum, m) => {
                const collectionData = getCollectionDataForMember(m.id, memberId);
                return sum + (parseFloat(collectionData.amount) || 0);
            }, 0);

            // حساب إحصائيات نوع التحويل
            const cashCount = associationMembers.filter(m => {
                const collectionData = getCollectionDataForMember(m.id, memberId);
                return collectionData.transferType === 'نقداً' && collectionData.amount > 0;
            }).length;

            const bankTransferCount = associationMembers.filter(m => {
                const collectionData = getCollectionDataForMember(m.id, memberId);
                return collectionData.transferType === 'تحويل بنكي' && collectionData.amount > 0;
            }).length;

            const waselCount = associationMembers.filter(m => {
                const collectionData = getCollectionDataForMember(m.id, memberId);
                return collectionData.transferType === 'واصل' && collectionData.amount > 0;
            }).length;

            // حساب إحصائيات البنوك
            const bankStats = {};
            associationMembers.forEach(m => {
                const collectionData = getCollectionDataForMember(m.id, memberId);
                if (collectionData.bank && collectionData.amount > 0) {
                    bankStats[collectionData.bank] = (bankStats[collectionData.bank] || 0) + parseFloat(collectionData.amount);
                }
            });

            // حساب إحصائيات المستلمين
            const receiverStats = {};
            associationMembers.forEach(m => {
                const collectionData = getCollectionDataForMember(m.id, memberId);
                if (collectionData.receiver && collectionData.amount > 0) {
                    receiverStats[collectionData.receiver] = (receiverStats[collectionData.receiver] || 0) + parseFloat(collectionData.amount);
                }
            });

            // عرض الإحصائيات الأساسية
            let statsHtml = `
                <div class="stat-card">
                    <div class="stat-number">${totalMembers}</div>
                    <div class="stat-label">إجمالي الأعضاء</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${contributingMembers}</div>
                    <div class="stat-label">المساهمين</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${totalAmount.toLocaleString()}</div>
                    <div class="stat-label">إجمالي المبالغ (ريال)</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${totalMembers - contributingMembers}</div>
                    <div class="stat-label">لم يساهموا</div>
                </div>
            `;

            // إضافة إحصائيات نوع التحويل
            if (cashCount > 0) {
                statsHtml += `
                    <div class="stat-card">
                        <div class="stat-number">${cashCount}</div>
                        <div class="stat-label">نقداً</div>
                    </div>
                `;
            }
            if (bankTransferCount > 0) {
                statsHtml += `
                    <div class="stat-card">
                        <div class="stat-number">${bankTransferCount}</div>
                        <div class="stat-label">تحويل بنكي</div>
                    </div>
                `;
            }
            if (waselCount > 0) {
                statsHtml += `
                    <div class="stat-card">
                        <div class="stat-number">${waselCount}</div>
                        <div class="stat-label">واصل</div>
                    </div>
                `;
            }

            // إضافة إحصائيات البنوك
            Object.entries(bankStats).forEach(([bank, amount]) => {
                statsHtml += `
                    <div class="stat-card">
                        <div class="stat-number">${amount.toLocaleString()}</div>
                        <div class="stat-label">${bank}</div>
                    </div>
                `;
            });

            // إضافة إحصائيات المستلمين
            Object.entries(receiverStats).forEach(([receiver, amount]) => {
                statsHtml += `
                    <div class="stat-card">
                        <div class="stat-number">${amount.toLocaleString()}</div>
                        <div class="stat-label">${receiver}</div>
                    </div>
                `;
            });

            document.getElementById('collectionStats').innerHTML = statsHtml;

            let html = `
                <table class="table">
                    <thead>
                        <tr style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; height: 50px;">
                            <th style="width: 6%; text-align: center; padding: 8px;">م</th>
                            <th style="width: 20%; text-align: center; padding: 8px;">اسم العضو</th>
                            <th style="width: 12%; padding: 4px; text-align: center;">
                                <div style="margin-bottom: 4px;">المبلغ</div>
                                <input type="number"
                                       id="bulkAmount_${memberId}"
                                       placeholder="تعبئة جماعية"
                                       min="0"
                                       step="0.01"
                                       style="width: 100%; padding: 2px; border: 1px solid rgba(255,255,255,0.3); border-radius: 3px; font-size: 0.7rem; background: rgba(255,255,255,0.1); color: white;"
                                       onchange="applyBulkAmountToBeneficiary('${memberId}', this.value)">
                            </th>
                            <th style="width: 12%; padding: 4px; text-align: center;">
                                <div style="margin-bottom: 4px;">نوع التحويل</div>
                                <select id="bulkTransferType_${memberId}"
                                        style="width: 100%; padding: 2px; border: 1px solid rgba(255,255,255,0.3); border-radius: 3px; font-size: 0.7rem; background: rgba(255,255,255,0.1); color: #333;"
                                        onchange="applyBulkTransferType('${memberId}', this.value)">
                                    <option value="">اختر</option>
                                    <option value="نقداً">نقداً</option>
                                    <option value="تحويل بنكي">تحويل بنكي</option>
                                    <option value="واصل">واصل</option>
                                    <option value="أخرى">أخرى</option>
                                </select>
                            </th>
                            <th style="width: 12%; padding: 4px; text-align: center;">
                                <div style="margin-bottom: 4px;">البنك</div>
                                <select id="bulkBank_${memberId}"
                                        style="width: 100%; padding: 2px; border: 1px solid rgba(255,255,255,0.3); border-radius: 3px; font-size: 0.7rem; background: rgba(255,255,255,0.1); color: #333;"
                                        onchange="applyBulkBank('${memberId}', this.value)">
                                    <option value="">اختر</option>
                                    <option value="الراجحي">الراجحي</option>
                                    <option value="الأهلي">الأهلي</option>
                                    <option value="سامبا">سامبا</option>
                                    <option value="الرياض">الرياض</option>
                                    <option value="البلاد">البلاد</option>
                                    <option value="الإنماء">الإنماء</option>
                                    <option value="الجزيرة">الجزيرة</option>
                                    <option value="العربي">العربي</option>
                                    <option value="الاستثمار">الاستثمار</option>
                                    <option value="فرنسي">فرنسي</option>
                                    <option value="أخرى">أخرى</option>
                                </select>
                            </th>
                            <th style="width: 12%; padding: 4px; text-align: center;">
                                <div style="margin-bottom: 4px;">المستلم</div>
                                <select id="bulkReceiver_${memberId}"
                                        style="width: 100%; padding: 2px; border: 1px solid rgba(255,255,255,0.3); border-radius: 3px; font-size: 0.7rem; background: rgba(255,255,255,0.1); color: #333;"
                                        onchange="applyBulkReceiver('${memberId}', this.value)">
                                    <option value="">اختر</option>
                                    ${currentAssociation ?
                                        [
                                            currentAssociation.president && currentAssociation.president.trim() !== '' ? `<option value="${currentAssociation.president}">${currentAssociation.president}</option>` : '',
                                            currentAssociation.secretary && currentAssociation.secretary.trim() !== '' ? `<option value="${currentAssociation.secretary}">${currentAssociation.secretary}</option>` : '',
                                            currentAssociation.treasurer && currentAssociation.treasurer.trim() !== '' ? `<option value="${currentAssociation.treasurer}">${currentAssociation.treasurer}</option>` : ''
                                        ].filter(option => option !== '').join('') : ''
                                    }
                                    <option value="العريس">العريس</option>
                                    <option value="والد العريس">والد العريس</option>
                                    <option value="آخر">آخر</option>
                                </select>
                            </th>
                            <th style="width: 26%; text-align: center; padding: 8px;">إجراءات</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            // ترتيب الأعضاء: الذين لديهم ملاحظات في الأسفل
            const sortedMembers = [...associationMembers].sort((a, b) => {
                const aCollectionData = getCollectionDataForMember(a.id, memberId);
                const bCollectionData = getCollectionDataForMember(b.id, memberId);

                const aHasNotes = (aCollectionData.notes && aCollectionData.notes.trim() !== '') ||
                                 (a.generalNotes && a.generalNotes.trim() !== '') ||
                                 (a.notes && a.notes.trim() !== '');
                const bHasNotes = (bCollectionData.notes && bCollectionData.notes.trim() !== '') ||
                                 (b.generalNotes && b.generalNotes.trim() !== '') ||
                                 (b.notes && b.notes.trim() !== '');

                if (aHasNotes && !bHasNotes) return 1;  // a للأسفل
                if (!aHasNotes && bHasNotes) return -1; // b للأسفل

                return 0; // نفس الترتيب
            });

            sortedMembers.forEach((member, index) => {
                // الحصول على بيانات التحصيل للعضو من العضو المقرر زواجه
                const collectionData = getCollectionDataForMember(member.id, memberId);

                // تحديد ما إذا كان التحصيل مقفل من قبل المدير
                const beneficiaryMember = members.find(m => m.id === memberId);
                const isLocked = beneficiaryMember && beneficiaryMember.collectionLocked === true;
                const disabledAttr = isLocked ? 'disabled' : '';
                const lockedStyle = isLocked ? 'opacity: 0.6; background-color: #f8f9fa;' : '';

                // تحديد لون الصف
                let rowStyle = '';

                // فحص جميع أنواع الملاحظات
                const collectionNotes = collectionData.notes || '';
                const generalNotes = member.generalNotes || '';
                const memberNotes = member.notes || '';
                const hasAnyNotes = collectionNotes.trim() !== '' || generalNotes.trim() !== '' || memberNotes.trim() !== '';

                if (hasAnyNotes) {
                    rowStyle = 'background-color: #ffe6e6;'; // أحمر للملاحظات
                } else if (collectionData.amount > 0) {
                    rowStyle = 'background-color: #e8f5e8;'; // أخضر للمساهمين
                }

                // تجميع جميع الملاحظات للعرض
                let allNotes = [];
                if (collectionNotes.trim() !== '') allNotes.push(`تحصيل: ${collectionNotes}`);
                if (generalNotes.trim() !== '') allNotes.push(`عامة: ${generalNotes}`);
                if (memberNotes.trim() !== '') allNotes.push(`عضو: ${memberNotes}`);

                html += `
                    <tr id="collectionRow_${member.id}" ${rowStyle ? `style="${rowStyle}"` : ''}>
                        <td style="text-align: center;"><strong>${index + 1}</strong></td>
                        <td style="font-weight: bold;">
                            ${member.name}
                            ${allNotes.length > 0 ? `<br><small style="color: #dc3545; font-style: italic;"><i class="fas fa-sticky-note"></i> ${allNotes.join(' | ')}</small>` : ''}
                        </td>
                        <td style="text-align: center;">
                            <input type="number"
                                   id="amount_${member.id}"
                                   value="${collectionData.amount || ''}"
                                   min="0"
                                   step="0.01"
                                   style="width: 100px; text-align: center; ${lockedStyle}"
                                   ${disabledAttr}
                                   onchange="updateCollectionData('${member.id}', '${memberId}', 'amount', this.value)">
                        </td>
                        <td style="text-align: center;">
                            <select id="transferType_${member.id}"
                                    onchange="updateCollectionData('${member.id}', '${memberId}', 'transferType', this.value)"
                                    style="width: 100%; ${lockedStyle}"
                                    ${disabledAttr}>
                                <option value="">اختر</option>
                                <option value="نقداً" ${collectionData.transferType === 'نقداً' ? 'selected' : ''}>نقداً</option>
                                <option value="تحويل بنكي" ${collectionData.transferType === 'تحويل بنكي' ? 'selected' : ''}>تحويل بنكي</option>
                                <option value="واصل" ${collectionData.transferType === 'واصل' ? 'selected' : ''}>واصل</option>
                            </select>
                        </td>
                        <td style="text-align: center;">
                            <select id="bank_${member.id}"
                                    onchange="updateCollectionData('${member.id}', '${memberId}', 'bank', this.value)"
                                    style="width: 100%; ${lockedStyle}"
                                    ${disabledAttr}>
                                <option value="">اختر البنك</option>
                                <option value="الراجحي" ${collectionData.bank === 'الراجحي' ? 'selected' : ''}>الراجحي</option>
                                <option value="الأهلي" ${collectionData.bank === 'الأهلي' ? 'selected' : ''}>الأهلي</option>
                                <option value="سامبا" ${collectionData.bank === 'سامبا' ? 'selected' : ''}>سامبا</option>
                                <option value="الرياض" ${collectionData.bank === 'الرياض' ? 'selected' : ''}>الرياض</option>
                                <option value="البلاد" ${collectionData.bank === 'البلاد' ? 'selected' : ''}>البلاد</option>
                                <option value="الجزيرة" ${collectionData.bank === 'الجزيرة' ? 'selected' : ''}>الجزيرة</option>
                                <option value="الإنماء" ${collectionData.bank === 'الإنماء' ? 'selected' : ''}>الإنماء</option>
                                <option value="ساب" ${collectionData.bank === 'ساب' ? 'selected' : ''}>ساب</option>
                                <option value="العربي" ${collectionData.bank === 'العربي' ? 'selected' : ''}>العربي</option>
                                <option value="الفرنسي" ${collectionData.bank === 'الفرنسي' ? 'selected' : ''}>الفرنسي</option>
                            </select>
                        </td>
                        <td style="text-align: center;">
                            <select id="receiver_${member.id}"
                                    onchange="updateCollectionData('${member.id}', '${memberId}', 'receiver', this.value)"
                                    style="width: 100%; ${lockedStyle}"
                                    ${disabledAttr}>
                                <option value="">اختر المستلم</option>
                                ${getReceiverOptions(collectionData.receiver)}
                            </select>
                        </td>
                        <td style="text-align: center;">
                            <!-- أزرار التحريك -->
                            <button class="btn btn-secondary action-btn"
                                    onclick="moveCollectionMember('${member.id}', 'up')"
                                    title="تحريك لأعلى"
                                    style="font-size: 12px; padding: 5px 8px; margin: 1px;">
                                <i class="fas fa-arrow-up"></i>
                            </button>
                            <button class="btn btn-secondary action-btn"
                                    onclick="moveCollectionMember('${member.id}', 'down')"
                                    title="تحريك لأسفل"
                                    style="font-size: 12px; padding: 5px 8px; margin: 1px;">
                                <i class="fas fa-arrow-down"></i>
                            </button>

                            <!-- زر الملاحظات -->
                            <button class="btn btn-info action-btn"
                                    onclick="showMemberNotes('${member.id}')"
                                    title="ملاحظات العضو"
                                    style="font-size: 12px; padding: 5px 8px; margin: 1px;">
                                <i class="fas fa-sticky-note"></i>
                            </button>

                            <!-- زر مسح البيانات -->
                            <button class="btn btn-warning action-btn"
                                    onclick="clearCollectionData('${member.id}', '${memberId}')"
                                    title="${isLocked ? 'مقفل من المدير' : 'مسح البيانات'}"
                                    style="font-size: 12px; padding: 5px 8px; margin: 1px; ${lockedStyle}"
                                    ${disabledAttr}>
                                <i class="fas fa-${isLocked ? 'lock' : 'eraser'}"></i>
                            </button>

                            <!-- زر الإقفال (للمدير العام فقط) -->
                            <button class="btn ${member.isLocked ? 'btn-info' : 'btn-secondary'} action-btn"
                                    onclick="toggleMemberLock('${member.id}')"
                                    title="${member.isLocked ? 'إلغاء إقفال العضو (المدير فقط)' : 'إقفال العضو (المدير فقط)'}"
                                    style="font-size: 12px; padding: 5px 8px; margin: 1px;">
                                <i class="fas fa-${member.isLocked ? 'unlock' : 'user-lock'}"></i>
                            </button>
                        </td>
                    </tr>
                `;
            });

            html += `
                    </tbody>
                </table>
            `;

            container.innerHTML = html;
        }

        // دوال إدارة بيانات التحصيل الجديدة
        function getCollectionDataForMember(contributorId, beneficiaryId) {
            const collections = JSON.parse(localStorage.getItem('associationCollections') || '[]');
            const collection = collections.find(c =>
                c.contributorId === contributorId &&
                c.beneficiaryId === beneficiaryId &&
                c.associationId === currentAssociation.id
            );

            // إرجاع نسخة جديدة من البيانات لتجنب المشاركة
            return collection ? {
                amount: collection.amount || 0,
                transferType: collection.transferType || '',
                bank: collection.bank || '',
                receiver: collection.receiver || '',
                notes: collection.notes || '',
                date: collection.date || new Date().toISOString()
            } : {
                amount: 0,
                transferType: '',
                bank: '',
                receiver: '',
                notes: '',
                date: new Date().toISOString()
            };
        }

        function updateCollectionData(contributorId, beneficiaryId, field, value) {
            // التحقق من أن التحصيل غير مقفل من قبل المدير
            const beneficiaryMember = members.find(m => m.id === beneficiaryId);
            if (beneficiaryMember && beneficiaryMember.collectionLocked === true) {
                showAlert('لا يمكن تعديل بيانات التحصيل - مقفل من قبل المدير العام', 'error');
                return;
            }

            const collections = JSON.parse(localStorage.getItem('associationCollections') || '[]');
            let collection = collections.find(c =>
                c.contributorId === contributorId &&
                c.beneficiaryId === beneficiaryId &&
                c.associationId === currentAssociation.id
            );

            if (!collection) {
                // إنشاء معرف فريد لضمان عدم التداخل
                const uniqueId = `${contributorId}-${beneficiaryId}-${currentAssociation.id}-${Date.now()}`;
                collection = {
                    id: uniqueId,
                    contributorId: contributorId,
                    beneficiaryId: beneficiaryId,
                    associationId: currentAssociation.id,
                    amount: 0,
                    transferType: '',
                    bank: '',
                    receiver: '',
                    notes: '',
                    createdAt: new Date().toISOString()
                };
                collections.push(collection);
            }

            collection[field] = value;
            collection.updatedAt = new Date().toISOString();

            localStorage.setItem('associationCollections', JSON.stringify(collections));

            // تحديث لون الصف
            const row = document.getElementById(`collectionRow_${contributorId}`);
            if (row) {
                const amount = parseFloat(document.getElementById(`amount_${contributorId}`).value) || 0;
                if (amount > 0) {
                    row.style.backgroundColor = '#e8f5e8';
                } else {
                    row.style.backgroundColor = '';
                }
            }

            // تحديث الإحصائيات مباشرة
            updateCollectionStats(beneficiaryId);

            // تحديث الكروت
            displayScheduledMembers();
        }

        // دالة تحديث الإحصائيات مباشرة
        function updateCollectionStats(beneficiaryId) {
            const associationMembers = filterMembersByAssociation();

            // حساب الإحصائيات
            const totalMembers = associationMembers.length;
            const contributingMembers = associationMembers.filter(m => {
                const collectionData = getCollectionDataForMember(m.id, beneficiaryId);
                return collectionData.amount > 0;
            }).length;
            const totalAmount = associationMembers.reduce((sum, m) => {
                const collectionData = getCollectionDataForMember(m.id, beneficiaryId);
                return sum + (parseFloat(collectionData.amount) || 0);
            }, 0);

            // حساب إحصائيات نوع التحويل
            const cashCount = associationMembers.filter(m => {
                const collectionData = getCollectionDataForMember(m.id, beneficiaryId);
                return collectionData.transferType === 'نقداً' && collectionData.amount > 0;
            }).length;

            const bankTransferCount = associationMembers.filter(m => {
                const collectionData = getCollectionDataForMember(m.id, beneficiaryId);
                return collectionData.transferType === 'تحويل بنكي' && collectionData.amount > 0;
            }).length;

            const waselCount = associationMembers.filter(m => {
                const collectionData = getCollectionDataForMember(m.id, beneficiaryId);
                return collectionData.transferType === 'واصل' && collectionData.amount > 0;
            }).length;

            // حساب إحصائيات البنوك
            const bankStats = {};
            associationMembers.forEach(m => {
                const collectionData = getCollectionDataForMember(m.id, beneficiaryId);
                if (collectionData.bank && collectionData.amount > 0) {
                    bankStats[collectionData.bank] = (bankStats[collectionData.bank] || 0) + parseFloat(collectionData.amount);
                }
            });

            // حساب إحصائيات المستلمين
            const receiverStats = {};
            associationMembers.forEach(m => {
                const collectionData = getCollectionDataForMember(m.id, beneficiaryId);
                if (collectionData.receiver && collectionData.amount > 0) {
                    receiverStats[collectionData.receiver] = (receiverStats[collectionData.receiver] || 0) + parseFloat(collectionData.amount);
                }
            });

            // تحديث عرض الإحصائيات
            let statsHtml = `
                <div class="stat-card">
                    <div class="stat-number">${totalMembers}</div>
                    <div class="stat-label">إجمالي الأعضاء</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${contributingMembers}</div>
                    <div class="stat-label">المساهمين</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${totalAmount.toLocaleString()}</div>
                    <div class="stat-label">إجمالي المبالغ (ريال)</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${totalMembers - contributingMembers}</div>
                    <div class="stat-label">لم يساهموا</div>
                </div>
            `;

            // إضافة إحصائيات نوع التحويل
            if (cashCount > 0) {
                statsHtml += `
                    <div class="stat-card">
                        <div class="stat-number">${cashCount}</div>
                        <div class="stat-label">نقداً</div>
                    </div>
                `;
            }
            if (bankTransferCount > 0) {
                statsHtml += `
                    <div class="stat-card">
                        <div class="stat-number">${bankTransferCount}</div>
                        <div class="stat-label">تحويل بنكي</div>
                    </div>
                `;
            }
            if (waselCount > 0) {
                statsHtml += `
                    <div class="stat-card">
                        <div class="stat-number">${waselCount}</div>
                        <div class="stat-label">واصل</div>
                    </div>
                `;
            }

            // إضافة إحصائيات البنوك
            Object.entries(bankStats).forEach(([bank, amount]) => {
                statsHtml += `
                    <div class="stat-card">
                        <div class="stat-number">${amount.toLocaleString()}</div>
                        <div class="stat-label">${bank}</div>
                    </div>
                `;
            });

            // إضافة إحصائيات المستلمين
            Object.entries(receiverStats).forEach(([receiver, amount]) => {
                statsHtml += `
                    <div class="stat-card">
                        <div class="stat-number">${amount.toLocaleString()}</div>
                        <div class="stat-label">${receiver}</div>
                    </div>
                `;
            });

            document.getElementById('collectionStats').innerHTML = statsHtml;
        }

        function clearCollectionData(contributorId, beneficiaryId) {
            // التحقق من أن التحصيل غير مقفل من قبل المدير
            const beneficiaryMember = members.find(m => m.id === beneficiaryId);
            if (beneficiaryMember && beneficiaryMember.collectionLocked === true) {
                showAlert('لا يمكن مسح بيانات التحصيل - مقفل من قبل المدير العام', 'error');
                return;
            }

            // التأكد من صحة المعرفات
            if (!contributorId || !beneficiaryId || !currentAssociation) {
                showAlert('خطأ في المعرفات', 'error');
                return;
            }

            const contributorMember = members.find(m => m.id === contributorId);
            const beneficiaryMemberName = members.find(m => m.id === beneficiaryId);

            const confirmMessage = `هل أنت متأكد من مسح بيانات التحصيل؟\nالمساهم: ${contributorMember ? contributorMember.name : 'غير محدد'}\nالمستفيد: ${beneficiaryMemberName ? beneficiaryMemberName.name : 'غير محدد'}`;

            if (!confirm(confirmMessage)) return;

            const collections = JSON.parse(localStorage.getItem('associationCollections') || '[]');

            // البحث عن السجل المحدد بدقة
            const targetCollection = collections.find(c =>
                c.contributorId === contributorId &&
                c.beneficiaryId === beneficiaryId &&
                c.associationId === currentAssociation.id
            );

            if (targetCollection) {
                // إزالة السجل المحدد فقط باستخدام المعرف الفريد
                const updatedCollections = collections.filter(c => c.id !== targetCollection.id);
                localStorage.setItem('associationCollections', JSON.stringify(updatedCollections));

                // تحديث الإحصائيات
                updateCollectionStats(beneficiaryId);

                // إعادة تحميل الجدول
                displayMemberCollectionTable(beneficiaryId);
                showAlert('تم مسح بيانات التحصيل بنجاح', 'success');
            } else {
                showAlert('لم يتم العثور على بيانات للمسح', 'warning');
            }
        }

        function getTotalCollectionForBeneficiary(beneficiaryId) {
            const collections = JSON.parse(localStorage.getItem('associationCollections') || '[]');
            const beneficiaryCollections = collections.filter(c =>
                c.beneficiaryId === beneficiaryId &&
                c.associationId === currentAssociation.id
            );
            return beneficiaryCollections.reduce((sum, c) => sum + (parseFloat(c.amount) || 0), 0);
        }

        // دالة للحصول على عدد المحصلين
        function getContributorsCount(beneficiaryId) {
            const collections = JSON.parse(localStorage.getItem('associationCollections') || '[]');
            const beneficiaryCollections = collections.filter(c =>
                c.beneficiaryId === beneficiaryId &&
                c.associationId === currentAssociation.id &&
                parseFloat(c.amount) > 0
            );
            return beneficiaryCollections.length;
        }

        // دالة للتحقق من حالة استلام العريس
        function getGroomReceiptStatus(beneficiaryId) {
            const collections = JSON.parse(localStorage.getItem('associationCollections') || '[]');
            const groomCollections = collections.filter(c =>
                c.beneficiaryId === beneficiaryId &&
                c.associationId === currentAssociation.id &&
                c.receiver === 'العريس' &&
                parseFloat(c.amount) > 0
            );
            return groomCollections.length > 0;
        }

        // دالة للحصول على المبلغ المستلم من مسؤولي الجمعية (من كشف التحصيل الحالي)
        function getOfficialReceiptAmount(beneficiaryId) {
            const collections = JSON.parse(localStorage.getItem('associationCollections') || '[]');
            const officialReceivers = [];

            // جمع أسماء المسؤولين من الجمعية
            if (currentAssociation) {
                if (currentAssociation.president && currentAssociation.president.trim() !== '') {
                    officialReceivers.push(currentAssociation.president);
                }
                if (currentAssociation.secretary && currentAssociation.secretary.trim() !== '') {
                    officialReceivers.push(currentAssociation.secretary);
                }
                if (currentAssociation.treasurer && currentAssociation.treasurer.trim() !== '') {
                    officialReceivers.push(currentAssociation.treasurer);
                }
            }

            let totalOfficialAmount = 0;

            // البحث في جميع بيانات التحصيل للعضو المستفيد
            const officialCollections = collections.filter(c =>
                c.beneficiaryId === beneficiaryId &&
                c.associationId === currentAssociation.id &&
                officialReceivers.includes(c.receiver) &&
                parseFloat(c.amount) > 0
            );

            officialCollections.forEach(collection => {
                totalOfficialAmount += parseFloat(collection.amount);
            });

            return totalOfficialAmount;
        }

        // دالة للحصول على إجمالي المبلغ المحصل للعضو المستفيد (استلم العريس)
        function getGroomReceiptAmount(beneficiaryId) {
            // استخدام نفس دالة حساب إجمالي التحصيل
            return getTotalCollectionForBeneficiary(beneficiaryId);
        }



        // دالة للحصول على عدد الملاحظات في التحصيل (من كشف التحصيل الحالي)
        function getCollectionNotesCount(beneficiaryId) {
            const collections = JSON.parse(localStorage.getItem('associationCollections') || '[]');

            // البحث في جميع بيانات التحصيل للعضو المستفيد
            const notesCollections = collections.filter(c =>
                c.beneficiaryId === beneficiaryId &&
                c.associationId === currentAssociation.id &&
                c.notes && c.notes.trim() !== ''
            );

            return notesCollections.length;
        }

        // دالة للحصول على أسماء مسؤولي الجمعية المستلمين (من كشف التحصيل الحالي)
        function getOfficialReceiverName(beneficiaryId) {
            const collections = JSON.parse(localStorage.getItem('associationCollections') || '[]');
            const officialReceivers = [];

            // جمع أسماء المسؤولين من الجمعية
            if (currentAssociation) {
                if (currentAssociation.president && currentAssociation.president.trim() !== '') {
                    officialReceivers.push(currentAssociation.president);
                }
                if (currentAssociation.secretary && currentAssociation.secretary.trim() !== '') {
                    officialReceivers.push(currentAssociation.secretary);
                }
                if (currentAssociation.treasurer && currentAssociation.treasurer.trim() !== '') {
                    officialReceivers.push(currentAssociation.treasurer);
                }
            }

            // البحث في كشف التحصيل عن المسؤولين المستلمين
            const foundOfficials = [];
            const officialCollections = collections.filter(c =>
                c.beneficiaryId === beneficiaryId &&
                c.associationId === currentAssociation.id &&
                officialReceivers.includes(c.receiver) &&
                parseFloat(c.amount) > 0
            );

            officialCollections.forEach(collection => {
                if (!foundOfficials.includes(collection.receiver)) {
                    foundOfficials.push(collection.receiver);
                }
            });

            if (foundOfficials.length > 0) {
                return foundOfficials.join(', ');
            }

            return 'لا يوجد';
        }

        // دالة إنشاء خيارات المستلم
        // تم حذف الدالة المكررة لحل مشكلة تكرار العريس والمسؤول

        // دالة إقفال/إلغاء إقفال التحصيل (للمدير العام فقط)
        function toggleCollectionLock(memberId) {
            // التحقق من صلاحيات المدير العام
            if (!currentUser || currentUser.role !== 'admin') {
                showAlert('هذه العملية متاحة للمدير العام فقط', 'error');
                return;
            }

            const member = members.find(m => m.id === memberId);
            if (!member) {
                showAlert('لم يتم العثور على العضو', 'error');
                return;
            }

            const isCurrentlyLocked = member.collectionLocked === true;
            const action = isCurrentlyLocked ? 'إلغاء إقفال' : 'إقفال';

            if (!confirm(`هل أنت متأكد من ${action} التحصيل المالي للعضو: ${member.name}؟`)) {
                return;
            }

            // تبديل حالة الإقفال
            member.collectionLocked = !isCurrentlyLocked;
            saveMembers();

            // إعادة تحميل الجدول
            displayMemberCollectionTable(memberId);

            const message = isCurrentlyLocked ?
                'تم إلغاء إقفال التحصيل المالي بنجاح' :
                'تم إقفال التحصيل المالي بنجاح';
            showAlert(message, 'success');
        }

        // دوال إدارة أعضاء التحصيل
        function moveCollectionMember(memberId, direction) {
            try {
                console.log('moveCollectionMember called:', memberId, direction);
                const associationMembers = filterMembersByAssociation();
                const currentIndex = associationMembers.findIndex(m => m.id === memberId);

                if (currentIndex === -1) {
                    console.log('Member not found');
                    showAlert('لم يتم العثور على العضو', 'error');
                    return;
                }

            let targetIndex = currentIndex;
            if (direction === 'up' && currentIndex > 0) {
                targetIndex = currentIndex - 1;
            } else if (direction === 'down' && currentIndex < associationMembers.length - 1) {
                targetIndex = currentIndex + 1;
            } else {
                return; // لا يمكن التحريك
            }

            // تبديل العضوين في المصفوفة الأصلية
            const memberIndex1 = members.findIndex(m => m.id === associationMembers[currentIndex].id);
            const memberIndex2 = members.findIndex(m => m.id === associationMembers[targetIndex].id);

            if (memberIndex1 !== -1 && memberIndex2 !== -1) {
                // تبديل المواضع
                [members[memberIndex1], members[memberIndex2]] = [members[memberIndex2], members[memberIndex1]];
                saveMembers();
                displayMemberCollectionTable(currentCollectionMember.id);
                showAlert('تم تحريك العضو بنجاح', 'success');
            }
            } catch (error) {
                console.error('خطأ في تحريك العضو:', error);
                showAlert('حدث خطأ أثناء تحريك العضو', 'error');
            }
        }

        function showMemberNotes(memberId) {
            const member = members.find(m => m.id === memberId);
            if (!member) {
                showAlert('لم يتم العثور على العضو', 'error');
                return;
            }

            // الحصول على الملاحظات من نظام التحصيل وليس من العضو مباشرة
            const currentNotes = getCollectionNotes(memberId, currentCollectionMember.id);
            const newNotes = prompt(`ملاحظات العضو: ${member.name}\n(في تحصيل ${currentCollectionMember.name})`, currentNotes);

            if (newNotes !== null) {
                // حفظ الملاحظات في نظام التحصيل
                updateCollectionData(memberId, currentCollectionMember.id, 'notes', newNotes);
                showAlert('تم حفظ الملاحظات بنجاح', 'success');

                // تحديث الجدول لإظهار التغييرات
                if (currentCollectionMember) {
                    displayMemberCollectionTable(currentCollectionMember.id);
                }

                // تحديث الكروت أيضاً
                displayScheduledMembers();
            }
        }

        // دالة للحصول على ملاحظات التحصيل
        function getCollectionNotes(contributorId, beneficiaryId) {
            const collectionData = getCollectionDataForMember(contributorId, beneficiaryId);
            return collectionData.notes || '';
        }

        function toggleMemberLock(memberId) {
            try {
                console.log('toggleMemberLock called:', memberId);
                console.log('currentUser:', currentUser);

                // التحقق من صلاحيات المدير العام
                if (!currentUser || currentUser.role !== 'admin') {
                    showAlert('هذه العملية متاحة للمدير العام فقط', 'error');
                    return;
                }

                const member = members.find(m => m.id === memberId);
                if (!member) {
                    showAlert('لم يتم العثور على العضو', 'error');
                    return;
                }

                const isCurrentlyLocked = member.isLocked === true;
                const action = isCurrentlyLocked ? 'إلغاء إقفال' : 'إقفال';

                if (!confirm(`هل أنت متأكد من ${action} العضو: ${member.name}؟`)) {
                    return;
                }

                // تبديل حالة الإقفال
                member.isLocked = !isCurrentlyLocked;
                saveMembers();

                // إعادة تحميل الجدول
                displayMemberCollectionTable(currentCollectionMember.id);

                const message = isCurrentlyLocked ?
                    'تم إلغاء إقفال العضو بنجاح' :
                    'تم إقفال العضو بنجاح';
                showAlert(message, 'success');
            } catch (error) {
                console.error('خطأ في إقفال العضو:', error);
                showAlert('حدث خطأ أثناء إقفال العضو', 'error');
            }
        }

        // وظائف النوافذ المنبثقة
        function showAddAssociationModal(type = 'association', editId = null) {
            const modal = document.getElementById('addAssociationModal');
            const title = document.getElementById('associationModalTitle');
            const saveButton = document.getElementById('saveButtonText');
            const amountGroup = document.getElementById('amountGroup');
            const typeInput = document.getElementById('assocType');
            const idInput = document.getElementById('assocId');

            // تعيين النوع
            typeInput.value = type;
            idInput.value = editId || '';

            if (editId) {
                // وضع التعديل
                const item = associations.find(a => a.id === editId);
                if (item) {
                    document.getElementById('assocName').value = item.name;
                    document.getElementById('assocDescription').value = item.description || '';
                    document.getElementById('assocDate').value = item.date || '';
                    document.getElementById('assocAmount').value = item.amount || '';
                    document.getElementById('assocPresident').value = item.president || '';
                    document.getElementById('assocSecretary').value = item.secretary || '';
                    document.getElementById('assocTreasurer').value = item.treasurer || '';
                }
                title.textContent = type === 'association' ? 'تعديل الجمعية' : 'تعديل المعاونة';
                saveButton.textContent = 'حفظ التعديلات';
            } else {
                // وضع الإضافة
                document.getElementById('associationForm').reset();
                // تعيين التاريخ الحالي
                document.getElementById('assocDate').value = new Date().toISOString().split('T')[0];
                title.textContent = type === 'association' ? 'إضافة جمعية جديدة' : 'إضافة معاونة جديدة';
                saveButton.textContent = type === 'association' ? 'حفظ الجمعية' : 'حفظ المعاونة';
            }

            // إظهار/إخفاء حقل المبلغ
            if (type === 'cooperation') {
                amountGroup.style.display = 'none';
                document.getElementById('assocAmount').required = false;
            } else {
                amountGroup.style.display = 'block';
                document.getElementById('assocAmount').required = true;
            }

            modal.style.display = 'block';
        }

        function showPasteModal() {
            document.getElementById('pasteModal').style.display = 'block';
        }

        function showAddUserModal() {
            document.getElementById('addUserModal').style.display = 'block';
        }

        function showModal(modalId) {
            document.getElementById(modalId).style.display = 'block';
        }

        function openModal(modalId) {
            console.log('openModal called with modalId:', modalId);
            const modal = document.getElementById(modalId);
            if (modal) {
                console.log('Modal found, opening:', modalId);
                modal.style.display = 'block';
            } else {
                console.error('Modal not found:', modalId);
            }
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';

            // إعادة تعيين نموذج المستخدم عند الإغلاق
            if (modalId === 'addUserModal') {
                const form = document.getElementById('userForm');
                form.reset();
                form.removeAttribute('data-edit-id');
                document.querySelector('#addUserModal h3').textContent = 'إضافة مستخدم جديد';
            }
            
            // إعادة تعيين نموذج الجمعية/المعونة عند الإغلاق
            if (modalId === 'addAssociationModal') {
                const form = document.getElementById('associationForm');
                if (form) {
                    form.reset();
                    // إعادة تعيين القيم المخفية
                    document.getElementById('assocId').value = '';
                    document.getElementById('assocType').value = 'association';
                    // إعادة تعيين العنوان والنص
                    document.getElementById('associationModalTitle').textContent = 'إضافة جمعية جديدة';
                    document.getElementById('saveButtonText').textContent = 'حفظ الجمعية';
                    // إظهار حقل المبلغ
                    document.getElementById('amountGroup').style.display = 'block';
                    document.getElementById('assocAmount').required = true;
                }
            }
        }

        // إغلاق النوافذ عند النقر خارجها
        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.style.display = 'none';
            }
        }

        // وظائف التسجيل
        function showRegistrationMode(mode) {
            const singleBtn = document.getElementById('singleRegisterBtn');
            const bulkBtn = document.getElementById('bulkRegisterBtn');
            const singleDiv = document.getElementById('singleRegistration');
            const bulkDiv = document.getElementById('bulkRegistration');

            if (mode === 'single') {
                singleBtn.classList.add('btn-primary');
                singleBtn.classList.remove('btn');
                bulkBtn.classList.add('btn');
                bulkBtn.classList.remove('btn-primary');
                singleDiv.style.display = 'block';
                bulkDiv.style.display = 'none';
            } else {
                bulkBtn.classList.add('btn-primary');
                bulkBtn.classList.remove('btn');
                singleBtn.classList.add('btn');
                singleBtn.classList.remove('btn-primary');
                singleDiv.style.display = 'none';
                bulkDiv.style.display = 'block';
            }
        }

        // وظائف الاستيراد الجماعي
        function importMembersFromFile(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                const content = e.target.result;
                document.getElementById('bulkMembersData').value = content;
                processBulkMembers();
            };
            reader.readAsText(file);
        }

        function processPastedData() {
            const data = document.getElementById('pasteData').value;
            document.getElementById('bulkMembersData').value = data;
            closeModal('pasteModal');
            processBulkMembers();
        }

        let bulkMembersPreview = [];

        function processBulkMembers() {
            const data = document.getElementById('bulkMembersData').value.trim();
            if (!data) {
                showAlert('يرجى إدخال بيانات الأعضاء', 'error');
                return;
            }

            const lines = data.split('\n').filter(line => line.trim());
            bulkMembersPreview = [];
            let processedCount = 0;
            let skippedCount = 0;

            lines.forEach((line, index) => {
                // دعم فواصل متعددة: | أو Tab أو فاصلة أو فاصلة منقوطة
                let parts = [];

                if (line.includes('|')) {
                    parts = line.split('|').map(part => part.trim());
                } else if (line.includes('\t')) {
                    parts = line.split('\t').map(part => part.trim());
                } else if (line.includes(',')) {
                    parts = line.split(',').map(part => part.trim());
                } else if (line.includes(';')) {
                    parts = line.split(';').map(part => part.trim());
                } else {
                    // إذا لم توجد فواصل، نعتبر السطر كله اسم واحد
                    parts = [line.trim()];
                }

                // تنظيف الأجزاء من المسافات الزائدة والقيم الفارغة
                parts = parts.filter(part => part && part.trim()).map(part => part.trim());

                // نحتاج على الأقل اسم واحد
                if (parts.length >= 1 && parts[0]) {
                    let name = parts[0];
                    let phone = '';
                    let gender = 'ذكر';
                    let status = 'أعزب';

                    // محاولة استخراج رقم الهاتف من أي عمود
                    for (let i = 1; i < parts.length; i++) {
                        const part = parts[i];
                        // التحقق إذا كان هذا الجزء يحتوي على أرقام (محتمل أن يكون رقم هاتف)
                        if (/\d{9,}/.test(part.replace(/[\s\-+()]/g, ''))) {
                            phone = part.replace(/[^\d+\-]/g, '');
                            break;
                        }
                    }

                    // إذا لم نجد رقم هاتف، نتركه فارغاً
                    if (!phone) {
                        phone = '';
                    }

                    // محاولة تحديد الجنس من الاسم أو البيانات
                    if (name.includes('فاطمة') || name.includes('عائشة') || name.includes('خديجة') ||
                        name.includes('مريم') || name.includes('زينب') || name.includes('أسماء') ||
                        name.includes('سارة') || name.includes('نورا') || name.includes('ريم') ||
                        name.includes('هند') || name.includes('لينا') || name.includes('دانا') ||
                        parts.some(p => p === 'أنثى' || p === 'انثى' || p === 'female')) {
                        gender = 'أنثى';
                        status = 'عزباء';
                    }

                    // البحث عن الجنس في البيانات
                    for (let i = 1; i < parts.length; i++) {
                        const part = parts[i].toLowerCase();
                        if (part === 'أنثى' || part === 'انثى' || part === 'female' || part === 'f') {
                            gender = 'أنثى';
                            status = 'عزباء';
                            break;
                        } else if (part === 'ذكر' || part === 'male' || part === 'm') {
                            gender = 'ذكر';
                            status = 'أعزب';
                            break;
                        }
                    }

                    // البحث عن الحالة الاجتماعية
                    for (let i = 1; i < parts.length; i++) {
                        const part = parts[i];
                        if (['أعزب', 'عزباء', 'مطلق', 'مطلقة', 'أرمل', 'أرملة'].includes(part)) {
                            status = part;
                            break;
                        }
                    }

                    const member = {
                        name: name,
                        phone: phone,
                        gender: gender,
                        status: status,
                        education: '', // محذوف
                        job: '', // محذوف
                        city: parts.find(p => ['الرياض', 'جدة', 'الدمام', 'مكة', 'المدينة', 'الطائف', 'أبها', 'تبوك', 'حائل', 'القصيم'].includes(p)) || '',
                        maritalStatus: 'لم يتزوج',
                        paymentStatus: 'لم يستلم',
                        amount: currentAssociation && currentAssociation.amount ? parseFloat(currentAssociation.amount) : 0,
                        notes: '', // محذوف
                        lineNumber: index + 1,
                        originalLine: line,
                        columnsCount: parts.length
                    };

                    bulkMembersPreview.push(member);
                    processedCount++;
                } else {
                    skippedCount++;
                    console.log(`تم تخطي السطر ${index + 1}: ${line} - سطر فارغ أو غير صالح`);
                }
            });

            if (bulkMembersPreview.length === 0) {
                showAlert(`لم يتم العثور على بيانات صالحة من ${lines.length} سطر.\n\nيمكنك لصق:\n• أسماء فقط (سطر لكل اسم)\n• اسم | هاتف\n• اسم، هاتف، عمر\n• أي تنسيق آخر`, 'error');
                return;
            }

            let message = `تم معالجة ${processedCount} عضو بنجاح`;
            if (skippedCount > 0) {
                message += `، وتم تخطي ${skippedCount} سطر فارغ`;
            }
            showAlert(message, 'success');

            displayBulkPreview();
        }

        function displayBulkPreview() {
            const container = document.getElementById('bulkPreviewTable');

            // إحصائيات سريعة
            const singleColumn = bulkMembersPreview.filter(m => m.columnsCount === 1).length;
            const multiColumn = bulkMembersPreview.filter(m => m.columnsCount > 1).length;
            const generatedPhones = bulkMembersPreview.filter(m => m.phone.startsWith('05') && m.phone.length === 10).length;

            let html = `
                <div class="alert alert-success">
                    <strong>تم العثور على ${bulkMembersPreview.length} عضو صالح للاستيراد</strong><br>
                    <small>
                        • ${singleColumn} عضو من عمود واحد (اسم فقط)
                        ${multiColumn > 0 ? `• ${multiColumn} عضو من أعمدة متعددة` : ''}
                        ${generatedPhones > 0 ? `• تم توليد ${generatedPhones} رقم هاتف تلقائياً` : ''}
                    </small>
                </div>
                <table class="table">
                    <thead>
                        <tr>
                            <th>السطر</th>
                            <th>الاسم</th>
                            <th>الهاتف</th>
                            <th>الحالة الاجتماعية</th>
                            <th>المدينة</th>
                            <th>الأعمدة</th>
                            <th>السطر الأصلي</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            bulkMembersPreview.forEach(member => {
                html += `
                    <tr>
                        <td>${member.lineNumber}</td>
                        <td><strong>${member.name}</strong> <small style="color: #7f8c8d;">(${member.gender})</small></td>
                        <td>${member.phone || '<span style="color: #dc3545;">فارغ</span>'}</td>
                        <td>${member.status}</td>
                        <td>${member.city || '-'}</td>
                        <td><span style="background: #e9ecef; padding: 2px 6px; border-radius: 4px; font-size: 0.8rem;">${member.columnsCount}</span></td>
                        <td style="font-size: 0.8rem; color: #7f8c8d; max-width: 200px; overflow: hidden; text-overflow: ellipsis;">${member.originalLine}</td>
                    </tr>
                `;
            });

            html += '</tbody></table>';
            container.innerHTML = html;
            document.getElementById('bulkPreview').style.display = 'block';
        }

        function confirmBulkImport() {
            bulkMembersPreview.forEach(memberData => {
                const member = {
                    id: Date.now().toString() + Math.random().toString(36).substr(2, 9),
                    associationId: currentAssociation.id,
                    name: memberData.name,
                    phone: memberData.phone,
                    gender: memberData.gender,
                    status: memberData.status,
                    education: '', // محذوف
                    job: '', // محذوف
                    city: memberData.city,
                    maritalStatus: memberData.maritalStatus,
                    paymentStatus: '', // يحدده المستخدم
                    amount: memberData.amount,
                    notes: '', // محذوف
                    registrationDate: new Date().toLocaleDateString('ar-SA'),
                    civilId: null,
                    // حقول خاصة بالمعاونات
                    transferType: currentAssociation && currentAssociation.type === 'cooperation' ? 'نقداً' : null,
                    bank: currentAssociation && currentAssociation.type === 'cooperation' ? '' : null,
                    receiver: currentAssociation && currentAssociation.type === 'cooperation' ? '' : null,
                    order: members.filter(m => m.associationId === currentAssociation.id).length + bulkMembersPreview.indexOf(memberData)
                };

                members.push(member);
            });

            saveMembers();
            clearBulkData();
            updateStats();
            displayMembers();
            
            // تحديث قوائم المستلمين لضمان ظهور الأسهم بعد إضافة الأعضاء
            setTimeout(() => {
                updateReceiverDropdowns();
            }, 100);
            
            showAlert(`تم إضافة ${bulkMembersPreview.length} عضو بنجاح!`, 'success');
        }

        function cancelBulkImport() {
            document.getElementById('bulkPreview').style.display = 'none';
            bulkMembersPreview = [];
        }

        function clearBulkData() {
            document.getElementById('bulkMembersData').value = '';
            document.getElementById('pasteData').value = '';
            document.getElementById('bulkPreview').style.display = 'none';
            bulkMembersPreview = [];
        }

        // وظائف الجمعيات
        document.getElementById('associationForm').addEventListener('submit', function(e) {
            e.preventDefault();

            const editId = document.getElementById('assocId').value;
            const type = document.getElementById('assocType').value;

            const associationData = {
                name: document.getElementById('assocName').value,
                description: document.getElementById('assocDescription').value,
                date: document.getElementById('assocDate').value,
                type: type,
                amount: type === 'association' ? parseFloat(document.getElementById('assocAmount').value) || 0 : null,
                president: document.getElementById('assocPresident').value,
                secretary: document.getElementById('assocSecretary').value,
                treasurer: document.getElementById('assocTreasurer').value
            };

            if (editId) {
                // تعديل موجود
                const index = associations.findIndex(a => a.id === editId);
                if (index !== -1) {
                    associations[index] = { ...associations[index], ...associationData };

                    // إذا كانت الجمعية المعدلة هي الحالية، نحدث currentAssociation
                    if (currentAssociation && currentAssociation.id === editId) {
                        currentAssociation = associations[index];
                        localStorage.setItem('currentAssociation', JSON.stringify(currentAssociation));
                    }

                    showAlert(`تم تعديل ${type === 'association' ? 'الجمعية' : 'المعاونة'} بنجاح!`, 'success');
                }
            } else {
                // إضافة جديد
                const association = {
                    id: Date.now().toString(),
                    ...associationData,
                    status: 'نشطة',
                    createdAt: new Date().toISOString()
                };

                associations.push(association);
                showAlert(`تم إضافة ${type === 'association' ? 'الجمعية' : 'المعاونة'} بنجاح!`, 'success');
            }

            saveAssociations();

            // إعادة تعيين النموذج بشكل كامل
            this.reset();
            document.getElementById('assocId').value = '';
            document.getElementById('assocType').value = 'association';
            
            // إغلاق النافذة
            closeModal('addAssociationModal');

            // تحديث العرض والأقسام
            displayAssociations();
            
            // تحديث قسم المعاونات إذا كان نشطاً
            if (document.getElementById('register').classList.contains('active')) {
                displayCooperations();
            }

            // تحديث جميع الأقسام إذا تم تعديل الجمعية الحالية
            if (editId && currentAssociation && currentAssociation.id === editId) {
                updateAllSections();
                // تحديث قوائم المستلمين في كشف التحصيل المالي
                updateReceiverDropdowns();
            }
        });

        function displayAssociations() {
            const container = document.getElementById('associationsList');

            // تصفية الجمعيات فقط (استبعاد المعاونات)
            const associationsList = associations.filter(a => a.type !== 'cooperation');

            if (associationsList.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #7f8c8d;">لا توجد جمعيات مسجلة</p>';
                return;
            }

            let html = '';

            // عرض الجمعيات فقط
            html += '<h3 style="color: #2c3e50; margin-bottom: 20px;"><i class="fas fa-building"></i> الجمعيات</h3>';
            html += '<div class="stats-grid">';

            associationsList.forEach(association => {
                const isActive = currentAssociation && currentAssociation.id === association.id;
                const memberCount = members.filter(m => m.associationId === association.id).length;
                const totalAmount = memberCount * (association.amount || 0);

                html += `
                    <div class="stat-card" style="border: ${isActive ? '3px solid #3498db' : '1px solid #dee2e6'}; background: ${isActive ? '#f8f9ff' : '#fff'};">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <h4 style="margin: 0;">${association.name}</h4>
                            <span style="background: #3498db; color: white; padding: 4px 8px; border-radius: 12px; font-size: 0.8rem;">جمعية</span>
                        </div>
                        <p style="color: #7f8c8d; margin-bottom: 15px;">${association.description || 'لا يوجد وصف'}</p>
                        <div style="margin: 15px 0; text-align: right; line-height: 1.6;">
                            <div><strong>الأعضاء:</strong> ${memberCount}</div>
                            <div><strong>المبلغ للعضو:</strong> ${association.amount ? association.amount.toLocaleString() : '0'} ريال</div>
                            <div><strong>إجمالي المبالغ:</strong> ${totalAmount.toLocaleString()} ريال</div>
                            <div><strong>الرئيس:</strong> ${association.president || 'غير محدد'}</div>
                            <div><strong>أمين السر:</strong> ${association.secretary || 'غير محدد'}</div>
                        </div>
                        <div style="text-align: center; margin-top: 15px;">
                            ${!isActive ? `<button class="btn btn-primary" onclick="selectAssociation('${association.id}')">
                                <i class="fas fa-check"></i> تحديد كحالية
                            </button>` : '<span style="color: #27ae60; font-weight: bold;"><i class="fas fa-check-circle"></i> الحالية</span>'}
                            <button class="btn btn-warning" onclick="showAddAssociationModal('association', '${association.id}')">
                                <i class="fas fa-edit"></i> تعديل
                            </button>
                            <button class="btn btn-danger" onclick="deleteAssociation('${association.id}')">
                                <i class="fas fa-trash"></i> حذف
                            </button>
                        </div>
                    </div>
                `;
            });

            html += '</div>';
            container.innerHTML = html;
        }

        function selectAssociation(associationId) {
            const association = associations.find(a => a.id === associationId);
            if (association) {
                currentAssociation = association;

                // حفظ الجمعية الحالية
                if (currentUser) {
                    localStorage.setItem('currentAssociation', JSON.stringify(currentAssociation));
                }

                saveAssociations();
                displayAssociations();
                updateStats();
                updateTitle(document.querySelector('.section.active').id);
                updateMemberAmountField();
                updateMemberListActions(); // تحديث أزرار إضافة الأعضاء
                updateReportsSection(); // تحديث قسم التقارير عند تغيير الجمعية
                updateReceiverDropdowns(); // تحديث قوائم المستلمين في كشف التحصيل
                showAlert(`تم تحديد "${association.name}" كجمعية حالية`, 'success');
            }
        }

        function updateMemberAmountField() {
            // تم تبسيط النموذج - لا حاجة لتحديث الحقول المحذوفة
            console.log('تم تبسيط نموذج التسجيل');
        }

        // دالة تحديث جميع الأقسام عند تعديل الجمعية الحالية
        function updateAllSections() {
            console.log('تحديث جميع الأقسام بعد تعديل الجمعية:', currentAssociation);

            // تحديث العنوان
            updateTitle(document.querySelector('.section.active').id);

            // تحديث الإحصائيات
            updateStats();

            // تحديث قائمة الأعضاء
            if (document.getElementById('members').classList.contains('active')) {
                displayMembers();
            }

            // تحديث قسم التحصيل المالي
            if (document.getElementById('collection').classList.contains('active')) {
                displayScheduledMembers();
            }

            // تحديث قسم التقارير
            if (document.getElementById('reports').classList.contains('active')) {
                updateReportsSection();
            }

            // تحديث حقل المبلغ في تسجيل الأعضاء
            updateMemberAmountField();

            // تحديث معلومات الجمعية في الصفحة الرئيسية
            if (document.getElementById('dashboard').classList.contains('active')) {
                displayAssociations();
            }

            // تحديث أي عناصر أخرى تعتمد على بيانات الجمعية
            const associationNameElements = document.querySelectorAll('.association-name');
            associationNameElements.forEach(element => {
                if (currentAssociation) {
                    element.textContent = currentAssociation.name;
                }
            });

            // تحديث معلومات المبلغ الثابت
            const amountElements = document.querySelectorAll('.association-amount');
            amountElements.forEach(element => {
                if (currentAssociation && currentAssociation.amount) {
                    element.textContent = currentAssociation.amount.toLocaleString() + ' ريال';
                }
            });

            // إعادة تحديث مبالغ الأعضاء إذا تغير المبلغ الثابت للجمعية
            if (currentAssociation && currentAssociation.type === 'association') {
                const associationMembers = members.filter(m => m.associationId === currentAssociation.id);
                let updated = false;
                associationMembers.forEach(member => {
                    if (member.amount !== currentAssociation.amount) {
                        member.amount = currentAssociation.amount;
                        updated = true;
                    }
                });
                if (updated) {
                    saveMembers();
                    console.log('تم تحديث مبالغ الأعضاء حسب المبلغ الثابت الجديد');
                }
            }
        }

        // دوال التعبئة الجماعية في رأس الجدول
        function applyBulkAmountToBeneficiary(beneficiaryId, amount) {
            if (!amount || amount === '') return;

            const associationMembers = filterMembersByAssociation();
            associationMembers.forEach(member => {
                const amountInput = document.getElementById(`amount_${member.id}`);
                if (amountInput && !amountInput.disabled) {
                    amountInput.value = amount;
                    updateCollectionData(member.id, beneficiaryId, 'amount', amount);
                }
            });

            showAlert(`تم تطبيق المبلغ ${parseFloat(amount).toLocaleString()} ريال على جميع الأعضاء`, 'success');
        }

        function applyBulkTransferType(beneficiaryId, transferType) {
            if (!transferType || transferType === '') return;

            const associationMembers = filterMembersByAssociation();
            associationMembers.forEach(member => {
                const transferTypeSelect = document.getElementById(`transferType_${member.id}`);
                if (transferTypeSelect && !transferTypeSelect.disabled) {
                    transferTypeSelect.value = transferType;
                    updateCollectionData(member.id, beneficiaryId, 'transferType', transferType);
                }
            });

            showAlert(`تم تطبيق نوع التحويل "${transferType}" على جميع الأعضاء`, 'success');
        }

        function applyBulkBank(beneficiaryId, bank) {
            if (!bank || bank === '') return;

            const associationMembers = filterMembersByAssociation();
            associationMembers.forEach(member => {
                const bankSelect = document.getElementById(`bank_${member.id}`);
                if (bankSelect && !bankSelect.disabled) {
                    bankSelect.value = bank;
                    updateCollectionData(member.id, beneficiaryId, 'bank', bank);
                }
            });

            showAlert(`تم تطبيق البنك "${bank}" على جميع الأعضاء`, 'success');
        }

        function applyBulkReceiver(beneficiaryId, receiver) {
            if (!receiver || receiver === '') return;

            const associationMembers = filterMembersByAssociation();
            associationMembers.forEach(member => {
                const receiverSelect = document.getElementById(`receiver_${member.id}`);
                if (receiverSelect && !receiverSelect.disabled) {
                    receiverSelect.value = receiver;
                    updateCollectionData(member.id, beneficiaryId, 'receiver', receiver);
                }
            });

            showAlert(`تم تطبيق المستلم "${receiver}" على جميع الأعضاء`, 'success');
        }

        // وظائف التعديل المبسط
        function showEditMemberModal(memberId) {
            const member = members.find(m => m.id === memberId);
            if (!member) {
                showAlert('لم يتم العثور على العضو', 'error');
                return;
            }

            // ملء البيانات في النموذج
            document.getElementById('editMemberId').value = member.id;
            document.getElementById('editMemberName').value = member.name || '';
            document.getElementById('editMemberPhone').value = member.phone || '';
            document.getElementById('editMemberGeneralNotes').value = member.generalNotes || '';

            // تحديث العنوان
            document.getElementById('editMemberTitle').textContent = `تعديل العضو: ${member.name}`;

            // إظهار النافذة
            document.getElementById('editMemberModal').style.display = 'block';
        }

        // معالج نموذج التعديل
        document.getElementById('editMemberForm').addEventListener('submit', function(e) {
            e.preventDefault();

            const memberId = document.getElementById('editMemberId').value;
            const member = members.find(m => m.id === memberId);

            if (member) {
                // تحديث البيانات
                member.name = document.getElementById('editMemberName').value;
                member.phone = document.getElementById('editMemberPhone').value;
                member.generalNotes = document.getElementById('editMemberGeneralNotes').value;

                // حفظ التغييرات
                saveMembers();

                // إغلاق النافذة
                closeModal('editMemberModal');

                // تحديث لون الصف والبيانات المعروضة
                updateRowColor(memberId, member);
                updateMemberDisplayData(memberId, member);

                showAlert('تم تحديث بيانات العضو بنجاح!', 'success');
            }
        });

        // وظائف تسجيل أعضاء المعاونة
        document.getElementById('cooperationMemberForm').addEventListener('submit', function(e) {
            e.preventDefault();

            if (!currentAssociation || currentAssociation.type !== 'cooperation') {
                showAlert('يجب اختيار معاونة أولاً', 'error');
                return;
            }

            const name = document.getElementById('cooperationMemberName').value.trim();
            if (!name) {
                showAlert('يجب إدخال اسم العضو', 'error');
                return;
            }

            // إنشاء عضو جديد
            const member = {
                id: Date.now().toString(),
                associationId: currentAssociation.id,
                name: name,
                phone: '', // فارغ للمعاونات
                gender: '', // يحدده المستخدم
                status: '', // فارغ للمعاونات
                city: '', // فارغ للمعاونات
                maritalStatus: '', // فارغ للمعاونات
                paymentStatus: 'لم يستلم',
                amount: 0, // صفر للمعاونات
                notes: '',
                registrationDate: new Date().toLocaleDateString('ar-SA'),
                civilId: null,
                transferType: '',
                bank: '',
                receiver: '',
                order: members.filter(m => m.associationId === currentAssociation.id).length
            };

            members.push(member);
            saveMembers();

            // إغلاق النافذة وتنظيف النموذج
            closeModal('addCooperationMemberModal');
            document.getElementById('cooperationMemberName').value = '';

            // تحديث العرض
            displayMembers();
            updateStats();

            showAlert('تم تسجيل العضو بنجاح!', 'success');
        });

        // دالة تحديث قوائم المستلمين في كشف التحصيل المالي
        function updateReceiverDropdowns() {
            // تحديث قوائم المستلمين في الجدول العادي
            const receiverSelects = document.querySelectorAll('select[id^="receiver_"]');
            receiverSelects.forEach(select => {
                const currentValue = select.value;
                select.innerHTML = '<option value="">اختر المستلم</option>' + getReceiverOptions(currentValue);
            });

            // تحديث قائمة المستلم في التعبئة الجماعية
            const bulkReceiverSelects = document.querySelectorAll('select[id^="bulkReceiver_"]');
            bulkReceiverSelects.forEach(select => {
                const currentValue = select.value;
                let options = '<option value="">اختر</option>';

                // إضافة المسؤولين
                if (currentAssociation) {
                    if (currentAssociation.president && currentAssociation.president.trim() !== '') {
                        const selected = currentValue === currentAssociation.president ? 'selected' : '';
                        options += `<option value="${currentAssociation.president}" ${selected}>${currentAssociation.president}</option>`;
                    }
                    if (currentAssociation.secretary && currentAssociation.secretary.trim() !== '') {
                        const selected = currentValue === currentAssociation.secretary ? 'selected' : '';
                        options += `<option value="${currentAssociation.secretary}" ${selected}>${currentAssociation.secretary}</option>`;
                    }
                    if (currentAssociation.treasurer && currentAssociation.treasurer.trim() !== '') {
                        const selected = currentValue === currentAssociation.treasurer ? 'selected' : '';
                        options += `<option value="${currentAssociation.treasurer}" ${selected}>${currentAssociation.treasurer}</option>`;
                    }
                }

                // إضافة الخيارات الثابتة
                const fixedOptions = ['العريس', 'والد العريس', 'آخر'];
                fixedOptions.forEach(option => {
                    const selected = currentValue === option ? 'selected' : '';
                    options += `<option value="${option}" ${selected}>${option}</option>`;
                });

                select.innerHTML = options;
            });
        }

        // وظائف الاستيراد الجماعي للمعاونة
        let cooperationBulkPreview = [];

        function previewCooperationImport() {
            const namesText = document.getElementById('bulkCooperationNames').value.trim();
            if (!namesText) {
                showAlert('يجب إدخال الأسماء أولاً', 'error');
                return;
            }

            if (!currentAssociation || currentAssociation.type !== 'cooperation') {
                showAlert('يجب اختيار معاونة أولاً', 'error');
                return;
            }

            const lines = namesText.split('\n').filter(line => line.trim());
            cooperationBulkPreview = [];

            // تحليل ذكي للبيانات
            const parsedData = parseSmartImportData(lines);
            cooperationBulkPreview = parsedData.members;

            if (cooperationBulkPreview.length === 0) {
                showAlert('لم يتم العثور على بيانات صالحة للاستيراد', 'error');
                return;
            }

            // عرض المعاينة مع تفاصيل الأعمدة المكتشفة
            displayCooperationPreview(parsedData.columnInfo);
            document.getElementById('confirmCooperationBtn').style.display = 'inline-block';
        }

        // وظيفة التحليل الذكي للبيانات
        function parseSmartImportData(lines) {
            const members = [];
            let columnInfo = {
                detected: [],
                ignored: []
            };

            lines.forEach((line, index) => {
                const trimmedLine = line.trim();
                if (!trimmedLine) return;

                // تقسيم السطر بناءً على الفواصل المختلفة
                let columns = [];

                // محاولة تقسيم بالتاب أولاً (من Excel)
                if (trimmedLine.includes('\t')) {
                    columns = trimmedLine.split('\t');
                }
                // ثم بالفاصلة
                else if (trimmedLine.includes(',')) {
                    columns = trimmedLine.split(',');
                }
                // ثم بالفاصلة المنقوطة
                else if (trimmedLine.includes(';')) {
                    columns = trimmedLine.split(';');
                }
                // ثم بالمسافات المتعددة
                else if (trimmedLine.includes('  ')) {
                    columns = trimmedLine.split(/\s{2,}/);
                }
                // أخيراً كاسم واحد
                else {
                    columns = [trimmedLine];
                }

                // تنظيف الأعمدة
                columns = columns.map(col => col.trim()).filter(col => col);

                if (columns.length === 0) return;

                // تحليل الأعمدة وتحديد نوعها
                const memberData = analyzeColumns(columns, index);
                if (memberData.name) {
                    members.push(memberData);
                }

                // تحديث معلومات الأعمدة للسطر الأول
                if (index === 0) {
                    columnInfo = getColumnInfo(columns);
                }
            });

            return { members, columnInfo };
        }

        // تحليل الأعمدة وتحديد نوعها
        function analyzeColumns(columns, lineIndex) {
            const memberData = {
                lineNumber: lineIndex + 1,
                name: '',
                amount: '',
                transferType: '',
                bank: '',
                receiver: '',
                originalLine: columns.join(' | ')
            };

            // إزالة الأعمدة الرقمية التسلسلية من البداية
            let filteredColumns = [];
            let startIndex = 0;

            // تجاهل الأعمدة الرقمية التسلسلية في البداية فقط
            for (let i = 0; i < columns.length; i++) {
                const cleanColumn = columns[i].trim();
                if (/^\d+$/.test(cleanColumn) && cleanColumn.length <= 4 && i === startIndex) {
                    startIndex++; // تجاهل هذا العمود
                } else {
                    break; // توقف عند أول عمود غير رقمي
                }
            }

            // أخذ الأعمدة المتبقية
            filteredColumns = columns.slice(startIndex);

            // تعيين الأعمدة بالترتيب المحدد
            if (filteredColumns.length >= 1) {
                memberData.name = filteredColumns[0].trim(); // العمود الأول: الاسم
            }
            if (filteredColumns.length >= 2) {
                memberData.amount = filteredColumns[1].trim().replace(/[^\d.]/g, ''); // العمود الثاني: المبلغ
            }
            if (filteredColumns.length >= 3) {
                memberData.transferType = filteredColumns[2].trim(); // العمود الثالث: نوع التحويل
            }
            if (filteredColumns.length >= 4) {
                memberData.bank = filteredColumns[3].trim(); // العمود الرابع: البنك
            }
            if (filteredColumns.length >= 5) {
                memberData.receiver = filteredColumns[4].trim(); // العمود الخامس: المستلم
            }

            return memberData;
        }

        // وظائف التعرف على نوع العمود
        function isNameColumn(text) {
            // أسماء عربية أو إنجليزية
            return /^[\u0600-\u06FF\s]+$/.test(text) || /^[a-zA-Z\s]+$/.test(text);
        }

        function isAmountColumn(text) {
            // يحتوي على أرقام ومبلغ
            return /\d+/.test(text) && (text.includes('ريال') || text.includes('SR') || /^\d+\.?\d*$/.test(text.replace(/,/g, '')));
        }

        function isTransferTypeColumn(text) {
            const transferTypes = ['نقداً', 'تحويل', 'واصل', 'شيك', 'كاش', 'بنكي'];
            return transferTypes.some(type => text.includes(type));
        }

        function isBankColumn(text) {
            const banks = ['الراجحي', 'الأهلي', 'سامبا', 'الرياض', 'البلاد', 'الجزيرة', 'الإنماء', 'ساب', 'العربي', 'الفرنسي'];
            return banks.some(bank => text.includes(bank)) || text.includes('بنك');
        }

        function isReceiverColumn(text) {
            const receivers = ['العريس', 'العروس', 'الوالد', 'الوالدة', 'الأسرة'];
            return receivers.some(receiver => text.includes(receiver));
        }

        // معلومات الأعمدة المكتشفة
        function getColumnInfo(columns) {
            const info = {
                detected: [],
                ignored: []
            };

            // تحديد الأعمدة المتجاهلة (الأرقام التسلسلية في البداية)
            let startIndex = 0;
            for (let i = 0; i < columns.length; i++) {
                const cleanColumn = columns[i].trim();
                if (/^\d+$/.test(cleanColumn) && cleanColumn.length <= 4 && i === startIndex) {
                    info.ignored.push(`العمود ${i + 1}: رقم تسلسلي (${cleanColumn}) - تم تجاهله`);
                    startIndex++;
                } else {
                    break;
                }
            }

            // تحديد الأعمدة المكتشفة بالترتيب المحدد
            const filteredColumns = columns.slice(startIndex);
            const columnLabels = ['الاسم', 'المبلغ', 'نوع التحويل', 'البنك', 'المستلم'];

            filteredColumns.forEach((column, index) => {
                const cleanColumn = column.trim();
                const originalIndex = startIndex + index + 1;
                const label = columnLabels[index] || 'بيانات إضافية';

                info.detected.push(`العمود ${originalIndex}: ${label} (${cleanColumn})`);
            });

            return info;
        }

        function displayCooperationPreview(columnInfo) {
            const container = document.getElementById('cooperationPreviewTable');

            let html = `
                <div class="alert alert-success">
                    <i class="fas fa-check-circle"></i> تم العثور على <strong>${cooperationBulkPreview.length}</strong> عضو للاستيراد
                </div>
            `;

            // عرض معلومات الأعمدة المكتشفة
            if (columnInfo) {
                html += `
                    <div class="alert alert-info" style="margin-bottom: 15px;">
                        <h5><i class="fas fa-columns"></i> تحليل الأعمدة:</h5>
                `;

                if (columnInfo.detected.length > 0) {
                    html += `<div style="margin-bottom: 10px;"><strong>✅ أعمدة مكتشفة:</strong><br>`;
                    columnInfo.detected.forEach(info => {
                        html += `<span style="display: inline-block; margin: 2px 5px; padding: 2px 8px; background: #d4edda; border-radius: 3px; font-size: 0.85rem;">${info}</span>`;
                    });
                    html += `</div>`;
                }

                if (columnInfo.ignored.length > 0) {
                    html += `<div><strong>⚠️ أعمدة متجاهلة:</strong><br>`;
                    columnInfo.ignored.forEach(info => {
                        html += `<span style="display: inline-block; margin: 2px 5px; padding: 2px 8px; background: #f8d7da; border-radius: 3px; font-size: 0.85rem;">${info}</span>`;
                    });
                    html += `</div>`;
                }

                html += `</div>`;
            }

            html += `
                <table class="table">
                    <thead>
                        <tr>
                            <th>الرقم</th>
                            <th>الاسم</th>
                            <th>المبلغ</th>
                            <th>نوع التحويل</th>
                            <th>البنك</th>
                            <th>المستلم</th>
                            <th>السطر الأصلي</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            cooperationBulkPreview.forEach(member => {
                html += `
                    <tr>
                        <td>${member.lineNumber}</td>
                        <td><strong>${member.name || '-'}</strong></td>
                        <td>${member.amount || '-'}</td>
                        <td>${member.transferType || '-'}</td>
                        <td>${member.bank || '-'}</td>
                        <td>${member.receiver || '-'}</td>
                        <td style="font-size: 0.75rem; color: #7f8c8d; max-width: 200px; word-break: break-all;">${member.originalLine}</td>
                    </tr>
                `;
            });

            html += '</tbody></table>';
            container.innerHTML = html;
            document.getElementById('cooperationPreview').style.display = 'block';
        }

        function confirmCooperationImport() {
            if (cooperationBulkPreview.length === 0) {
                showAlert('لا توجد أعضاء للاستيراد', 'error');
                return;
            }

            const currentMemberCount = members.filter(m => m.associationId === currentAssociation.id).length;

            cooperationBulkPreview.forEach((memberData, index) => {
                const member = {
                    id: Date.now().toString() + '_' + index,
                    associationId: currentAssociation.id,
                    name: memberData.name || 'غير محدد',
                    phone: '', // فارغ للمعاونات
                    gender: '', // يحدده المستخدم
                    status: '', // فارغ للمعاونات
                    city: '', // فارغ للمعاونات
                    maritalStatus: '', // فارغ للمعاونات
                    paymentStatus: memberData.amount && parseFloat(memberData.amount) > 0 ? 'مساهم' : 'لم يساهم',
                    amount: memberData.amount ? parseFloat(memberData.amount) || 0 : 0,
                    notes: '',
                    registrationDate: new Date().toLocaleDateString('ar-SA'),
                    civilId: null,
                    transferType: memberData.transferType || 'نقداً',
                    bank: memberData.bank || '',
                    receiver: memberData.receiver || '',
                    order: currentMemberCount + index
                };

                members.push(member);
            });

            saveMembers();

            // إغلاق النافذة وتنظيف النموذج
            closeModal('bulkCooperationImportModal');
            document.getElementById('bulkCooperationNames').value = '';
            document.getElementById('cooperationPreview').style.display = 'none';
            document.getElementById('confirmCooperationBtn').style.display = 'none';
            cooperationBulkPreview = [];

            // تحديث العرض
            displayMembers();
            updateStats();

            showAlert(`تم استيراد ${cooperationBulkPreview.length} عضو بنجاح!`, 'success');
        }

        // وظائف تفاصيل العضو
        let currentMemberDetails = null;

        function showMemberDetails(memberId) {
            // التحقق من الصلاحيات
            if (!canAccessMemberData(memberId)) {
                showAlert('ليس لديك صلاحية للوصول لبيانات هذا العضو', 'error');
                return;
            }

            const member = members.find(m => m.id === memberId);
            if (!member) {
                showAlert('لم يتم العثور على العضو', 'error');
                return;
            }

            currentMemberDetails = member;

            // تحديث عنوان النافذة
            document.getElementById('memberDetailsTitle').textContent = `تفاصيل العضو: ${member.name}`;

            // ملء البيانات الشخصية
            document.getElementById('detailName').value = member.name || '';
            document.getElementById('detailPhone').value = member.phone || '';
            document.getElementById('detailStatus').value = member.status || '';
            document.getElementById('detailCity').value = member.city || '';
            document.getElementById('detailGender').value = member.gender || 'ذكر';

            // ملء البيانات البنكية
            document.getElementById('detailIban').value = member.iban || '';
            document.getElementById('detailAccountNumber').value = member.accountNumber || '';
            document.getElementById('detailBankName').value = member.bankName || '';
            document.getElementById('detailAccountHolder').value = member.accountHolder || member.name || '';

            // ملء بيانات الزواج
            document.getElementById('detailMaritalStatus').value = member.maritalStatus || 'لم يتزوج';
            document.getElementById('detailMarriageDate').value = member.marriageDate || '';

            // ملء قائمة البنوك
            const bankSelect = document.getElementById('detailBankName');
            const banks = getSaudiBanks();
            bankSelect.innerHTML = '<option value="">اختر البنك</option>';
            banks.forEach(bank => {
                bankSelect.innerHTML += `<option value="${bank}">${bank}</option>`;
            });
            bankSelect.value = member.bankName || '';

            // تحديث حقول الزواج
            updateMarriageFields();

            // تحديث الإحصائيات
            updateMemberStatistics();

            // إظهار القسم الأول
            showMemberTab('personalInfo');

            // إظهار النافذة
            document.getElementById('memberDetailsModal').style.display = 'block';
        }

        function showMemberTab(tabName) {
            // إخفاء جميع الأقسام
            document.querySelectorAll('.member-tab-section').forEach(section => {
                section.style.display = 'none';
            });

            // إزالة الفئة النشطة من جميع الأزرار
            document.querySelectorAll('#memberDetailsModal .btn').forEach(btn => {
                btn.classList.remove('btn-primary');
                btn.classList.add('btn');
            });

            // إظهار القسم المحدد
            document.getElementById(tabName + 'Section').style.display = 'block';

            // تفعيل الزر المحدد
            const activeTab = document.getElementById(tabName + 'Tab');
            activeTab.classList.remove('btn');
            activeTab.classList.add('btn-primary');
        }

        function updateMarriageFields() {
            const maritalStatus = document.getElementById('detailMaritalStatus').value;
            const marriageDateGroup = document.getElementById('marriageDateGroup');
            const remainingTimeGroup = document.getElementById('remainingTimeGroup');
            const cancelMarriageGroup = document.getElementById('cancelMarriageGroup');

            if (maritalStatus === 'تم تحديد الزواج') {
                marriageDateGroup.style.display = 'block';
                remainingTimeGroup.style.display = 'block';
                cancelMarriageGroup.style.display = 'block';
                calculateRemainingTime();
            } else if (maritalStatus === 'تزوج') {
                marriageDateGroup.style.display = 'block';
                remainingTimeGroup.style.display = 'none';
                cancelMarriageGroup.style.display = 'none';
            } else {
                marriageDateGroup.style.display = 'none';
                remainingTimeGroup.style.display = 'none';
                cancelMarriageGroup.style.display = 'none';
            }
        }

        function calculateRemainingTime() {
            const marriageDate = document.getElementById('detailMarriageDate').value;
            const remainingTimeDisplay = document.getElementById('remainingTimeDisplay');

            if (!marriageDate) {
                remainingTimeDisplay.innerHTML = 'لم يتم تحديد تاريخ الزواج';
                remainingTimeDisplay.className = '';
                return;
            }

            const today = new Date();
            const weddingDate = new Date(marriageDate);
            const timeDiff = weddingDate.getTime() - today.getTime();
            const daysDiff = Math.ceil(timeDiff / (1000 * 3600 * 24));

            let message = '';
            let className = '';

            if (daysDiff < 0) {
                message = `تم الزواج منذ ${Math.abs(daysDiff)} يوم`;
                className = 'normal';
            } else if (daysDiff === 0) {
                message = 'اليوم هو يوم الزواج! 🎉';
                className = 'urgent';
            } else if (daysDiff <= 7) {
                message = `باقي ${daysDiff} يوم على الزواج`;
                className = 'urgent';
            } else if (daysDiff <= 30) {
                message = `باقي ${daysDiff} يوم على الزواج`;
                className = 'warning';
            } else {
                const months = Math.floor(daysDiff / 30);
                const remainingDays = daysDiff % 30;
                message = `باقي ${months} شهر و ${remainingDays} يوم على الزواج`;
                className = 'normal';
            }

            remainingTimeDisplay.innerHTML = message;
            remainingTimeDisplay.className = className;
        }

        function cancelMarriageDate() {
            if (confirm('هل أنت متأكد من إلغاء موعد الزواج؟')) {
                document.getElementById('detailMaritalStatus').value = 'لم يتزوج';
                document.getElementById('detailMarriageDate').value = '';
                updateMarriageFields();
                showAlert('تم إلغاء موعد الزواج', 'success');
            }
        }

        // دالة لحساب ما دفعه العضو للمتزوجين
        function getTotalPaidByMember(memberId) {
            const collections = JSON.parse(localStorage.getItem('associationCollections') || '[]');
            const memberPayments = collections.filter(c =>
                c.contributorId === memberId &&
                c.associationId === currentAssociation.id &&
                parseFloat(c.amount) > 0
            );

            return memberPayments.reduce((sum, payment) => sum + parseFloat(payment.amount), 0);
        }

        // دالة لحساب ما استلمه العضو من الآخرين
        function getTotalReceivedByMember(memberId) {
            const collections = JSON.parse(localStorage.getItem('associationCollections') || '[]');
            const memberReceipts = collections.filter(c =>
                c.beneficiaryId === memberId &&
                c.associationId === currentAssociation.id &&
                parseFloat(c.amount) > 0
            );

            return memberReceipts.reduce((sum, receipt) => sum + parseFloat(receipt.amount), 0);
        }

        function updateMemberStatistics() {
            if (!currentMemberDetails) return;

            // الحصول على جميع أعضاء الجمعية
            const associationMembers = filterMembersByAssociation();
            const totalMembers = associationMembers.length;
            const amountPerMember = currentAssociation && currentAssociation.amount ? currentAssociation.amount : 1000;

            // 1. المبالغ المدفوعة: ما دفعه هذا العضو للأعضاء المتزوجين
            const paidByMember = getTotalPaidByMember(currentMemberDetails.id);

            // 2. المبالغ المستلمة: ما استلمه هذا العضو من الآخرين (إذا تزوج)
            const receivedByMember = getTotalReceivedByMember(currentMemberDetails.id);

            // 3. المبالغ المتبقية: عدد الأعضاء غير المتزوجين × مبلغ الجمعية
            const unmarriedMembers = associationMembers.filter(m =>
                !m.maritalStatus || m.maritalStatus === 'أعزب' || m.maritalStatus === 'تم تحديد الزواج'
            ).length;
            const remainingAmount = unmarriedMembers * amountPerMember;

            // 4. إجمالي المبالغ المطلوبة: عدد الأعضاء × مبلغ الجمعية
            const totalRequired = totalMembers * amountPerMember;

            // 5. نسبة الدفع: المدفوع من إجمالي المطلوب
            const paymentPercentage = totalRequired > 0 ? Math.round((paidByMember / totalRequired) * 100) : 0;

            // 6. حالة الاستلام
            const hasReceived = currentMemberDetails.maritalStatus === 'متزوج' || currentMemberDetails.maritalStatus === 'تزوج';

            // تحديث العرض
            document.getElementById('paidAmount').textContent = paidByMember.toLocaleString();
            document.getElementById('remainingAmount').textContent = remainingAmount.toLocaleString();
            document.getElementById('totalAmount').textContent = receivedByMember.toLocaleString();
            document.getElementById('paymentPercentage').textContent = paymentPercentage + '%';

            // تحديث حالة الاستلام
            const receiptStatusElement = document.getElementById('receiptStatus');
            const receiptStatusCard = document.getElementById('receiptStatusCard');
            if (hasReceived) {
                receiptStatusElement.textContent = '✅ استلم الجمعية';
                receiptStatusCard.style.background = 'linear-gradient(135deg, #d4edda, #c3e6cb)';
                receiptStatusCard.style.color = '#155724';
            } else {
                receiptStatusElement.textContent = '❌ لم يستلم الجمعية';
                receiptStatusCard.style.background = 'linear-gradient(135deg, #f8d7da, #f5c6cb)';
                receiptStatusCard.style.color = '#721c24';
            }

            // عرض سجل المدفوعات والمقبوضات
            const paymentHistory = document.getElementById('paymentHistory');
            const collections = JSON.parse(localStorage.getItem('associationCollections') || '[]');

            // المدفوعات التي دفعها هذا العضو
            const paidCollections = collections.filter(c =>
                c.contributorId === currentMemberDetails.id &&
                c.associationId === currentAssociation.id
            );

            // المقبوضات التي استلمها هذا العضو
            const receivedCollections = collections.filter(c =>
                c.beneficiaryId === currentMemberDetails.id &&
                c.associationId === currentAssociation.id
            );

            if (paidCollections.length === 0 && receivedCollections.length === 0) {
                paymentHistory.innerHTML = '<p style="text-align: center; color: #7f8c8d;">لا توجد معاملات مالية مسجلة</p>';
            } else {
                let html = `
                    <div style="margin-bottom: 30px;">
                        <h5 style="color: #dc3545; border-bottom: 2px solid #dc3545; padding-bottom: 10px;">
                            <i class="fas fa-arrow-up"></i> المبالغ المدفوعة للمتزوجين (${paidCollections.length})
                        </h5>
                        ${paidCollections.length > 0 ? `
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>التاريخ</th>
                                        <th>المبلغ</th>
                                        <th>المستفيد</th>
                                        <th>نوع التحويل</th>
                                        <th>البنك</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${paidCollections.map(collection => {
                                        const beneficiary = members.find(m => m.id === collection.beneficiaryId);
                                        return `
                                            <tr>
                                                <td>${new Date(collection.date).toLocaleDateString('ar-SA')}</td>
                                                <td style="color: #dc3545; font-weight: bold;">${parseFloat(collection.amount).toLocaleString()} ريال</td>
                                                <td>${beneficiary ? beneficiary.name : 'غير محدد'}</td>
                                                <td>${collection.transferType || '-'}</td>
                                                <td>${collection.bank || '-'}</td>
                                            </tr>
                                        `;
                                    }).join('')}
                                </tbody>
                            </table>
                        ` : '<p style="color: #7f8c8d; text-align: center;">لم يدفع أي مبالغ بعد</p>'}
                    </div>

                    <div>
                        <h5 style="color: #28a745; border-bottom: 2px solid #28a745; padding-bottom: 10px;">
                            <i class="fas fa-arrow-down"></i> المبالغ المستلمة من الأعضاء (${receivedCollections.length})
                        </h5>
                        ${receivedCollections.length > 0 ? `
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>التاريخ</th>
                                        <th>المبلغ</th>
                                        <th>المساهم</th>
                                        <th>نوع التحويل</th>
                                        <th>البنك</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${receivedCollections.map(collection => {
                                        const contributor = members.find(m => m.id === collection.contributorId);
                                        return `
                                            <tr>
                                                <td>${new Date(collection.date).toLocaleDateString('ar-SA')}</td>
                                                <td style="color: #28a745; font-weight: bold;">${parseFloat(collection.amount).toLocaleString()} ريال</td>
                                                <td>${contributor ? contributor.name : 'غير محدد'}</td>
                                                <td>${collection.transferType || '-'}</td>
                                                <td>${collection.bank || '-'}</td>
                                            </tr>
                                        `;
                                    }).join('')}
                                </tbody>
                            </table>
                        ` : '<p style="color: #7f8c8d; text-align: center;">لم يستلم أي مبالغ بعد</p>'}
                    </div>
                `;
                paymentHistory.innerHTML = html;
            }
        }

        function saveMemberDetails() {
            if (!currentMemberDetails) return;

            // التحقق من الصلاحيات
            if (!canAccessMemberData(currentMemberDetails.id)) {
                showAlert('ليس لديك صلاحية لتعديل بيانات هذا العضو', 'error');
                return;
            }

            // تحديث البيانات
            currentMemberDetails.name = document.getElementById('detailName').value;
            currentMemberDetails.phone = document.getElementById('detailPhone').value;
            currentMemberDetails.status = document.getElementById('detailStatus').value;
            currentMemberDetails.city = document.getElementById('detailCity').value;
            currentMemberDetails.gender = document.getElementById('detailGender').value;

            // البيانات البنكية
            currentMemberDetails.iban = document.getElementById('detailIban').value;
            currentMemberDetails.accountNumber = document.getElementById('detailAccountNumber').value;
            currentMemberDetails.bankName = document.getElementById('detailBankName').value;
            currentMemberDetails.accountHolder = document.getElementById('detailAccountHolder').value;

            // بيانات الزواج
            currentMemberDetails.maritalStatus = document.getElementById('detailMaritalStatus').value;
            currentMemberDetails.marriageDate = document.getElementById('detailMarriageDate').value;

            // حفظ التغييرات
            saveMembers();

            // تحديث العرض
            displayMembers();
            updateStats();

            // إغلاق النافذة
            closeModal('memberDetailsModal');

            showAlert('تم حفظ تفاصيل العضو بنجاح!', 'success');
        }

        function deleteAssociation(associationId) {
            if (confirm('هل أنت متأكد من حذف هذه الجمعية؟ سيتم حذف جميع الأعضاء المرتبطين بها.')) {
                associations = associations.filter(a => a.id !== associationId);
                members = members.filter(m => m.associationId !== associationId);
                collections = collections.filter(c => c.associationId !== associationId);

                if (currentAssociation && currentAssociation.id === associationId) {
                    currentAssociation = associations.length > 0 ? associations[0] : null;
                }

                saveAssociations();
                saveMembers();
                saveCollections();
                displayAssociations();
                updateStats();
                showAlert('تم حذف الجمعية بنجاح!', 'success');
            }
        }

        // دالة مزامنة بيانات الأعضاء مع المستخدمين
        function syncMembersWithUsers() {
            console.log('بدء مزامنة بيانات الأعضاء مع المستخدمين');
            
            // البحث عن الأعضاء الذين لديهم سجل مدني ولكن ليس لديهم حساب مستخدم
            const membersWithCivilId = members.filter(m => m.civilId);
            let syncCount = 0;
            
            membersWithCivilId.forEach(member => {
                const existingUser = users.find(u => u.civilId === member.civilId || u.id === member.id);
                
                if (!existingUser) {
                    // إنشاء مستخدم جديد للعضو
                    const newUser = {
                        id: member.id,
                        name: member.name,
                        role: 'member',
                        phone: member.phone,
                        civilId: member.civilId,
                        createdAt: new Date().toISOString(),
                        lastLogin: null
                    };
                    
                    users.push(newUser);
                    syncCount++;
                    console.log('تم إنشاء مستخدم جديد للعضو:', member.name);
                } else if (existingUser.civilId !== member.civilId) {
                    // تحديث السجل المدني للمستخدم الموجود
                    existingUser.civilId = member.civilId;
                    existingUser.name = member.name;
                    existingUser.phone = member.phone;
                    syncCount++;
                    console.log('تم تحديث بيانات المستخدم:', member.name);
                }
            });
            
            if (syncCount > 0) {
                saveUsers();
                console.log(`تم مزامنة ${syncCount} مستخدم`);
            } else {
                console.log('جميع البيانات متزامنة بالفعل');
            }
        }

        // وظائف توليد أرقام السجل المدني
        function generateSaudiId() {
            // توليد رقم سجل مدني سعودي صالح
            const firstDigit = Math.floor(Math.random() * 2) + 1; // 1 أو 2
            let id = firstDigit.toString();

            // إضافة 9 أرقام عشوائية
            for (let i = 0; i < 9; i++) {
                id += Math.floor(Math.random() * 10);
            }

            // حساب رقم التحقق
            let sum = 0;
            for (let i = 0; i < 9; i++) {
                const digit = parseInt(id[i]);
                if (i % 2 === 0) {
                    sum += digit;
                } else {
                    const doubled = digit * 2;
                    sum += doubled > 9 ? doubled - 9 : doubled;
                }
            }

            const checkDigit = (10 - (sum % 10)) % 10;
            id += checkDigit;

            return id;
        }

        function generateAllIds() {
            const membersWithoutIds = filterMembersByAssociation().filter(m => !m.civilId);

            if (membersWithoutIds.length === 0) {
                showAlert('جميع الأعضاء لديهم أرقام سجل مدني بالفعل', 'info');
                return;
            }

            membersWithoutIds.forEach(member => {
                let newId;
                do {
                    newId = generateSaudiId();
                } while (users.some(u => u.civilId === newId) || members.some(m => m.civilId === newId));

                member.civilId = newId;

                // التحقق من عدم وجود المستخدم مسبقاً قبل الإضافة
                const existingUser = users.find(u => u.id === member.id);
                if (!existingUser) {
                    // إضافة المستخدم إلى قائمة المستخدمين
                    users.push({
                        id: member.id,
                        name: member.name,
                        role: 'member',
                        phone: member.phone,
                        civilId: newId,
                        createdAt: new Date().toISOString(),
                        lastLogin: null
                    });
                } else {
                    // تحديث السجل المدني للمستخدم الموجود
                    existingUser.civilId = newId;
                    existingUser.name = member.name;
                    existingUser.phone = member.phone;
                }
            });

            saveMembers();
            saveUsers();
            displayIds();
            showAlert(`تم توليد ${membersWithoutIds.length} رقم سجل مدني جديد`, 'success');
            console.log('تم توليد أرقام السجل المدني وتحديث قائمة المستخدمين');
        }

        function displayIds() {
            const container = document.getElementById('idsTable');
            const membersWithIds = filterMembersByAssociation().filter(m => m.civilId);

            if (membersWithIds.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #7f8c8d;">لا توجد أرقام سجل مدني مولدة</p>';
                return;
            }

            let html = `
                <table class="table">
                    <thead>
                        <tr>
                            <th>الاسم</th>
                            <th>رقم السجل المدني</th>
                            <th>رقم الهاتف</th>
                            <th>تاريخ التسجيل</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            membersWithIds.forEach(member => {
                html += `
                    <tr>
                        <td>${member.name}</td>
                        <td><strong>${member.civilId}</strong></td>
                        <td>${member.phone}</td>
                        <td>${member.registrationDate}</td>
                    </tr>
                `;
            });

            html += '</tbody></table>';
            container.innerHTML = html;
        }

        // وظائف النسخ الاحتياطية
        function exportAllData() {
            const data = {
                associations: associations,
                members: members,
                users: users,
                collections: collections,
                terms: terms,
                exportDate: new Date().toISOString(),
                version: '1.0'
            };

            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `marriage-association-backup-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);

            // حفظ سجل النسخة الاحتياطية
            const backupRecord = {
                date: new Date().toISOString(),
                size: blob.size,
                itemsCount: {
                    associations: associations.length,
                    members: members.length,
                    users: users.length,
                    collections: collections.length
                }
            };

            let backupHistory = JSON.parse(localStorage.getItem('backupHistory') || '[]');
            backupHistory.unshift(backupRecord);
            backupHistory = backupHistory.slice(0, 10); // الاحتفاظ بآخر 10 نسخ
            localStorage.setItem('backupHistory', JSON.stringify(backupHistory));

            showAlert('تم تصدير النسخة الاحتياطية بنجاح!', 'success');
            displayBackupHistory();
        }

        function importAllData(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);

                    if (data.associations && data.members && data.users) {
                        if (confirm('هل أنت متأكد من استيراد البيانات؟ سيتم استبدال جميع البيانات الحالية.')) {
                            associations = data.associations || [];
                            members = data.members || [];
                            users = data.users || [];
                            collections = data.collections || [];
                            terms = data.terms || getDefaultTerms();

                            currentAssociation = associations.length > 0 ? associations[0] : null;

                            saveAssociations();
                            saveMembers();
                            saveUsers();
                            saveCollections();
                            saveTerms();

                            updateStats();
                            showAlert('تم استيراد البيانات بنجاح!', 'success');
                        }
                    } else {
                        showAlert('ملف البيانات غير صالح!', 'error');
                    }
                } catch (error) {
                    showAlert('خطأ في قراءة الملف!', 'error');
                }
            };
            reader.readAsText(file);
        }

        function displayBackupHistory() {
            const container = document.getElementById('backupList');
            const history = JSON.parse(localStorage.getItem('backupHistory') || '[]');

            if (history.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #7f8c8d;">لا توجد نسخ احتياطية سابقة</p>';
                return;
            }

            let html = `
                <table class="table">
                    <thead>
                        <tr>
                            <th>التاريخ</th>
                            <th>حجم الملف</th>
                            <th>عدد الجمعيات</th>
                            <th>عدد الأعضاء</th>
                            <th>عدد المستخدمين</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            history.forEach(record => {
                html += `
                    <tr>
                        <td>${new Date(record.date).toLocaleString('ar-SA')}</td>
                        <td>${(record.size / 1024).toFixed(2)} KB</td>
                        <td>${record.itemsCount.associations}</td>
                        <td>${record.itemsCount.members}</td>
                        <td>${record.itemsCount.users}</td>
                    </tr>
                `;
            });

            html += '</tbody></table>';
            container.innerHTML = html;
        }

        // وظائف مساعدة
        function showAlert(message, type) {
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.textContent = message;

            const content = document.querySelector('.content');
            const activeSection = document.querySelector('.section.active');
            content.insertBefore(alert, activeSection);

            setTimeout(() => {
                alert.remove();
            }, 5000);
        }

        function getDefaultTerms() {
            return `
                <div style="text-align: center; margin-bottom: 30px;">
                    <h2 style="color: #2c3e50; font-size: 28px; margin-bottom: 10px; text-shadow: 1px 1px 2px rgba(0,0,0,0.1);">تطبيق معاونة وجمعية الزواج</h2>
                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px; border-radius: 10px; margin: 20px 0; box-shadow: 0 4px 15px rgba(0,0,0,0.2);">
                        <h3 style="margin: 0; font-size: 20px;">بسم الله الرحمن الرحيم</h3>
                        <p style="margin: 10px 0 0 0; font-size: 16px;">الحمد لله، والصلاة والسلام على رسول الله، أما بعد:</p>
                    </div>
                </div>

                <div style="background: #f8f9fa; padding: 25px; border-radius: 12px; margin-bottom: 25px; border-right: 5px solid #3498db;">
                    <p style="font-size: 18px; line-height: 1.8; color: #2c3e50; text-align: justify;">انطلاقًا من مبدأ <strong style="color: #e74c3c;">التكافل الاجتماعي</strong>، وتعزيزًا لقيم <strong style="color: #27ae60;">التعاون والمساندة</strong> بين أبناء قبيلة آل مستنير، فقد تم إقرار نظام جمعية الزواج وفقًا للبنود التالية:</p>
                </div>

                <div style="display: grid; gap: 20px;">
                    <!-- المادة الأولى -->
                    <div style="background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); border-right: 4px solid #e74c3c;">
                        <h3 style="color: #e74c3c; margin-bottom: 15px; font-size: 20px;"><i class="fas fa-coins" style="margin-left: 10px;"></i>المادة (1): آلية المساهمة</h3>
                        <ul style="list-style: none; padding: 0;">
                            <li style="margin-bottom: 12px; padding: 10px; background: #fef9e7; border-radius: 6px; border-right: 3px solid #f39c12;">• يتم جمع مبلغ <strong style="color: #d35400;">(1000 ريال)</strong> من كل عضو عند وجود زواج مؤكد لأحد المشتركين في الجمعية.</li>
                            <li style="margin-bottom: 12px; padding: 10px; background: #eaf2f8; border-radius: 6px; border-right: 3px solid #3498db;">• لا تُجمع المبالغ بشكل شهري، بل تُطلب <strong style="color: #2980b9;">حسب الحاجة</strong>، وبشرط وجود موعد زواج رسمي.</li>
                            <li style="margin-bottom: 12px; padding: 10px; background: #fdf2e9; border-radius: 6px; border-right: 3px solid #e67e22;">• في حال وُجد أكثر من حالتي زواج خلال شهر واحد، يتم ترحيل <strong style="color: #d35400;">الزواج الثالث</strong> إلى الشهر التالي.</li>
                        </ul>
                    </div>

                    <!-- المادة الثانية -->
                    <div style="background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); border-right: 4px solid #27ae60;">
                        <h3 style="color: #27ae60; margin-bottom: 15px; font-size: 20px;"><i class="fas fa-check-circle" style="margin-left: 10px;"></i>المادة (2): شروط الاستحقاق</h3>
                        <ul style="list-style: none; padding: 0;">
                            <li style="margin-bottom: 12px; padding: 10px; background: #e8f5e8; border-radius: 6px; border-right: 3px solid #27ae60;">• يُصرف الدعم فقط عند تحديد <strong style="color: #27ae60;">موعد الزواج رسميًا</strong>.</li>
                            <li style="margin-bottom: 12px; padding: 10px; background: #ffeaa7; border-radius: 6px; border-right: 3px solid #fdcb6e;">• لا يحق للعضو الاستفادة في حال تم <strong style="color: #e17055;">تأجيل الزواج</strong> أو لم يُحدد موعده بشكل رسمي.</li>
                        </ul>
                    </div>

                    <!-- المادة الثالثة -->
                    <div style="background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); border-right: 4px solid #8e44ad;">
                        <h3 style="color: #8e44ad; margin-bottom: 15px; font-size: 20px;"><i class="fas fa-exclamation-triangle" style="margin-left: 10px;"></i>المادة (3): الالتزام المالي</h3>
                        <ul style="list-style: none; padding: 0;">
                            <li style="margin-bottom: 12px; padding: 10px; background: #f4e6ff; border-radius: 6px; border-right: 3px solid #8e44ad;">• المساهمة المالية <strong style="color: #8e44ad;">إلزامية</strong> على جميع الأعضاء دون استثناء.</li>
                            <li style="margin-bottom: 12px; padding: 10px; background: #ffe6e6; border-radius: 6px; border-right: 3px solid #e74c3c;">• لا يُقبل الامتناع عن الدفع لأي سبب، بما في ذلك <strong style="color: #c0392b;">الخلافات الشخصية</strong> أو الآراء الخاصة.</li>
                        </ul>
                    </div>

                    <!-- المادة الرابعة -->
                    <div style="background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); border-right: 4px solid #f39c12;">
                        <h3 style="color: #f39c12; margin-bottom: 15px; font-size: 20px;"><i class="fas fa-shield-alt" style="margin-left: 10px;"></i>المادة (4): الاستقلالية</h3>
                        <ul style="list-style: none; padding: 0;">
                            <li style="margin-bottom: 12px; padding: 10px; background: #fef9e7; border-radius: 6px; border-right: 3px solid #f39c12;">• الجمعية كيان <strong style="color: #d68910;">مستقل ماليًا وإداريًا</strong>.</li>
                            <li style="margin-bottom: 12px; padding: 10px; background: #fff5f5; border-radius: 6px; border-right: 3px solid #e74c3c;">• تُمنع إدخال أي <strong style="color: #c0392b;">مشاكل قبلية أو شخصية</strong> في شؤون الجمعية.</li>
                        </ul>
                    </div>

                    <!-- المادة الخامسة -->
                    <div style="background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); border-right: 4px solid #34495e;">
                        <h3 style="color: #34495e; margin-bottom: 15px; font-size: 20px;"><i class="fas fa-heart-broken" style="margin-left: 10px;"></i>المادة (5): حالات الوفاة</h3>
                        <ul style="list-style: none; padding: 0;">
                            <li style="margin-bottom: 12px; padding: 10px; background: #f8f9fa; border-radius: 6px; border-right: 3px solid #6c757d;">• في حال وفاة أحد الأعضاء، تُحصى جميع مبالغ مساهماته السابقة.</li>
                            <li style="margin-bottom: 12px; padding: 10px; background: #e8f5e8; border-radius: 6px; border-right: 3px solid #28a745;">• تُسلَّم تلك المبالغ إلى <strong style="color: #155724;">ورثته الشرعيين</strong> أو من ينوب عنهم رسميًا.</li>
                            <li style="margin-bottom: 12px; padding: 10px; background: #d1ecf1; border-radius: 6px; border-right: 3px solid #17a2b8;">• يُعفى الورثة من أي التزامات مستقبلية تجاه الجمعية.</li>
                        </ul>
                    </div>

                    <!-- المادة السادسة -->
                    <div style="background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); border-right: 4px solid #17a2b8;">
                        <h3 style="color: #17a2b8; margin-bottom: 15px; font-size: 20px;"><i class="fas fa-users-cog" style="margin-left: 10px;"></i>المادة (6): اللجنة المشرفة</h3>
                        <p style="margin-bottom: 15px; color: #495057; font-weight: bold;">تُشكّل لجنة من أبناء القبيلة تتولى المهام التالية:</p>
                        <ul style="list-style: none; padding: 0;">
                            <li style="margin-bottom: 8px; padding: 8px; background: #e3f2fd; border-radius: 6px; border-right: 3px solid #2196f3;">• تنسيق مواعيد الزواج</li>
                            <li style="margin-bottom: 8px; padding: 8px; background: #f3e5f5; border-radius: 6px; border-right: 3px solid #9c27b0;">• الإعلان عن بدء الجمعية عند وجود مناسبة زواج</li>
                            <li style="margin-bottom: 8px; padding: 8px; background: #e8f5e8; border-radius: 6px; border-right: 3px solid #4caf50;">• جمع المساهمات من الأعضاء</li>
                            <li style="margin-bottom: 8px; padding: 8px; background: #fff3e0; border-radius: 6px; border-right: 3px solid #ff9800;">• تسليم المبلغ للمستفيد</li>
                            <li style="margin-bottom: 8px; padding: 8px; background: #fce4ec; border-radius: 6px; border-right: 3px solid #e91e63;">• حفظ السجلات والتوثيقات اللازمة</li>
                            <li style="margin-bottom: 8px; padding: 8px; background: #f1f8e9; border-radius: 6px; border-right: 3px solid #8bc34a;">• حل الخلافات المرتبطة بالجمعية</li>
                        </ul>
                    </div>

                    <!-- المادة السابعة -->
                    <div style="background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); border-right: 4px solid #dc3545;">
                        <h3 style="color: #dc3545; margin-bottom: 15px; font-size: 20px;"><i class="fas fa-ban" style="margin-left: 10px;"></i>المادة (7): ضوابط الاتفاقات</h3>
                        <ul style="list-style: none; padding: 0;">
                            <li style="margin-bottom: 12px; padding: 10px; background: #f8d7da; border-radius: 6px; border-right: 3px solid #dc3545;">• يمنع إبرام أي <strong style="color: #721c24;">اتفاق خاص</strong> بين العضو والمستفيد خارج إطار اللجنة.</li>
                            <li style="margin-bottom: 12px; padding: 10px; background: #d4edda; border-radius: 6px; border-right: 3px solid #28a745;">• جميع العمليات (جمع وتسليم) تتم عبر <strong style="color: #155724;">اللجنة المشرفة فقط</strong>.</li>
                        </ul>
                    </div>

                    <!-- المادة الثامنة -->
                    <div style="background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); border-right: 4px solid #6f42c1;">
                        <h3 style="color: #6f42c1; margin-bottom: 15px; font-size: 20px;"><i class="fas fa-handshake" style="margin-left: 10px;"></i>المادة (8): آلية التسليم</h3>
                        <ul style="list-style: none; padding: 0;">
                            <li style="margin-bottom: 12px; padding: 10px; background: #f8f4ff; border-radius: 6px; border-right: 3px solid #6f42c1;">• يُسلَّم المبلغ المستحق بالتزامن مع <strong style="color: #6f42c1;">معونة القبيلة المعتادة</strong>.</li>
                            <li style="margin-bottom: 12px; padding: 10px; background: #e7f3ff; border-radius: 6px; border-right: 3px solid #007bff;">• لا يُشترط إقامة <strong style="color: #0056b3;">زامل خاص</strong> للمستفيد.</li>
                        </ul>
                    </div>

                    <!-- المادة التاسعة -->
                    <div style="background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); border-right: 4px solid #20c997;">
                        <h3 style="color: #20c997; margin-bottom: 15px; font-size: 20px;"><i class="fas fa-gavel" style="margin-left: 10px;"></i>المادة (9): الأحكام الختامية</h3>
                        <ul style="list-style: none; padding: 0;">
                            <li style="margin-bottom: 12px; padding: 10px; background: #d1f2eb; border-radius: 6px; border-right: 3px solid #20c997;">• يبدأ العمل بهذا النظام اعتبارًا من <strong style="color: #0c5460;">تاريخ توقيعه من قِبل الأعضاء</strong>.</li>
                            <li style="margin-bottom: 12px; padding: 10px; background: #fff2cc; border-radius: 6px; border-right: 3px solid #ffc107;">• يُعد توقيع العضو إقرارًا بـ<strong style="color: #856404;">الالتزام الكامل</strong> بكافة بنود الاتفاقية.</li>
                            <li style="margin-bottom: 12px; padding: 10px; background: #e2e3e5; border-radius: 6px; border-right: 3px solid #6c757d;">• يُمكن تعديل هذه البنود بموافقة <strong style="color: #495057;">أغلبية الأعضاء</strong>.</li>
                        </ul>
                    </div>
                </div>


            `;
        }

        // وظائف الكشوفات والتقارير المحدثة
        function updateReportsSection() {
            const currentAssociationInfo = document.getElementById('currentAssociationInfo');
            const noAssociationAlert = document.getElementById('noAssociationAlert');
            const reportsContent = document.getElementById('reportsContent');

            if (!currentAssociation) {
                // لا توجد جمعية محددة
                currentAssociationInfo.style.display = 'none';
                noAssociationAlert.style.display = 'block';
                reportsContent.style.display = 'none';
                return;
            }

            // عرض معلومات الجمعية الحالية
            noAssociationAlert.style.display = 'none';
            reportsContent.style.display = 'block';

            const isCooperation = currentAssociation.type === 'cooperation';
            currentAssociationInfo.className = `current-association-info ${isCooperation ? 'cooperation-info' : ''}`;
            currentAssociationInfo.innerHTML = `
                <h3>${isCooperation ? 'المعاونة' : 'الجمعية'}: ${currentAssociation.name}</h3>
                <p>النوع: ${isCooperation ? 'معاونة' : 'جمعية زواج'} |
                   ${isCooperation ? 'مبالغ حرة' : `المبلغ الثابت: ${currentAssociation.amount ? currentAssociation.amount.toLocaleString() : '0'} ريال`}</p>
            `;

            // تحديث الإحصائيات
            updateReportsStats(isCooperation);

            // تحديث أزرار التقارير
            updateReportButtons(isCooperation);
        }

        function updateReportsStats(isCooperation) {
            const associationMembers = filterMembersByAssociation();
            const statsGrid = document.getElementById('reportsStatsGrid');

            if (isCooperation) {
                // إحصائيات المعاونة
                const totalMembers = associationMembers.length;
                const contributors = associationMembers.filter(m => m.amount && parseFloat(m.amount) > 0).length;
                const nonContributors = totalMembers - contributors;
                const totalAmount = associationMembers.reduce((sum, m) => sum + (parseFloat(m.amount) || 0), 0);

                statsGrid.innerHTML = `
                    <div class="stat-card">
                        <div class="stat-number">${totalMembers}</div>
                        <div class="stat-label">إجمالي الأعضاء</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${contributors}</div>
                        <div class="stat-label">المساهمون</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${nonContributors}</div>
                        <div class="stat-label">غير المساهمين</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${totalAmount.toLocaleString()}</div>
                        <div class="stat-label">إجمالي المبالغ (ريال)</div>
                    </div>
                `;
            } else {
                // إحصائيات الجمعية
                const totalMembers = associationMembers.length;
                const marriedMembers = associationMembers.filter(m => m.maritalStatus === 'متزوج' || m.maritalStatus === 'تزوج').length;
                const scheduledMembers = associationMembers.filter(m => m.maritalStatus === 'تم تحديد الزواج').length;
                const singleMembers = associationMembers.filter(m => m.maritalStatus === 'أعزب' || !m.maritalStatus).length;

                // حساب إجمالي التحصيل من النظام الجديد
                const allCollections = JSON.parse(localStorage.getItem('associationCollections') || '[]');
                const associationCollections = allCollections.filter(c => c.associationId === currentAssociation.id);
                const totalCollected = associationCollections.reduce((sum, c) => sum + (parseFloat(c.amount) || 0), 0);

                // حساب عدد المستفيدين (الذين لديهم تحصيل)
                const beneficiaries = [...new Set(associationCollections.map(c => c.beneficiaryId))].length;

                statsGrid.innerHTML = `
                    <div class="stat-card">
                        <div class="stat-number">${totalMembers}</div>
                        <div class="stat-label">إجمالي الأعضاء</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${marriedMembers}</div>
                        <div class="stat-label">المتزوجون</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${scheduledMembers}</div>
                        <div class="stat-label">تم تحديد زواجهم</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${singleMembers}</div>
                        <div class="stat-label">لم يتزوجوا</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${beneficiaries}</div>
                        <div class="stat-label">المستفيدون</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${totalCollected.toLocaleString()}</div>
                        <div class="stat-label">إجمالي المحصل (ريال)</div>
                    </div>
                `;
            }
        }

        function updateReportButtons(isCooperation) {
            const reportButtons = document.getElementById('reportButtons');

            if (isCooperation) {
                // أزرار تقارير المعاونة
                reportButtons.innerHTML = `
                    <button class="btn btn-primary" onclick="generateCooperationMembersReport()">
                        <i class="fas fa-users"></i> كشف أعضاء المعاونة
                    </button>
                    <button class="btn btn-primary" onclick="generateCooperationFinancialReport()">
                        <i class="fas fa-money-bill-wave"></i> التقرير المالي للمعاونة
                    </button>
                    <button class="btn" onclick="printReport()">
                        <i class="fas fa-print"></i> طباعة التقرير
                    </button>
                `;
            } else {
                // أزرار تقارير الجمعية
                reportButtons.innerHTML = `
                    <button class="btn btn-primary" onclick="generateAssociationMembersReport()">
                        <i class="fas fa-users"></i> كشف أعضاء الجمعية
                    </button>
                    <button class="btn btn-primary" onclick="generateAssociationFinancialReport()">
                        <i class="fas fa-money-bill-wave"></i> التقرير المالي
                    </button>
                    <button class="btn btn-primary" onclick="showMarriageReportSelection()">
                        <i class="fas fa-heart"></i> تقرير الزواج
                    </button>
                    <button class="btn btn-success" onclick="generateComprehensiveMarriageReport()">
                        <i class="fas fa-chart-line"></i> التقرير الشامل المطور
                    </button>
                    <button class="btn" onclick="printReport()">
                        <i class="fas fa-print"></i> طباعة التقرير
                    </button>
                `;
            }
        }

        // وظائف توليد التقارير للمعاونات
        function generateCooperationMembersReport() {
            if (!currentAssociation || currentAssociation.type !== 'cooperation') return;

            const associationMembers = filterMembersByAssociation();
            const reportDate = new Date().toLocaleDateString('ar-SA');

            let html = `
                <table style="width: 100%; font-size: 11px;">
                    <thead>
                        <tr>
                            <th style="width: 5%;">م</th>
                            <th style="width: 25%;">الاسم الكامل</th>
                            <th style="width: 12%;">الهاتف</th>
                            <th style="width: 10%;">المبلغ</th>
                            <th style="width: 15%;">نوع التحويل</th>
                            <th style="width: 13%;">البنك</th>
                            <th style="width: 15%;">المستلم</th>
                            <th style="width: 5%;">الحالة</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            associationMembers.forEach((member, index) => {
                const hasContribution = member.amount && parseFloat(member.amount) > 0;
                const statusIcon = hasContribution ? '✓' : '✗';
                const statusColor = hasContribution ? 'color: #27ae60;' : 'color: #e74c3c;';

                html += `
                    <tr style="font-size: 10px;">
                        <td style="text-align: center; font-weight: bold;">${index + 1}</td>
                        <td style="font-weight: 600;">${member.name}</td>
                        <td style="text-align: center;">${member.phone || '-'}</td>
                        <td style="text-align: center; font-weight: bold;">${hasContribution ? parseFloat(member.amount).toLocaleString() : '-'}</td>
                        <td style="text-align: center;">${member.transferType || 'نقداً'}</td>
                        <td style="text-align: center;">${member.bank || '-'}</td>
                        <td style="text-align: center;">${member.receiver || '-'}</td>
                        <td style="text-align: center; font-weight: bold; ${statusColor}">${statusIcon}</td>
                    </tr>
                `;
            });

            html += `
                        </tbody>
                    </table>
            `;

            document.getElementById('reportContent').innerHTML = html;
        }

        function generateCooperationFinancialReport() {
            if (!currentAssociation || currentAssociation.type !== 'cooperation') return;

            const associationMembers = filterMembersByAssociation();
            const contributors = associationMembers.filter(m => m.amount && parseFloat(m.amount) > 0);
            const reportDate = new Date().toLocaleDateString('ar-SA');

            // حساب الإجماليات
            const totalContributors = contributors.length;
            const totalAmount = contributors.reduce((sum, m) => sum + (parseFloat(m.amount) || 0), 0);

            // تجميع البيانات حسب المستلم والبنك
            const receiverStats = {};
            const bankStats = {};

            contributors.forEach(member => {
                const receiver = member.receiver || 'غير محدد';
                const amount = parseFloat(member.amount) || 0;

                receiverStats[receiver] = (receiverStats[receiver] || 0) + amount;

                if (member.transferType !== 'نقداً' && member.bank) {
                    bankStats[member.bank] = (bankStats[member.bank] || 0) + amount;
                }
            });

            let html = `
                    <div class="report-section">
                        <h3>ملخص المساهمات</h3>
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>الاسم</th>
                                    <th>المبلغ</th>
                                    <th>نوع التحويل</th>
                                    <th>البنك</th>
                                    <th>المستلم</th>
                                </tr>
                            </thead>
                            <tbody>
            `;

            contributors.forEach(member => {
                html += `
                    <tr>
                        <td>${member.name}</td>
                        <td>${parseFloat(member.amount).toLocaleString()} ريال</td>
                        <td>${member.transferType || 'نقداً'}</td>
                        <td>${member.bank || '-'}</td>
                        <td>${member.receiver || 'غير محدد'}</td>
                    </tr>
                `;
            });

            html += `
                            </tbody>
                        </table>
                    </div>

                    <div class="report-section">
                        <h3>توزيع المبالغ حسب المستلم</h3>
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>المستلم</th>
                                    <th>المبلغ</th>
                                </tr>
                            </thead>
                            <tbody>
            `;

            Object.keys(receiverStats).forEach(receiver => {
                html += `
                    <tr>
                        <td>${receiver}</td>
                        <td>${receiverStats[receiver].toLocaleString()} ريال</td>
                    </tr>
                `;
            });

            html += `
                            </tbody>
                        </table>
                    </div>
            `;

            if (Object.keys(bankStats).length > 0) {
                html += `
                    <div class="report-section">
                        <h3>توزيع المبالغ حسب البنك</h3>
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>البنك</th>
                                    <th>المبلغ</th>
                                </tr>
                            </thead>
                            <tbody>
                `;

                Object.keys(bankStats).forEach(bank => {
                    html += `
                        <tr>
                            <td>${bank}</td>
                            <td>${bankStats[bank].toLocaleString()} ريال</td>
                        </tr>
                    `;
                });

                html += `
                            </tbody>
                        </table>
                    </div>
                `;
            }

            html += `
                </div>
            `;

            document.getElementById('reportContent').innerHTML = html;
        }

        // وظائف توليد التقارير للجمعيات
        function generateAssociationMembersReport() {
            if (!currentAssociation || currentAssociation.type === 'cooperation') return;

            const associationMembers = filterMembersByAssociation();

            // حساب الإحصائيات المتزامنة
            const marriedCount = associationMembers.filter(m => m.maritalStatus === 'متزوج' || m.maritalStatus === 'تزوج').length;
            const scheduledCount = associationMembers.filter(m => m.maritalStatus === 'تم تحديد الزواج').length;
            const singleCount = associationMembers.filter(m => !m.maritalStatus || m.maritalStatus === 'أعزب').length;
            const reportDate = new Date().toLocaleDateString('ar-SA');

            let html = `
                <div class="print-area">

                <table style="width: 100%; font-size: 11px; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                    <thead>
                        <tr style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                            <th style="width: 4%; padding: 12px; text-align: center; border: 1px solid #ddd;">م</th>
                            <th style="width: 20%; padding: 12px; border: 1px solid #ddd;">الاسم الكامل</th>
                            <th style="width: 12%; padding: 12px; text-align: center; border: 1px solid #ddd;">رقم الجوال</th>
                            <th style="width: 12%; padding: 12px; text-align: center; border: 1px solid #ddd;">رقم الحساب</th>
                            <th style="width: 12%; padding: 12px; text-align: center; border: 1px solid #ddd;">اسم البنك</th>
                            <th style="width: 12%; padding: 12px; text-align: center; border: 1px solid #ddd;">حالة الزواج</th>
                            <th style="width: 10%; padding: 12px; text-align: center; border: 1px solid #ddd;">تاريخ الزواج</th>
                            <th style="width: 10%; padding: 12px; text-align: center; border: 1px solid #ddd;">المتبقي على الزواج</th>
                            <th style="width: 8%; padding: 12px; text-align: center; border: 1px solid #ddd;">المبلغ</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            // ترتيب الأعضاء: المتزوجون أولاً، ثم المقرر زواجهم، ثم الباقي
            const sortedMembers = associationMembers.sort((a, b) => {
                const aStatus = a.maritalStatus || 'أعزب';
                const bStatus = b.maritalStatus || 'أعزب';

                // ترتيب الأولوية: متزوج/تزوج = 1, تم تحديد الزواج = 2, أعزب = 3
                const getStatusPriority = (status) => {
                    if (status === 'متزوج' || status === 'تزوج') return 1;
                    if (status === 'تم تحديد الزواج') return 2;
                    return 3;
                };

                const aPriority = getStatusPriority(aStatus);
                const bPriority = getStatusPriority(bStatus);

                if (aPriority !== bPriority) {
                    return aPriority - bPriority;
                }

                // إذا كانت نفس الحالة، رتب حسب تاريخ الزواج
                if (a.marriageDate && b.marriageDate) {
                    return new Date(a.marriageDate) - new Date(b.marriageDate);
                }

                return 0;
            });

            sortedMembers.forEach((member, index) => {
                const maritalStatusColor = (member.maritalStatus === 'متزوج' || member.maritalStatus === 'تزوج') ? 'color: #27ae60; font-weight: bold;' :
                                         member.maritalStatus === 'تم تحديد الزواج' ? 'color: #f39c12; font-weight: bold;' :
                                         'color: #e74c3c;';

                // حساب تاريخ الزواج والمتبقي
                let marriageDate = '-';
                let remainingTime = '-';

                if (member.marriageDate) {
                    marriageDate = new Date(member.marriageDate).toLocaleDateString('ar-SA');

                    if (member.maritalStatus === 'تم تحديد الزواج') {
                        const today = new Date();
                        const weddingDate = new Date(member.marriageDate);
                        const timeDiff = weddingDate.getTime() - today.getTime();
                        const daysDiff = Math.ceil(timeDiff / (1000 * 3600 * 24));

                        if (daysDiff > 0) {
                            remainingTime = `${daysDiff} يوم`;
                        } else if (daysDiff === 0) {
                            remainingTime = 'اليوم';
                        } else {
                            remainingTime = `تأخر ${Math.abs(daysDiff)} يوم`;
                        }
                    }
                }

                // تحديد لون الخلفية حسب الحالة
                const rowBgColor = (member.maritalStatus === 'متزوج' || member.maritalStatus === 'تزوج') ? '#e8f5e8' :
                                  member.maritalStatus === 'تم تحديد الزواج' ? '#fff3cd' :
                                  '#f8f9fa';

                // تحديد لون المتبقي على الزواج
                let remainingTimeColor = '#6c757d';
                if (member.maritalStatus === 'تم تحديد الزواج' && member.marriageDate) {
                    const today = new Date();
                    const weddingDate = new Date(member.marriageDate);
                    const daysDiff = Math.ceil((weddingDate.getTime() - today.getTime()) / (1000 * 3600 * 24));

                    if (daysDiff <= 7 && daysDiff > 0) {
                        remainingTimeColor = '#dc3545'; // أحمر للأسبوع الأخير
                    } else if (daysDiff <= 30 && daysDiff > 0) {
                        remainingTimeColor = '#ffc107'; // أصفر للشهر الأخير
                    }
                }

                html += `
                    <tr style="font-size: 11px; background: ${rowBgColor};">
                        <td style="text-align: center; font-weight: bold; padding: 8px; border: 1px solid #ddd;">${index + 1}</td>
                        <td style="font-weight: 600; padding: 8px; border: 1px solid #ddd;">${member.name}</td>
                        <td style="text-align: center; padding: 8px; border: 1px solid #ddd;">${member.phone || '-'}</td>
                        <td style="text-align: center; padding: 8px; border: 1px solid #ddd;">${member.accountNumber || '-'}</td>
                        <td style="text-align: center; padding: 8px; border: 1px solid #ddd;">${member.bankName || '-'}</td>
                        <td style="text-align: center; ${maritalStatusColor} padding: 8px; border: 1px solid #ddd;">${member.maritalStatus || 'أعزب'}</td>
                        <td style="text-align: center; padding: 8px; border: 1px solid #ddd;">${marriageDate}</td>
                        <td style="text-align: center; color: ${remainingTimeColor}; font-weight: bold; padding: 8px; border: 1px solid #ddd;">${remainingTime}</td>
                        <td style="text-align: center; font-weight: bold; padding: 8px; border: 1px solid #ddd;">${member.amount ? member.amount.toLocaleString() : '0'} ريال</td>
                    </tr>
                `;
            });

            html += `
                        </tbody>
                    </table>
                </div>
            `;

            document.getElementById('reportContent').innerHTML = html;
        }

        function generateAssociationFinancialReport() {
            if (!currentAssociation || currentAssociation.type === 'cooperation') return;

            const allCollections = JSON.parse(localStorage.getItem('associationCollections') || '[]');
            const associationCollections = allCollections.filter(c => c.associationId === currentAssociation.id);
            const associationMembers = filterMembersByAssociation();
            const reportDate = new Date().toLocaleDateString('ar-SA');

            // تحديد الأعضاء المتزوجين أو الذين تم تحديد زواجهم (المؤهلين للتحصيل)
            const marriedMembers = associationMembers.filter(m => {
                const hasMarriageDate = m.maritalStatus === 'متزوج' || m.maritalStatus === 'تزوج' || m.maritalStatus === 'تم تحديد الزواج';
                const hasCollection = getTotalCollectionForBeneficiary(m.id) > 0;
                return hasMarriageDate || hasCollection;
            });

            // حساب الإحصائيات المالية للأعضاء المتزوجين فقط
            const totalEligibleMembers = marriedMembers.length;
            const fixedAmount = currentAssociation.amount || 0;
            
            // حساب إجمالي المحصل والمطلوب للأعضاء المتزوجين فقط
            let totalCollected = 0;
            let totalExpected = 0;
            let totalBeneficiaries = 0;
            
            marriedMembers.forEach(member => {
                const memberCollected = getTotalCollectionForBeneficiary(member.id);
                if (memberCollected > 0) {
                    totalCollected += memberCollected;
                    totalBeneficiaries++;
                }
                // حساب المطلوب لكل عضو متزوج (عدد الأعضاء الكلي × المبلغ الثابت)
                totalExpected += associationMembers.length * fixedAmount;
            });
            
            const totalRemaining = totalExpected - totalCollected;
            const collectionPercentage = totalExpected > 0 ? ((totalCollected / totalExpected) * 100).toFixed(1) : 0;
            
            // إحصائيات المساهمين (فقط للأعضاء المتزوجين)
            const marriedMemberIds = marriedMembers.map(m => m.id);
            const marriedCollections = associationCollections.filter(c => marriedMemberIds.includes(c.beneficiaryId));
            
            const contributors = [...new Set(marriedCollections.filter(c => parseFloat(c.amount) > 0).map(c => c.contributorId))];
            const totalContributors = contributors.length;
            const nonContributors = associationMembers.length - totalContributors;
            
            // إحصائيات المعاملات (فقط للأعضاء المتزوجين)
            const totalTransactions = marriedCollections.filter(c => parseFloat(c.amount) > 0).length;
            
            // إحصائيات طرق الدفع (فقط للأعضاء المتزوجين)
            const paymentMethods = {};
            marriedCollections.forEach(collection => {
                if (parseFloat(collection.amount) > 0) {
                    const method = collection.transferType || 'نقداً';
                    paymentMethods[method] = (paymentMethods[method] || 0) + parseFloat(collection.amount);
                }
            });

            let html = `
                <div class="print-area">
                    <div style="text-align: center; margin-bottom: 8px;">
                        <h2 style="margin-bottom: 5px; color: #2c3e50; font-size: 1.2rem;">📊 التقرير المالي الإحصائي</h2>
                        <h3 style="margin: 0; color: #34495e; font-size: 1rem;">${currentAssociation.name}</h3>
                    </div>
                    
                    <!-- الإحصائيات الرئيسية -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 8px; margin-bottom: 10px;">
                        <div style="background: linear-gradient(135deg, #3498db, #2980b9); color: white; padding: 8px; border-radius: 6px; text-align: center;">
                            <div style="font-size: 1.3rem; font-weight: bold; margin-bottom: 2px;">${totalEligibleMembers}</div>
                            <div style="font-size: 0.7rem;">الأعضاء المتزوجين</div>
                        </div>
                        <div style="background: linear-gradient(135deg, #27ae60, #229954); color: white; padding: 8px; border-radius: 6px; text-align: center;">
                            <div style="font-size: 1.3rem; font-weight: bold; margin-bottom: 2px;">${totalCollected.toLocaleString()}</div>
                            <div style="font-size: 0.7rem;">إجمالي المحصل (ريال)</div>
                        </div>
                        <div style="background: linear-gradient(135deg, #e74c3c, #c0392b); color: white; padding: 8px; border-radius: 6px; text-align: center;">
                            <div style="font-size: 1.3rem; font-weight: bold; margin-bottom: 2px;">${totalRemaining.toLocaleString()}</div>
                            <div style="font-size: 0.7rem;">إجمالي المتبقي (ريال)</div>
                        </div>
                        <div style="background: linear-gradient(135deg, #f39c12, #e67e22); color: white; padding: 8px; border-radius: 6px; text-align: center;">
                            <div style="font-size: 1.3rem; font-weight: bold; margin-bottom: 2px;">${collectionPercentage}%</div>
                            <div style="font-size: 0.7rem;">نسبة التحصيل</div>
                        </div>
                    </div>
                    
                    <!-- إحصائيات تفصيلية -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 10px;">
                        <!-- إحصائيات الأعضاء -->
                        <div style="background: #f8f9fa; padding: 8px; border-radius: 6px; border: 1px solid #dee2e6;">
                            <h4 style="margin-bottom: 6px; color: #495057; text-align: center; font-size: 0.8rem;">📈 إحصائيات الأعضاء</h4>
                            <div style="margin-bottom: 3px; font-size: 0.7rem;"><strong>المساهمون:</strong> ${totalContributors} عضو</div>
                            <div style="margin-bottom: 3px; font-size: 0.7rem;"><strong>غير المساهمين:</strong> ${nonContributors} عضو</div>
                            <div style="margin-bottom: 3px; font-size: 0.7rem;"><strong>المستفيدون:</strong> ${totalBeneficiaries} عضو</div>
                            <div style="margin-bottom: 3px; font-size: 0.7rem;"><strong>إجمالي الأعضاء:</strong> ${associationMembers.length} عضو</div>
                            <div style="font-size: 0.7rem;"><strong>إجمالي المعاملات:</strong> ${totalTransactions} معاملة</div>
                        </div>
                        
                        <!-- إحصائيات المبالغ -->
                        <div style="background: #f8f9fa; padding: 8px; border-radius: 6px; border: 1px solid #dee2e6;">
                            <h4 style="margin-bottom: 6px; color: #495057; text-align: center; font-size: 0.8rem;">💰 إحصائيات المبالغ</h4>
                            <div style="margin-bottom: 3px; font-size: 0.7rem;"><strong>المبلغ المطلوب:</strong> ${totalExpected.toLocaleString()} ريال</div>
                            <div style="margin-bottom: 3px; font-size: 0.7rem;"><strong>المبلغ المحصل:</strong> ${totalCollected.toLocaleString()} ريال</div>
                            <div style="margin-bottom: 3px; font-size: 0.7rem;"><strong>المبلغ المتبقي:</strong> ${totalRemaining.toLocaleString()} ريال</div>
                            <div style="font-size: 0.7rem;"><strong>متوسط المساهمة:</strong> ${totalContributors > 0 ? (totalCollected / totalContributors).toLocaleString() : 0} ريال</div>
                        </div>
                    </div>`;
                    
            // إحصائيات طرق الدفع
            if (Object.keys(paymentMethods).length > 0) {
                html += `
                    <div style="background: #f8f9fa; padding: 8px; border-radius: 6px; border: 1px solid #dee2e6; margin-bottom: 8px;">
                        <h4 style="margin-bottom: 6px; color: #495057; text-align: center; font-size: 0.8rem;">💳 توزيع طرق الدفع</h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 6px;">`;
                        
                Object.entries(paymentMethods).forEach(([method, amount]) => {
                    const percentage = ((amount / totalCollected) * 100).toFixed(1);
                    html += `
                        <div style="text-align: center; padding: 6px; background: white; border-radius: 4px;">
                            <div style="font-weight: bold; color: #2c3e50; font-size: 0.7rem;">${method}</div>
                            <div style="color: #27ae60; font-size: 0.65rem;">${amount.toLocaleString()} ريال</div>
                            <div style="color: #7f8c8d; font-size: 0.6rem;">${percentage}%</div>
                        </div>`;
                });
                
                html += `
                        </div>
                    </div>`;
            }
            
            // ملخص الوضع المالي
            html += `
                    <div style="background: linear-gradient(135deg, #ecf0f1, #bdc3c7); padding: 8px; border-radius: 6px; text-align: center; margin-bottom: 8px;">
                        <h4 style="margin-bottom: 4px; color: #2c3e50; font-size: 0.8rem;">📋 ملخص الوضع المالي</h4>
                        <p style="margin-bottom: 3px; font-size: 0.8rem;"><strong>الوضع العام:</strong> 
                            <span style="color: ${collectionPercentage >= 100 ? '#27ae60' : collectionPercentage >= 75 ? '#f39c12' : '#e74c3c'}; font-weight: bold;">
                                ${collectionPercentage >= 100 ? 'مكتمل' : collectionPercentage >= 75 ? 'جيد' : collectionPercentage >= 50 ? 'متوسط' : 'ضعيف'}
                            </span>
                        </p>
                        <p style="margin: 0; color: #7f8c8d; font-size: 0.7rem;">تم تحصيل ${collectionPercentage}% من إجمالي المبلغ المطلوب</p>
                    </div>
                    
                    <!-- فوتر التطبيق -->
                    <div style="border-top: 1px solid #dee2e6; padding: 6px 0; margin-top: 8px; text-align: center; background: #f8f9fa; border-radius: 6px;">
                        <div style="display: flex; justify-content: center; align-items: center; gap: 10px; font-size: 0.7rem; color: #495057;">
                            <div style="display: flex; align-items: center; gap: 3px;">
                                <span style="font-weight: bold;">تطبيق جمعية ومعونة الزواج</span>
                            </div>
                            <div style="border-left: 1px solid #dee2e6; padding-left: 10px; display: flex; align-items: center; gap: 3px;">
                                <span>إعداد وتصميم: الأستاذ / ناصر مسعود آل مستنير</span>
                            </div>
                            <div style="border-left: 1px solid #dee2e6; padding-left: 10px; display: flex; align-items: center; gap: 3px;">
                                <span style="font-size: 0.8rem;">📞</span>
                                <span style="font-weight: bold; color: #007bff;">0505723776</span>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            document.getElementById('reportContent').innerHTML = html;
        }

        // دالة عرض قائمة اختيار الأعضاء لتقرير الزواج
        function showMarriageReportSelection() {
            if (!currentAssociation || currentAssociation.type === 'cooperation') return;

            const associationMembers = filterMembersByAssociation();
            // الأعضاء الذين لديهم تواريخ زواج أو تم تحصيل مبالغ لهم
            const eligibleMembers = associationMembers.filter(m => {
                const hasMarriageDate = m.maritalStatus === 'متزوج' || m.maritalStatus === 'تزوج' || m.maritalStatus === 'تم تحديد الزواج';
                const hasCollection = getTotalCollectionForBeneficiary(m.id) > 0;
                return hasMarriageDate || hasCollection;
            });

            if (eligibleMembers.length === 0) {
                showAlert('لا توجد أعضاء مؤهلين لتقرير الزواج', 'warning');
                return;
            }

            let html = `
                <div class="print-area">
                    <div style="text-align: center; margin-bottom: 30px;">
                        <h2 style="font-size: 1.5rem; margin-bottom: 10px;">اختيار عضو لتقرير الزواج</h2>
                        <h3 style="font-size: 1.2rem; margin-bottom: 20px;">${currentAssociation.name}</h3>
                    </div>

                    <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                        <h3 style="font-size: 1.1rem; margin-bottom: 15px; text-align: center;">اختر العضو:</h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 15px;">
            `;

            eligibleMembers.forEach(member => {
                const totalCollected = getTotalCollectionForBeneficiary(member.id);
                const statusColor = (member.maritalStatus === 'متزوج' || member.maritalStatus === 'تزوج') ? '#28a745' : '#ffc107';
                const marriageDate = member.marriageDate ? new Date(member.marriageDate).toLocaleDateString('ar-SA') : '-';

                html += `
                    <div style="background: white; padding: 15px; border-radius: 8px; border: 2px solid ${statusColor}; cursor: pointer; transition: all 0.3s ease;"
                         onclick="generateIndividualMarriageReport('${member.id}')"
                         onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.15)'"
                         onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 4px rgba(0,0,0,0.1)'">
                        <h4 style="margin: 0 0 10px 0; color: ${statusColor}; font-size: 1rem;">${member.name}</h4>
                        <p style="margin: 5px 0; font-size: 0.9rem; color: #6c757d;">الحالة: ${member.maritalStatus || 'أعزب'}</p>
                        <p style="margin: 5px 0; font-size: 0.9rem; color: #6c757d;">التاريخ: ${marriageDate}</p>
                        <p style="margin: 5px 0; font-size: 0.9rem; color: #6c757d;">المحصل: ${totalCollected.toLocaleString()} ريال</p>
                    </div>
                `;
            });

            html += `
                        </div>
                    </div>
                </div>
            `;

            document.getElementById('reportContent').innerHTML = html;
        }

        // دالة إنشاء تقرير فردي للعضو
        function generateIndividualMarriageReport(memberId) {
            const member = members.find(m => m.id === memberId);
            if (!member) return;

            const reportDate = new Date().toLocaleDateString('ar-SA');
            const allCollections = JSON.parse(localStorage.getItem('associationCollections') || '[]');
            const memberCollections = allCollections.filter(c =>
                c.beneficiaryId === memberId &&
                c.associationId === currentAssociation.id &&
                parseFloat(c.amount) > 0
            );

            const associationMembers = filterMembersByAssociation();
            const totalCollected = getTotalCollectionForBeneficiary(memberId);
            const fixedAmount = currentAssociation.amount || 0;
            const totalExpected = associationMembers.length * fixedAmount;
            const remaining = totalExpected - totalCollected;
            const marriageDate = member.marriageDate ? new Date(member.marriageDate).toLocaleDateString('ar-SA') : '-';

            // تحديد الأعضاء المساهمين وغير المساهمين
            const contributors = [];
            const nonContributors = [];

            associationMembers.forEach(m => {
                const contribution = memberCollections.find(c => c.contributorId === m.id);
                if (contribution && parseFloat(contribution.amount) > 0) {
                    contributors.push({...m, contribution});
                } else {
                    nonContributors.push(m);
                }
            });

            let html = `
                <div class="print-area">
                    <!-- ترويسة مضغوطة بنفس التصميم المطلوب -->
                    <div style="border: 2px solid #333; border-radius: 12px; padding: 15px; margin-bottom: 20px; background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);">
                        <div style="text-align: center; margin-bottom: 12px;">
                            <h2 style="margin: 0; font-size: 1.1rem; color: #2c3e50; font-weight: 600;">${currentAssociation.name} - تقرير زواج (${member.name})</h2>
                        </div>

                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(80px, 1fr)); gap: 8px; text-align: center; font-size: 0.85rem; color: #495057;">
                            <div>
                                <div style="font-weight: bold; color: #6f42c1;">${reportDate}</div>
                                <div style="font-size: 0.75rem; color: #6c757d;">تاريخ طباعة التقرير</div>
                            </div>
                            <div>
                                <div style="font-weight: bold; color: #28a745;">${marriageDate}</div>
                                <div style="font-size: 0.75rem; color: #6c757d;">تاريخ الزواج</div>
                            </div>
                            <div>
                                <div style="font-weight: bold; color: #6f42c1;">${member.maritalStatus || 'أعزب'}</div>
                                <div style="font-size: 0.75rem; color: #6c757d;">الحالة</div>
                            </div>
                            <div>
                                <div style="font-weight: bold; color: #28a745;">${contributors.length}</div>
                                <div style="font-size: 0.75rem; color: #6c757d;">ساهموا</div>
                            </div>
                            <div>
                                <div style="font-weight: bold; color: #ffc107;">${nonContributors.length}</div>
                                <div style="font-size: 0.75rem; color: #6c757d;">لم يساهموا</div>
                            </div>
                            <div>
                                <div style="font-weight: bold; color: #17a2b8;">${totalCollected.toLocaleString()}</div>
                                <div style="font-size: 0.75rem; color: #6c757d;">محصل</div>
                            </div>
                            <div>
                                <div style="font-weight: bold; color: ${remaining > 0 ? '#dc3545' : '#28a745'};">${remaining.toLocaleString()}</div>
                                <div style="font-size: 0.75rem; color: #6c757d;">متبقي</div>
                            </div>
                            <div>
                                <div style="font-weight: bold; color: #007bff;">${totalExpected.toLocaleString()}</div>
                                <div style="font-size: 0.75rem; color: #6c757d;">من ${totalExpected.toLocaleString()}</div>
                            </div>
                        </div>
                    </div>
            `;

            // جدول المساهمين
            html += `
                <div style="margin-bottom: 20px;">
                    <h3 style="margin-bottom: 15px; color: #28a745;">💰 المساهمون (${contributors.length})</h3>
                    <table style="width: 100%; border-collapse: collapse; font-size: 0.8rem; line-height: 1.3; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                        <thead>
                            <tr style="background: linear-gradient(135deg, #28a745, #20c997); color: white;">
                                <th style="border: 1px solid #adb5bd; padding: 6px; text-align: center; width: 4%;">م</th>
                                <th style="border: 1px solid #adb5bd; padding: 6px; width: 18%;">اسم العضو</th>
                                <th style="border: 1px solid #adb5bd; padding: 6px; text-align: center; width: 8%;">المبلغ</th>
                                <th style="border: 1px solid #adb5bd; padding: 6px; text-align: center; width: 12%;">نوع التحويل</th>
                                <th style="border: 1px solid #adb5bd; padding: 6px; text-align: center; width: 10%;">البنك</th>
                                <th style="border: 1px solid #adb5bd; padding: 6px; text-align: center; width: 12%;">المستلم</th>
                                <th style="border: 1px solid #adb5bd; padding: 6px; width: 36%;">الملاحظات</th>
                            </tr>
                        </thead>
                        <tbody>`;

            // عرض المساهمين
            contributors.forEach((contributor, index) => {
                const collection = contributor.contribution;
                const contributorNotes = collection.notes && collection.notes.trim() !== '' ? collection.notes : '-';

                html += `
                    <tr style="background: linear-gradient(135deg, #d4edda, #c3e6cb);">
                        <td style="border: 1px solid #c3e6cb; padding: 5px; text-align: center; font-weight: bold;">${index + 1}</td>
                        <td style="border: 1px solid #c3e6cb; padding: 5px; font-weight: bold; color: #155724;">${contributor.name}</td>
                        <td style="border: 1px solid #c3e6cb; padding: 5px; color: #28a745; text-align: center; font-weight: bold;">${parseFloat(collection.amount).toLocaleString()}</td>
                        <td style="border: 1px solid #c3e6cb; padding: 5px; text-align: center; color: #495057;">${collection.transferType || '-'}</td>
                        <td style="border: 1px solid #c3e6cb; padding: 5px; text-align: center; color: #495057;">${collection.bank || '-'}</td>
                        <td style="border: 1px solid #c3e6cb; padding: 5px; text-align: center; color: #495057;">${collection.receiver || '-'}</td>
                        <td style="border: 1px solid #c3e6cb; padding: 5px; font-size: 0.75rem; font-style: italic; color: #495057;">${contributorNotes}</td>
                    </tr>
                `;
            });

            html += `
                        </tbody>
                    </table>
                </div>
            `;

            // عرض غير المساهمين في إطار منفصل
            if (nonContributors.length > 0) {
                const totalNonContributorsAmount = nonContributors.length * (currentAssociation.amount || 0);
                
                html += `
                    <div style="border: 3px solid #e74c3c; border-radius: 15px; padding: 20px; margin-bottom: 20px; background: linear-gradient(135deg, #fff5f5, #ffe6e6);">
                        <div style="text-align: center; margin-bottom: 15px;">
                            <h3 style="color: #e74c3c; margin-bottom: 10px;">⚠️ الأعضاء غير المساهمين</h3>
                            <div style="background: #e74c3c; color: white; padding: 10px; border-radius: 8px; display: inline-block;">
                                <strong>عدد الأعضاء: ${nonContributors.length}</strong> | 
                                <strong>إجمالي المبلغ المطلوب: ${totalNonContributorsAmount.toLocaleString()} ريال</strong>
                            </div>
                        </div>
                        
                        <table style="width: 100%; border-collapse: collapse; font-size: 0.8rem; background: white; border-radius: 8px; overflow: hidden;">
                            <thead style="background: #e74c3c; color: white;">
                                <tr>
                                    <th style="border: 1px solid #c82333; padding: 8px; text-align: center;">م</th>
                                    <th style="border: 1px solid #c82333; padding: 8px;">الاسم</th>
                                    <th style="border: 1px solid #c82333; padding: 8px; text-align: center;">المبلغ المطلوب</th>
                                    <th style="border: 1px solid #c82333; padding: 8px;">الملاحظات</th>
                                </tr>
                            </thead>
                            <tbody>`;
                            
                nonContributors.forEach((nonContributor, index) => {
                    const allCollections = JSON.parse(localStorage.getItem('associationCollections') || '[]');
                    const nonContributorCollection = allCollections.find(c => 
                        c.contributorId === nonContributor.id && 
                        c.beneficiaryId === memberId && 
                        c.associationId === currentAssociation.id
                    );
                    const requiredAmount = currentAssociation.amount || 0;
                    const contributorNotes = nonContributorCollection && nonContributorCollection.notes && nonContributorCollection.notes.trim() !== '' ? nonContributorCollection.notes : 'لا توجد ملاحظات';
                    
                    html += `
                        <tr style="background-color: #fff3cd;">
                            <td style="border: 1px solid #ffeaa7; padding: 8px; text-align: center; font-weight: bold;">${index + 1}</td>
                            <td style="border: 1px solid #ffeaa7; padding: 8px; font-weight: bold; color: #856404;">${nonContributor.name}</td>
                            <td style="border: 1px solid #ffeaa7; padding: 8px; color: #e74c3c; text-align: center; font-weight: bold;">${requiredAmount.toLocaleString()} ريال</td>
                            <td style="border: 1px solid #ffeaa7; padding: 8px; font-style: italic; color: #856404;">${contributorNotes}</td>
                        </tr>
                    `;
                });
                
                html += `
                            </tbody>
                        </table>
                    </div>
                `;
            }

            // ملاحظات العضو المستفيد فقط (إذا وجدت)
            if (member.notes && member.notes.trim() !== '') {
                html += `
                    <div style="background: linear-gradient(135deg, #e3f2fd, #bbdefb); padding: 12px; border-radius: 8px; margin-top: 15px; border: 1px solid #90caf9;">
                        <div style="font-weight: bold; color: #1565c0; margin-bottom: 5px;">ملاحظات العضو المستفيد:</div>
                        <div style="color: #1976d2; font-style: italic;">${member.notes}</div>
                    </div>
                `;
            }

            html += `
                <!-- زر العودة - يظهر فقط على الشاشة وليس في الطباعة -->
                <div class="no-print" style="text-align: center; margin-top: 15px;">
                    <button class="btn btn-secondary" onclick="showMarriageReportSelection()" style="padding: 8px 16px; font-size: 0.85rem; border-radius: 6px;">
                        <i class="fas fa-arrow-right"></i> العودة لقائمة الأعضاء
                    </button>
                </div>
            </div>
            `;

            document.getElementById('reportContent').innerHTML = html;
        }

        function generateMarriageReport() {
            if (!currentAssociation || currentAssociation.type === 'cooperation') return;

            const associationMembers = filterMembersByAssociation();
            const reportDate = new Date().toLocaleDateString('ar-SA');
            const allCollections = JSON.parse(localStorage.getItem('associationCollections') || '[]');

            // تصنيف الأعضاء حسب حالة الزواج
            const marriedMembers = associationMembers.filter(m => m.maritalStatus === 'متزوج' || m.maritalStatus === 'تزوج');
            const scheduledMembers = associationMembers.filter(m => m.maritalStatus === 'تم تحديد الزواج');
            const singleMembers = associationMembers.filter(m => m.maritalStatus === 'أعزب' || !m.maritalStatus);

            // حساب المبالغ
            const fixedAmount = currentAssociation.amount || 1000;
            const totalExpected = associationMembers.length * fixedAmount;
            const totalCollected = associationMembers.reduce((sum, member) => {
                return sum + getTotalCollectionForBeneficiary(member.id);
            }, 0);
            const totalRemaining = totalExpected - totalCollected;

            // العثور على العضو المتزوج (إذا كان هناك واحد)
            const marriedMember = marriedMembers.length > 0 ? marriedMembers[0] : null;
            const marriageDate = marriedMember && marriedMember.marriageDate ? 
                new Date(marriedMember.marriageDate).toLocaleDateString('ar-SA') : '-';

            let html = `
                <div class="print-area">
                    <!-- إطار واحد مبسط -->
                    <div style="border: 2px solid #2c3e50; border-radius: 8px; padding: 15px; margin-bottom: 20px; background: #f8f9fa;">
                        <div style="text-align: center; margin-bottom: 10px;">
                            <h2 style="margin: 0; font-size: 1.3rem; color: #2c3e50;">تقرير جمعية الزواج | ${currentAssociation.name}</h2>
                            ${marriedMember ? `<h3 style="margin: 5px 0; font-size: 1.1rem; color: #e74c3c;">زواج: ${marriedMember.name} | تاريخ الزواج: ${marriageDate} | تاريخ التقرير: ${reportDate}</h3>` : `<h3 style="margin: 5px 0; font-size: 1.1rem; color: #6c757d;">تاريخ التقرير: ${reportDate}</h3>`}
                        </div>
                        <hr style="margin: 10px 0; border: 1px solid #dee2e6;">
                        <div style="display: flex; justify-content: space-between; font-size: 0.9rem; font-weight: bold;">
                            <span>عدد الأعضاء: ${associationMembers.length}</span>
                            <span>المبلغ الإجمالي: ${totalExpected.toLocaleString()}</span>
                            <span style="color: #28a745;">المبلغ المحصل: ${totalCollected.toLocaleString()}</span>
                            <span style="color: #dc3545;">المبلغ المتبقي: ${totalRemaining.toLocaleString()}</span>
                        </div>
                    </div>
            `;

            // قسم المتزوجين
            if (marriedMembers.length > 0) {
                html += `
                    <div class="report-section" style="margin-bottom: 20px;">
                        <h3 style="font-size: 1rem; margin-bottom: 10px; color: #28a745;">الأعضاء المتزوجون (${marriedMembers.length})</h3>
                        <table style="width: 100%; border-collapse: collapse; font-size: 0.8rem;">
                            <thead>
                                <tr style="background-color: #f8f9fa;">
                                    <th style="border: 1px solid #dee2e6; padding: 4px; text-align: center;">#</th>
                                    <th style="border: 1px solid #dee2e6; padding: 4px; text-align: center;">الاسم</th>
                                    <th style="border: 1px solid #dee2e6; padding: 4px; text-align: center;">تاريخ الزواج</th>
                                    <th style="border: 1px solid #dee2e6; padding: 4px; text-align: center;">المحصل</th>
                                    <th style="border: 1px solid #dee2e6; padding: 4px; text-align: center;">المتبقي</th>
                                    <th style="border: 1px solid #dee2e6; padding: 4px; text-align: center;">الحالة</th>
                                </tr>
                            </thead>
                            <tbody>`;

                marriedMembers.forEach((member, index) => {
                    const totalCollected = getTotalCollectionForBeneficiary(member.id);
                    const expectedAmount = currentAssociation.amount || 0;
                    const remaining = expectedAmount - totalCollected;
                    const marriageDate = member.marriageDate ? new Date(member.marriageDate).toLocaleDateString('ar-SA') : '';
                    const status = remaining <= 0 ? 'مكتمل' : 'غير مكتمل';
                    const statusColor = remaining <= 0 ? '#28a745' : '#dc3545';

                    html += `
                        <tr>
                            <td style="border: 1px solid #dee2e6; padding: 3px; text-align: center;">${index + 1}</td>
                            <td style="border: 1px solid #dee2e6; padding: 3px; text-align: center; font-weight: bold;">${member.name}</td>
                            <td style="border: 1px solid #dee2e6; padding: 3px; text-align: center;">${marriageDate}</td>
                            <td style="border: 1px solid #dee2e6; padding: 3px; text-align: center; color: #28a745;">${totalCollected.toLocaleString()}</td>
                            <td style="border: 1px solid #dee2e6; padding: 3px; text-align: center; color: ${remaining > 0 ? '#dc3545' : '#28a745'};">${remaining.toLocaleString()}</td>
                            <td style="border: 1px solid #dee2e6; padding: 3px; text-align: center; color: ${statusColor}; font-weight: bold;">${status}</td>
                        </tr>
                    `;
                });

                html += `
                            </tbody>
                        </table>
                    </div>`;
            }

            // قسم المقرر زواجهم
            if (scheduledMembers.length > 0) {
                html += `
                    <div class="report-section" style="margin-bottom: 20px;">
                        <h3 style="font-size: 1rem; margin-bottom: 10px; color: #ffc107;">الأعضاء المقرر زواجهم (${scheduledMembers.length})</h3>
                        <table style="width: 100%; border-collapse: collapse; font-size: 0.8rem;">
                            <thead>
                                <tr style="background-color: #f8f9fa;">
                                    <th style="border: 1px solid #dee2e6; padding: 4px; text-align: center;">#</th>
                                    <th style="border: 1px solid #dee2e6; padding: 4px; text-align: center;">الاسم</th>
                                    <th style="border: 1px solid #dee2e6; padding: 4px; text-align: center;">تاريخ الزواج</th>
                                    <th style="border: 1px solid #dee2e6; padding: 4px; text-align: center;">المحصل</th>
                                    <th style="border: 1px solid #dee2e6; padding: 4px; text-align: center;">المتبقي</th>
                                    <th style="border: 1px solid #dee2e6; padding: 4px; text-align: center;">الحالة</th>
                                </tr>
                            </thead>
                            <tbody>`;

                scheduledMembers.forEach((member, index) => {
                    const totalCollected = getTotalCollectionForBeneficiary(member.id);
                    const expectedAmount = currentAssociation.amount || 0;
                    const remaining = expectedAmount - totalCollected;
                    const marriageDate = member.marriageDate ? new Date(member.marriageDate).toLocaleDateString('ar-SA') : '';
                    
                    let remainingTime = 'غير محدد';
                    if (member.marriageDate) {
                        const today = new Date();
                        const weddingDate = new Date(member.marriageDate);
                        const timeDiff = weddingDate.getTime() - today.getTime();
                        const daysDiff = Math.ceil(timeDiff / (1000 * 3600 * 24));

                        if (daysDiff < 0) {
                            remainingTime = `تأخر ${Math.abs(daysDiff)} يوم`;
                        } else if (daysDiff === 0) {
                            remainingTime = 'اليوم';
                        } else {
                            remainingTime = `${daysDiff} يوم`;
                        }
                    }

                    html += `
                        <tr>
                            <td style="border: 1px solid #dee2e6; padding: 3px; text-align: center;">${index + 1}</td>
                            <td style="border: 1px solid #dee2e6; padding: 3px; text-align: center; font-weight: bold;">${member.name}</td>
                            <td style="border: 1px solid #dee2e6; padding: 3px; text-align: center;">${marriageDate}</td>
                            <td style="border: 1px solid #dee2e6; padding: 3px; text-align: center; color: #17a2b8;">${totalCollected.toLocaleString()}</td>
                            <td style="border: 1px solid #dee2e6; padding: 3px; text-align: center; color: #dc3545;">${remaining.toLocaleString()}</td>
                            <td style="border: 1px solid #dee2e6; padding: 3px; text-align: center; color: #ffc107;">${remainingTime}</td>
                        </tr>
                    `;
                });

                html += `
                            </tbody>
                        </table>
                    </div>`;
            }

            // قسم الأعضاء غير المساهمين
            const nonContributingMembers = associationMembers.filter(member => {
                const totalCollected = getTotalCollectionForBeneficiary(member.id);
                return totalCollected === 0;
            });

            if (nonContributingMembers.length > 0) {
                html += `
                    <div style="margin-bottom: 20px;">
                        <h3 style="font-size: 1rem; margin-bottom: 10px; color: #dc3545;">الأعضاء غير المساهمين (${nonContributingMembers.length})</h3>
                        <div style="background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 4px; padding: 10px; font-size: 0.8rem;">
                `;
                
                nonContributingMembers.forEach((member, index) => {
                    html += `<span style="display: inline-block; margin: 2px 5px;">${index + 1}. ${member.name}${member.notes ? ` (${member.notes})` : ''}</span>`;
                });
                
                html += `
                        </div>
                    </div>
                `;
            }

            html += `
                    <!-- الخلاصة النهائية -->
                    <div style="margin-bottom: 20px;">
                        <div style="background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 4px; padding: 10px; font-size: 0.8rem;">
                            <div style="display: flex; justify-content: space-between; text-align: center;">
                                <span><strong>إجمالي الأعضاء:</strong> ${associationMembers.length}</span>
                                <span style="color: #28a745;"><strong>المتزوجون:</strong> ${marriedMembers.length}</span>
                                <span style="color: #ffc107;"><strong>مقرر زواجهم:</strong> ${scheduledMembers.length}</span>
                                <span style="color: #6c757d;"><strong>العزاب:</strong> ${singleMembers.length}</span>
                                <span style="color: #dc3545;"><strong>غير مساهمين:</strong> ${nonContributingMembers.length}</span>
                            </div>
                        </div>
                    </div>

                    <!-- قسم المسؤولين والتوقيعات -->
                    <div style="margin-top: 30px; border-top: 2px solid #dee2e6; padding-top: 20px;">
                        <h3 style="font-size: 1rem; margin-bottom: 15px; text-align: center; color: #2c3e50;">أسماء المسؤولين والتوقيعات</h3>
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 30px; margin-top: 20px;">
                            <div style="text-align: center;">
                                <div style="border-bottom: 1px solid #000; margin-bottom: 5px; height: 40px;"></div>
                                <p style="font-size: 0.9rem; margin: 0;"><strong>رئيس الجمعية</strong></p>
                                <p style="font-size: 0.8rem; margin: 0; color: #6c757d;">الاسم والتوقيع</p>
                            </div>
                            <div style="text-align: center;">
                                <div style="border-bottom: 1px solid #000; margin-bottom: 5px; height: 40px;"></div>
                                <p style="font-size: 0.9rem; margin: 0;"><strong>أمين الصندوق</strong></p>
                                <p style="font-size: 0.8rem; margin: 0; color: #6c757d;">الاسم والتوقيع</p>
                            </div>
                            <div style="text-align: center;">
                                <div style="border-bottom: 1px solid #000; margin-bottom: 5px; height: 40px;"></div>
                                <p style="font-size: 0.9rem; margin: 0;"><strong>المراجع</strong></p>
                                <p style="font-size: 0.8rem; margin: 0; color: #6c757d;">الاسم والتوقيع</p>
                            </div>
                        </div>
                        <div style="text-align: center; margin-top: 20px;">
                            <div style="border: 2px solid #2c3e50; border-radius: 4px; padding: 10px; display: inline-block;">
                                <p style="font-size: 0.9rem; margin: 0; font-weight: bold;">ختم الجمعية</p>
                                <div style="width: 80px; height: 80px; margin: 10px auto;"></div>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            document.getElementById('reportContent').innerHTML = html;
        }

        // التقرير الشامل المطور - يشمل جميع الجمعيات والمعلومات
        function generateComprehensiveMarriageReport() {
            try {
                const reportDate = new Date().toLocaleDateString('ar-SA');
                
                // جمع بيانات جميع الجمعيات
                const allAssociations = associations.filter(assoc => assoc.type !== 'cooperation');
                if (allAssociations.length === 0) {
                    showAlert('لا توجد جمعيات زواج لإنشاء التقرير', 'warning');
                    return;
                }

                let html = `<div class="print-area">
                    <!-- رأس التقرير الشامل -->
                    <div style="text-align: center; margin-bottom: 15px; padding: 12px; background: linear-gradient(135deg, #2c3e50, #34495e); color: white; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.2);">
                        <h1 style="margin: 0; font-size: 1.4rem; font-weight: bold;">📊 التقرير الشامل لجميع الجمعيات</h1>
                        <p style="margin: 5px 0 0 0; font-size: 0.9rem; opacity: 0.9;">تاريخ التقرير: ${reportDate}</p>
                    </div>`;

                // إحصائيات عامة
                let totalMembers = 0;
                let totalMarried = 0;
                let totalScheduled = 0;
                let totalCollected = 0;
                let totalExpected = 0;
                let totalAssociations = allAssociations.length;

                // تحليل كل جمعية
                 const associationsData = allAssociations.map(association => {
                     const associationMembers = members.filter(member => member.associationId === association.id);
                    const fixedAmount = association.amount || 1000;
                    
                    const marriedCount = associationMembers.filter(m => m.maritalStatus === 'متزوج' || m.maritalStatus === 'تزوج').length;
                    const scheduledCount = associationMembers.filter(m => m.maritalStatus === 'تم تحديد الزواج').length;
                    const singleCount = associationMembers.filter(m => m.maritalStatus === 'لم يتزوج' || !m.maritalStatus).length;
                    
                    const associationCollected = associationMembers.reduce((sum, member) => {
                        return sum + getTotalCollectionForBeneficiary(member.id);
                    }, 0);
                    
                    const associationExpected = associationMembers.length * fixedAmount;
                    const associationRemaining = associationExpected - associationCollected;
                    
                    // تحديث الإجماليات
                    totalMembers += associationMembers.length;
                    totalMarried += marriedCount;
                    totalScheduled += scheduledCount;
                    totalCollected += associationCollected;
                    totalExpected += associationExpected;
                    
                    return {
                        association,
                        members: associationMembers,
                        marriedCount,
                        scheduledCount,
                        singleCount,
                        fixedAmount,
                        collected: associationCollected,
                        expected: associationExpected,
                        remaining: associationRemaining,
                        officials: association.officials || []
                    };
                });

                const totalRemaining = totalExpected - totalCollected;
                const collectionPercentage = totalExpected > 0 ? ((totalCollected / totalExpected) * 100).toFixed(1) : 0;

                // القسم المالي الشامل
                html += `
                    <!-- القسم المالي الشامل -->
                    <div style="background: linear-gradient(135deg, #e8f5e8, #f0f8f0); border: 2px solid #28a745; border-radius: 10px; padding: 15px; margin-bottom: 20px;">
                        <h2 style="text-align: center; color: #155724; margin: 0 0 15px 0; font-size: 1.2rem;">💰 القسم المالي الشامل</h2>
                        
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; margin-bottom: 15px;">
                            <div style="background: white; padding: 10px; border-radius: 6px; text-align: center; border: 1px solid #28a745;">
                                <div style="font-size: 0.8rem; color: #666;">إجمالي الجمعيات</div>
                                <div style="font-size: 1.1rem; font-weight: bold; color: #2c3e50;">${totalAssociations}</div>
                            </div>
                            <div style="background: white; padding: 10px; border-radius: 6px; text-align: center; border: 1px solid #007bff;">
                                <div style="font-size: 0.8rem; color: #666;">إجمالي الأعضاء</div>
                                <div style="font-size: 1.1rem; font-weight: bold; color: #007bff;">${totalMembers} عضو</div>
                            </div>
                            <div style="background: white; padding: 10px; border-radius: 6px; text-align: center; border: 1px solid #28a745;">
                                <div style="font-size: 0.8rem; color: #666;">المتزوجون</div>
                                <div style="font-size: 1.1rem; font-weight: bold; color: #28a745;">${totalMarried}</div>
                            </div>
                            <div style="background: white; padding: 10px; border-radius: 6px; text-align: center; border: 1px solid #ffc107;">
                                <div style="font-size: 0.8rem; color: #666;">مقرر زواجهم</div>
                                <div style="font-size: 1.1rem; font-weight: bold; color: #856404;">${totalScheduled}</div>
                            </div>
                        </div>
                        
                        <div style="background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 8px; padding: 12px; margin-bottom: 10px;">
                            <h3 style="margin: 0 0 10px 0; color: #856404; font-size: 1rem;">📈 الحسابات المالية التفصيلية</h3>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 8px; font-size: 0.85rem;">
                                <div><strong>المبلغ المتفق عليه:</strong> 1,000 ريال</div>
                                <div><strong>إجمالي المبلغ المطلوب:</strong> ${totalExpected.toLocaleString()} ريال</div>
                                <div style="color: #28a745;"><strong>إجمالي المحصل:</strong> ${totalCollected.toLocaleString()} ريال</div>
                                <div style="color: #dc3545;"><strong>إجمالي المتبقي:</strong> ${totalRemaining.toLocaleString()} ريال</div>
                                <div style="color: #6f42c1;"><strong>نسبة التحصيل:</strong> ${collectionPercentage}%</div>
                                <div><strong>عدد الأعضاء المحصلين:</strong> ${totalMembers} × 1,000 = ${(totalMembers * 1000).toLocaleString()} ريال</div>
                            </div>
                        </div>
                    </div>`;

                // جدول ملخص الجمعيات
                html += `
                    <!-- ملخص الجمعيات -->
                    <div style="margin-bottom: 20px;">
                        <h2 style="background: #6c757d; color: white; padding: 8px; margin: 0 0 10px 0; border-radius: 6px; font-size: 1.1rem; text-align: center;">📋 ملخص جميع الجمعيات</h2>
                        <table style="width: 100%; border-collapse: collapse; font-size: 0.75rem; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                            <thead>
                                <tr style="background: #495057; color: white;">
                                    <th style="padding: 6px; border: 1px solid #ddd;">م</th>
                                    <th style="padding: 6px; border: 1px solid #ddd;">اسم الجمعية</th>
                                    <th style="padding: 6px; border: 1px solid #ddd;">الأعضاء</th>
                                    <th style="padding: 6px; border: 1px solid #ddd;">متزوج</th>
                                    <th style="padding: 6px; border: 1px solid #ddd;">مقرر</th>
                                    <th style="padding: 6px; border: 1px solid #ddd;">أعزب</th>
                                    <th style="padding: 6px; border: 1px solid #ddd;">المحصل</th>
                                    <th style="padding: 6px; border: 1px solid #ddd;">المتبقي</th>
                                    <th style="padding: 6px; border: 1px solid #ddd;">المسؤولين</th>
                                </tr>
                            </thead>
                            <tbody>`;

                associationsData.forEach((data, index) => {
                    const officialsText = data.officials.length > 0 ? 
                        data.officials.map(o => `${o.position}: ${o.name}`).join(' | ') : 
                        'غير محدد';
                    
                    html += `<tr style="background: ${index % 2 === 0 ? '#f8f9fa' : 'white'};">
                        <td style="text-align: center; border: 1px solid #ddd; padding: 4px;">${index + 1}</td>
                        <td style="border: 1px solid #ddd; padding: 4px; font-weight: bold;">${data.association.name}</td>
                        <td style="text-align: center; border: 1px solid #ddd; padding: 4px;">${data.members.length}</td>
                        <td style="text-align: center; border: 1px solid #ddd; padding: 4px; color: #28a745; font-weight: bold;">${data.marriedCount}</td>
                        <td style="text-align: center; border: 1px solid #ddd; padding: 4px; color: #ffc107; font-weight: bold;">${data.scheduledCount}</td>
                        <td style="text-align: center; border: 1px solid #ddd; padding: 4px; color: #6c757d;">${data.singleCount}</td>
                        <td style="text-align: center; border: 1px solid #ddd; padding: 4px; color: #28a745; font-weight: bold;">${data.collected.toLocaleString()}</td>
                        <td style="text-align: center; border: 1px solid #ddd; padding: 4px; color: #dc3545; font-weight: bold;">${data.remaining.toLocaleString()}</td>
                        <td style="border: 1px solid #ddd; padding: 4px; font-size: 0.7rem;">${officialsText}</td>
                    </tr>`;
                });

                html += `</tbody></table></div>`;

                // تفاصيل كل جمعية
                associationsData.forEach((data, assocIndex) => {
                    if (data.members.length === 0) return;
                    
                    html += `
                        <!-- تفاصيل ${data.association.name} -->
                        <div style="margin-bottom: 25px; border: 2px solid #007bff; border-radius: 10px; overflow: hidden;">
                            <div style="background: #007bff; color: white; padding: 10px; text-align: center;">
                                <h3 style="margin: 0; font-size: 1rem;">${data.association.name} - التفاصيل الكاملة</h3>
                                <div style="font-size: 0.8rem; margin-top: 5px;">الأعضاء: ${data.members.length} | المحصل: ${data.collected.toLocaleString()} | المتبقي: ${data.remaining.toLocaleString()} ريال</div>
                            </div>
                            
                            <div style="padding: 10px; background: #f8f9fa;">
                                <table style="width: 100%; border-collapse: collapse; font-size: 0.7rem;">
                                    <thead>
                                        <tr style="background: #6c757d; color: white;">
                                            <th style="padding: 4px; border: 1px solid #ddd;">م</th>
                                            <th style="padding: 4px; border: 1px solid #ddd;">الاسم</th>
                                            <th style="padding: 4px; border: 1px solid #ddd;">الحالة الاجتماعية</th>
                                            <th style="padding: 4px; border: 1px solid #ddd;">المحصل</th>
                                            <th style="padding: 4px; border: 1px solid #ddd;">المتبقي</th>
                                            <th style="padding: 4px; border: 1px solid #ddd;">الملاحظات</th>
                                        </tr>
                                    </thead>
                                    <tbody>`;
                    
                    data.members.forEach((member, memberIndex) => {
                        const memberCollected = getTotalCollectionForBeneficiary(member.id);
                        const memberRemaining = Math.max(0, data.fixedAmount - memberCollected);
                        const statusColor = member.maritalStatus === 'متزوج' || member.maritalStatus === 'تزوج' ? '#28a745' : 
                                          member.maritalStatus === 'تم تحديد الزواج' ? '#ffc107' : '#6c757d';
                        
                        html += `<tr style="background: ${memberIndex % 2 === 0 ? 'white' : '#f8f9fa'};">
                            <td style="text-align: center; border: 1px solid #ddd; padding: 3px;">${memberIndex + 1}</td>
                            <td style="border: 1px solid #ddd; padding: 3px;">${member.name}</td>
                            <td style="text-align: center; border: 1px solid #ddd; padding: 3px; color: ${statusColor}; font-weight: bold;">${member.maritalStatus || 'غير محدد'}</td>
                            <td style="text-align: center; border: 1px solid #ddd; padding: 3px; color: #28a745; font-weight: bold;">${memberCollected.toLocaleString()}</td>
                            <td style="text-align: center; border: 1px solid #ddd; padding: 3px; color: ${memberRemaining > 0 ? '#dc3545' : '#28a745'}; font-weight: bold;">${memberRemaining.toLocaleString()}</td>
                            <td style="border: 1px solid #ddd; padding: 3px; font-size: 0.65rem;">${member.notes || ''}</td>
                        </tr>`;
                    });
                    
                    html += `</tbody></table></div></div>`;
                });

                html += `</div>`;
                document.getElementById('reportContent').innerHTML = html;
            } catch (error) {
                showAlert('حدث خطأ في إنشاء التقرير: ' + error.message, 'error');
            }
        }

        // وظيفة الطباعة
        function printReport() {
            const content = document.getElementById('reportContent').innerHTML;
            if (!content.trim()) {
                showAlert('يرجى إنشاء تقرير أولاً', 'error');
                return;
            }

            // تحديد نوع التقرير بناءً على نوع الجمعية/المعاونة
            const reportType = currentAssociation && currentAssociation.type === 'cooperation'
                ? 'تقرير معاونة زواج'
                : 'تقرير جمعية الزواج';

            const associationName = currentAssociation ? currentAssociation.name : '';
            const currentDate = new Date().toLocaleDateString('ar-SA');

            // حساب الإحصائيات
            let statsInfo = '';
            if (currentAssociation) {
                const associationMembers = filterMembersByAssociation();

                if (currentAssociation.type === 'cooperation') {
                    // إحصائيات المعاونة
                    const contributors = associationMembers.filter(m => m.amount && parseFloat(m.amount) > 0);
                    const totalAmount = contributors.reduce((sum, m) => sum + (parseFloat(m.amount) || 0), 0);

                    // تحديد نوع التقرير المحدد
                    const reportTitle = content.includes('ملخص المساهمات') ? 'ملخص المساهمات' : 'كشف أعضاء المعاونة';

                    statsInfo = `
                        <div class="report-stats">
                            ${reportTitle} • المساهمين: ${contributors.length} • المبالغ: ${totalAmount.toLocaleString()} ر.س
                        </div>
                    `;
                } else {
                    // إحصائيات الجمعية
                    const marriedCount = associationMembers.filter(m => m.maritalStatus === 'تزوج').length;
                    const scheduledCount = associationMembers.filter(m => m.maritalStatus === 'تم تحديد الزواج').length;
                    const singleCount = associationMembers.filter(m => m.maritalStatus === 'لم يتزوج').length;
                    const fixedAmount = currentAssociation.amount || 0;

                    // تحديد نوع التقرير
                    let reportTitle = 'كشف أعضاء الجمعية';
                    if (content.includes('تقرير الزواج')) reportTitle = 'تقرير الزواج';
                    else if (content.includes('التقرير المالي')) reportTitle = 'التقرير المالي';

                    statsInfo = `
                                <div class="report-stats">
                                    كشف أعضاء الجمعية • الأعضاء: ${associationMembers.length} • متزوجون: ${marriedCount} • مقرر زواجهم: ${scheduledCount} • عزاب: ${singleCount} • المبلغ: ${fixedAmount.toLocaleString()} ر.س
                                </div>
                            `;
                }
            }

            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                    <head>
                        <title>${reportType} - ${associationName}</title>
                        <style>
                            @page {
                                margin: 12mm;
                                size: A4;
                            }

                            body {
                                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                                direction: rtl;
                                margin: 0;
                                padding: 10px;
                                line-height: 1.3;
                                color: #333;
                                font-size: 11px;
                            }

                            /* رأس التقرير */
                            .report-header {
                                border: 3px solid #2c3e50;
                                border-radius: 10px;
                                padding: 15px;
                                margin-bottom: 20px;
                                background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
                                text-align: center;
                            }

                            .report-title {
                                font-size: 18px;
                                font-weight: bold;
                                color: #2c3e50;
                                margin: 0 0 5px 0;
                            }

                            .association-name {
                                font-size: 14px;
                                color: #34495e;
                                margin: 0 0 5px 0;
                                font-weight: 600;
                            }

                            .report-date {
                                font-size: 11px;
                                color: #7f8c8d;
                                margin: 0;
                            }

                            .report-stats {
                                font-size: 10px;
                                color: #2c3e50;
                                margin: 5px 0 0 0;
                                font-weight: 600;
                                border-top: 1px solid #bdc3c7;
                                padding-top: 5px;
                                white-space: nowrap;
                                overflow: hidden;
                                text-overflow: ellipsis;
                                line-height: 1.2;
                            }

                            /* محتوى التقرير */
                            .report-content {
                                margin-bottom: 30px;
                            }

                            table {
                                width: 100%;
                                border-collapse: collapse;
                                margin: 8px 0;
                                font-size: 10px;
                                box-shadow: 0 1px 3px rgba(0,0,0,0.1);
                            }

                            th, td {
                                border: 1px solid #bdc3c7;
                                padding: 3px 5px;
                                text-align: right;
                                vertical-align: middle;
                            }

                            th {
                                background: linear-gradient(135deg, #34495e 0%, #2c3e50 100%);
                                color: white;
                                font-weight: bold;
                                font-size: 9px;
                                text-align: center;
                            }

                            tr:nth-child(even) {
                                background-color: #f8f9fa;
                            }

                            tr:hover {
                                background-color: #e8f4f8;
                            }

                            /* تذييل التقرير */
                            .report-footer {
                                position: fixed;
                                bottom: 0;
                                left: 0;
                                right: 0;
                                border-top: 1px solid #dee2e6;
                                padding: 8px 12px;
                                background: white;
                                text-align: center;
                                font-size: 9px;
                                font-weight: bold;
                                color: #2c3e50;
                                line-height: 1.2;
                                page-break-inside: avoid;
                            }
                            
                            .content {
                                margin-bottom: 60px;
                            }
                            
                            .page-break {
                                page-break-before: always;
                            }

                            .app-title {
                                color: #2c3e50;
                                font-size: 12px;
                                margin-bottom: 5px;
                            }

                            .designer-info {
                                color: #34495e;
                                margin-bottom: 3px;
                            }

                            .phone-number {
                                color: #e74c3c;
                                font-weight: bold;
                            }

                            .dedication {
                                color: #8e44ad;
                                font-style: italic;
                                margin-top: 5px;
                            }

                            /* تحسينات للطباعة */
                            @media print {
                                * {
                                    -webkit-print-color-adjust: exact !important;
                                    color-adjust: exact !important;
                                }
                                
                                body {
                                    margin: 0 !important;
                                    padding: 15px !important;
                                    font-size: 11px !important;
                                    font-family: 'Arial', 'Tahoma', sans-serif !important;
                                }

                                .report-header {
                                    border: 2px solid #000 !important;
                                    background: #f5f5f5 !important;
                                    font-family: 'Arial', 'Tahoma', sans-serif !important;
                                }

                                .report-footer {
                                    border: 1px solid #000 !important;
                                    background: #f9f9f9 !important;
                                    font-family: 'Arial', 'Tahoma', sans-serif !important;
                                }

                                th {
                                    background: #e0e0e0 !important;
                                    color: #000 !important;
                                    font-family: 'Arial', 'Tahoma', sans-serif !important;
                                }
                                
                                td {
                                    font-family: 'Arial', 'Tahoma', sans-serif !important;
                                }
                                
                                .report-title, .association-name, .report-date, .report-stats {
                                    font-family: 'Arial', 'Tahoma', sans-serif !important;
                                }
                            }
                        </style>
                    </head>
                    <body>
                        <div class="content">
                            <!-- رأس التقرير -->
                            <div class="report-header">
                                <div class="report-title">${associationName}</div>
                                <div class="association-name">${reportType}</div>
                                <div class="report-date">تاريخ التقرير: ${currentDate}</div>
                                ${statsInfo}
                            </div>

                            <!-- محتوى التقرير -->
                            <div class="report-content">
                                ${content}
                            </div>
                        </div>

                        <!-- تذييل التقرير -->
                        <div class="report-footer">
                            <div class="app-title">تطبيق معاونة وجمعية الزواج النسخة الاولى</div>
                            <div class="designer-info">اعداد وتصميم الأستاذ / ناصر مسعود آل مستنير</div>
                            <div class="phone-number">📱 0505723776 | ✉️ yam287@gmail.com</div>
                        </div>
                    </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
        }

        // تهيئة البحث في الأعضاء
        document.addEventListener('DOMContentLoaded', function() {
            // تهيئة التطبيق أولاً
            initializeApp();
            
            // محاولة استعادة الجلسة
            const savedUser = localStorage.getItem('currentUser');
            const savedAssociation = localStorage.getItem('currentAssociation');
            const savedSection = localStorage.getItem('currentSection');
            
            if (savedUser) {
                try {
                    const parsedUser = JSON.parse(savedUser);
                    
                    // التحقق من وجود المستخدم في قاعدة البيانات
                    const userExists = users.find(u => 
                        (u.id === parsedUser.id) || 
                        (u.civilId === parsedUser.civilId && parsedUser.civilId !== '')
                    );
                    
                    if (userExists) {
                        // تحديث بيانات المستخدم الحالي
                        currentUser = userExists;
                        currentUser.lastLogin = new Date().toISOString();
                        
                        // تحديث آخر دخول في قاعدة البيانات
                        const userIndex = users.findIndex(u => u.id === currentUser.id);
                        if (userIndex !== -1) {
                            users[userIndex].lastLogin = currentUser.lastLogin;
                            saveUsers();
                        }
                        
                        // حفظ المستخدم المحدث
                        localStorage.setItem('currentUser', JSON.stringify(currentUser));
                        
                        // استعادة الجمعية المحفوظة
                        if (savedAssociation) {
                            try {
                                currentAssociation = JSON.parse(savedAssociation);
                            } catch (e) {
                                console.error('خطأ في تحميل بيانات الجمعية:', e);
                                currentAssociation = associations[0] || null;
                            }
                        }
                        
                        // إكمال تسجيل الدخول
                        completeLogin();
                        
                        // الانتقال للقسم المحفوظ
                        if (savedSection) {
                            setTimeout(() => {
                                showSection(savedSection);
                            }, 200);
                        }
                        
                        console.log('تم استعادة الجلسة بنجاح للمستخدم:', currentUser.name);
                    } else {
                        // مسح الجلسة إذا كان المستخدم غير موجود
                        clearSession();
                        console.log('المستخدم المحفوظ غير صالح، تم مسح الجلسة');
                    }
                } catch (e) {
                    console.error('خطأ في تحميل بيانات المستخدم:', e);
                    clearSession();
                }
            }

            // مسح القوانين المخصصة القديمة وتحميل الجديدة
            localStorage.removeItem('customTerms');
            loadCustomTerms();

            // مسح أرقام الهواتف الموجودة
            clearAllPhoneNumbers();

            // مزامنة بيانات الأعضاء مع المستخدمين
            syncMembersWithUsers();

            // التأكد من عرض الشاشة المناسبة
            if (!currentUser) {
                console.log('لا يوجد مستخدم، إظهار شاشة تسجيل الدخول');
                document.getElementById('loginScreen').style.display = 'block';
                document.getElementById('mainApp').style.display = 'none';
            }

            const memberSearch = document.getElementById('memberSearch');
            if (memberSearch) {
                // إزالة المستمعين السابقين لتجنب التكرار
                memberSearch.removeEventListener('input', memberSearchHandler);
                memberSearch.addEventListener('input', memberSearchHandler);
            }
        });

        // وظائف القوانين
        function editTerms() {
            const currentTerms = document.getElementById('termsContent').innerHTML;
            document.getElementById('termsEditor').value = currentTerms;
            showModal('editTermsModal');
        }

        function printTerms() {
            const termsContent = document.getElementById('termsContent').innerHTML;
            const printWindow = window.open('', '_blank');

            printWindow.document.write(`
                <!DOCTYPE html>
                <html dir="rtl" lang="ar">
                <head>
                    <meta charset="UTF-8">
                    <title>قوانين وشروط الجمعية</title>
                    <style>
                        @page {
                            size: A4;
                            margin: 15mm;
                        }
                        body {
                            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                            line-height: 1.4;
                            margin: 0;
                            padding: 0;
                            color: #333;
                            font-size: 12px;
                        }
                        h3 {
                            color: #2c3e50;
                            text-align: center;
                            border-bottom: 1px solid #3498db;
                            padding-bottom: 5px;
                            margin: 10px 0;
                            font-size: 16px;
                        }
                        h4 {
                            color: #34495e;
                            margin: 15px 0 8px 0;
                            font-size: 14px;
                        }
                        ul {
                            margin: 8px 0;
                            padding-right: 20px;
                        }
                        li {
                            margin: 4px 0;
                            padding: 3px;
                            font-size: 11px;
                        }
                        p {
                            margin: 8px 0;
                            text-align: justify;
                            font-size: 11px;
                        }
                        .page-break {
                            page-break-before: always;
                        }
                        .footer {
                            position: fixed;
                            bottom: 0;
                            left: 0;
                            right: 0;
                            text-align: center;
                            padding: 10px;
                            border-top: 1px solid #dee2e6;
                            background: white;
                            font-size: 10px;
                            color: #2c3e50;
                            line-height: 1.2;
                        }
                        .app-title {
                            font-weight: bold;
                            margin-bottom: 3px;
                        }
                        .designer-info {
                            margin-bottom: 2px;
                        }
                        .phone-number {
                            color: #e74c3c;
                            font-weight: bold;
                        }
                        .content {
                            margin-bottom: 80px;
                        }
                        @media print {
                            .footer {
                                position: fixed;
                                bottom: 0;
                            }
                            .page-break {
                                page-break-before: always;
                            }
                        }
                    </style>
                </head>
                <body>
                    <div class="content">
                        ${termsContent}
                    </div>
                    <div class="footer">
                        <div class="app-title">تطبيق معاونة وجمعية الزواج النسخة الاولى</div>
                        <div class="designer-info">اعداد وتصميم الأستاذ / ناصر مسعود آل مستنير</div>
                        <div class="phone-number">📱 0505723776 | ✉️ yam287@gmail.com</div>
                    </div>
                </body>
                </html>
            `);

            printWindow.document.close();
            printWindow.focus();
            printWindow.print();
        }

        // معالج نموذج تعديل القوانين
        document.getElementById('termsForm').addEventListener('submit', function(e) {
            e.preventDefault();

            const newTerms = document.getElementById('termsEditor').value;
            document.getElementById('termsContent').innerHTML = newTerms;

            // حفظ القوانين في التخزين المحلي
            localStorage.setItem('customTerms', newTerms);

            closeModal('editTermsModal');
            showAlert('تم حفظ التعديلات بنجاح!', 'success');
        });

        // تحميل القوانين المخصصة عند بدء التطبيق
        function loadCustomTerms() {
            const customTerms = localStorage.getItem('customTerms');
            if (customTerms) {
                document.getElementById('termsContent').innerHTML = customTerms;
            } else {
                // تحميل القوانين الافتراضية الجديدة
                document.getElementById('termsContent').innerHTML = getDefaultTerms();
            }
        }

        // وظائف إدارة المستخدمين
        function displayUsersStats() {
            const container = document.getElementById('usersStats');

            const totalUsers = users.length;
            const adminCount = users.filter(u => u.role === 'admin').length;
            const supervisorCount = users.filter(u => u.role === 'supervisor').length;
            const memberCount = users.filter(u => u.role === 'member').length;
            const guestCount = users.filter(u => u.role === 'guest').length;
            const activeUsers = users.filter(u => u.lastLogin).length;

            container.innerHTML = `
                <div class="stat-card">
                    <div class="stat-icon" style="background: linear-gradient(135deg, #667eea, #764ba2);">
                        <i class="fas fa-users"></i>
                    </div>
                    <div class="stat-content">
                        <div class="stat-number">${totalUsers}</div>
                        <div class="stat-label">إجمالي المستخدمين</div>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-icon" style="background: linear-gradient(135deg, #dc3545, #c82333);">
                        <i class="fas fa-user-shield"></i>
                    </div>
                    <div class="stat-content">
                        <div class="stat-number">${adminCount}</div>
                        <div class="stat-label">المديرون</div>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-icon" style="background: linear-gradient(135deg, #fd7e14, #e55a00);">
                        <i class="fas fa-user-tie"></i>
                    </div>
                    <div class="stat-content">
                        <div class="stat-number">${supervisorCount}</div>
                        <div class="stat-label">المشرفون</div>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-icon" style="background: linear-gradient(135deg, #28a745, #1e7e34);">
                        <i class="fas fa-user"></i>
                    </div>
                    <div class="stat-content">
                        <div class="stat-number">${memberCount}</div>
                        <div class="stat-label">الأعضاء</div>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-icon" style="background: linear-gradient(135deg, #17a2b8, #138496);">
                        <i class="fas fa-user-check"></i>
                    </div>
                    <div class="stat-content">
                        <div class="stat-number">${activeUsers}</div>
                        <div class="stat-label">نشطون</div>
                    </div>
                </div>
            `;
        }

        function displayUsers() {
            displayUsersStats();
            const container = document.getElementById('usersTable');

            if (users.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #6c757d;">
                        <i class="fas fa-users" style="font-size: 3rem; margin-bottom: 20px;"></i>
                        <h3>لا يوجد مستخدمون</h3>
                        <p>ابدأ بإضافة مستخدم جديد</p>
                    </div>
                `;
                return;
            }

            let html = `
                <table style="width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                    <thead>
                        <tr style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                            <th style="padding: 15px; text-align: center; border: 1px solid #ddd;">م</th>
                            <th style="padding: 15px; border: 1px solid #ddd;">الاسم</th>
                            <th style="padding: 15px; text-align: center; border: 1px solid #ddd;">الدور</th>
                            <th style="padding: 15px; text-align: center; border: 1px solid #ddd;">رقم الهاتف</th>
                            <th style="padding: 15px; text-align: center; border: 1px solid #ddd;">رقم السجل</th>
                            <th style="padding: 15px; text-align: center; border: 1px solid #ddd;">تاريخ الإنشاء</th>
                            <th style="padding: 15px; text-align: center; border: 1px solid #ddd;">آخر دخول</th>
                            <th style="padding: 15px; text-align: center; border: 1px solid #ddd;">الإجراءات</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            users.forEach((user, index) => {
                const roleText = getRoleText(user.role);
                const roleColor = getRoleColor(user.role);
                const createdDate = new Date(user.createdAt).toLocaleDateString('ar-SA');
                const lastLogin = user.lastLogin ? new Date(user.lastLogin).toLocaleDateString('ar-SA') : 'لم يسجل دخول';
                const isCurrentUser = currentUser && currentUser.id === user.id;

                html += `
                    <tr style="background: ${isCurrentUser ? '#e8f5e8' : index % 2 === 0 ? '#f8f9fa' : 'white'}; ${isCurrentUser ? 'border: 2px solid #28a745;' : ''}">
                        <td style="padding: 12px; text-align: center; border: 1px solid #ddd; font-weight: bold;">${index + 1}</td>
                        <td style="padding: 12px; border: 1px solid #ddd;">
                            <strong>${user.name}</strong>
                            ${isCurrentUser ? '<span style="color: #28a745; font-size: 0.8rem; margin-right: 5px;">(أنت)</span>' : ''}
                        </td>
                        <td style="padding: 12px; text-align: center; border: 1px solid #ddd;">
                            <span style="background: ${roleColor}; color: white; padding: 4px 8px; border-radius: 12px; font-size: 0.8rem; font-weight: bold;">
                                ${roleText}
                            </span>
                        </td>
                        <td style="padding: 12px; text-align: center; border: 1px solid #ddd;">${user.phone || '-'}</td>
                        <td style="padding: 12px; text-align: center; border: 1px solid #ddd; font-family: monospace;">${user.civilId}</td>
                        <td style="padding: 12px; text-align: center; border: 1px solid #ddd; font-size: 0.9rem;">${createdDate}</td>
                        <td style="padding: 12px; text-align: center; border: 1px solid #ddd; font-size: 0.9rem;">${lastLogin}</td>
                        <td style="padding: 12px; text-align: center; border: 1px solid #ddd;">
                            ${user.id !== 'admin' ? `
                                <button class="btn btn-warning" onclick="editUser('${user.id}')" title="تعديل" style="padding: 4px 8px; font-size: 0.8rem; margin: 2px;">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-danger" onclick="deleteUser('${user.id}')" title="حذف" style="padding: 4px 8px; font-size: 0.8rem; margin: 2px;">
                                    <i class="fas fa-trash"></i>
                                </button>
                            ` : '<span style="color: #6c757d; font-size: 0.8rem;">مدير النظام</span>'}
                        </td>
                    </tr>
                `;
            });

            html += '</tbody></table>';
            container.innerHTML = html;
        }

        function getRoleText(role) {
            const roles = {
                'admin': 'مدير',
                'supervisor': 'مشرف',
                'member': 'عضو',
                'guest': 'زائر'
            };
            return roles[role] || role;
        }

        function getRoleColor(role) {
            const colors = {
                'admin': '#dc3545',
                'supervisor': '#fd7e14',
                'member': '#28a745',
                'guest': '#6c757d'
            };
            return colors[role] || '#6c757d';
        }

        function editUser(userId) {
            const user = users.find(u => u.id === userId);
            if (!user) {
                showAlert('لم يتم العثور على المستخدم', 'error');
                return;
            }

            // ملء النموذج بالبيانات الحالية
            document.getElementById('userName').value = user.name;
            document.getElementById('userRole').value = user.role;
            document.getElementById('userPhone').value = user.phone || '';

            // تغيير عنوان النافذة
            document.querySelector('#addUserModal h3').textContent = 'تعديل المستخدم';

            // إضافة معرف المستخدم للتعديل
            document.getElementById('userForm').setAttribute('data-edit-id', userId);

            showModal('addUserModal');
        }

        function deleteUser(userId) {
            if (userId === 'admin') {
                showAlert('لا يمكن حذف المدير العام', 'error');
                return;
            }

            if (currentUser && currentUser.id === userId) {
                showAlert('لا يمكنك حذف حسابك الحالي', 'error');
                return;
            }

            if (confirm('هل أنت متأكد من حذف هذا المستخدم؟\nسيتم حذف جميع بياناته نهائياً.')) {
                users = users.filter(u => u.id !== userId);
                saveUsers();
                displayUsers();
                showAlert('تم حذف المستخدم بنجاح!', 'success');
            }
        }

        function generateUserIds() {
            if (!currentAssociation) {
                showAlert('يرجى تحديد جمعية أولاً', 'error');
                return;
            }

            const associationMembers = filterMembersByAssociation();

            if (associationMembers.length === 0) {
                showAlert('لا يوجد أعضاء في الجمعية الحالية لتوليد أرقام لهم', 'error');
                return;
            }

            let generatedCount = 0;
            const generatedIds = [];

            associationMembers.forEach(member => {
                if (!member.civilId || member.civilId === '') {
                    // توليد رقم سجل مدني وهمي فريد
                    let randomId;
                    do {
                        randomId = '1' + Math.floor(Math.random() * 999999999).toString().padStart(9, '0');
                    } while (
                        generatedIds.includes(randomId) ||
                        users.some(u => u.civilId === randomId) ||
                        members.some(m => m.civilId === randomId)
                    );

                    member.civilId = randomId;
                    generatedIds.push(randomId);
                    generatedCount++;
                }
            });

            if (generatedCount > 0) {
                saveMembers();

                // عرض الأرقام المولدة
                const idsList = generatedIds.map((id, index) =>
                    `${index + 1}. ${associationMembers.find(m => m.civilId === id)?.name}: ${id}`
                ).join('\n');

                showAlert(`تم توليد ${generatedCount} رقم سجل مدني للأعضاء:\n\n${idsList}`, 'success');
                displayMembers(); // تحديث عرض الأعضاء
            } else {
                showAlert('جميع الأعضاء لديهم أرقام سجل مدني بالفعل', 'info');
            }
        }

        // معالج نموذج إضافة/تعديل المستخدم
        document.getElementById('userForm').addEventListener('submit', function(e) {
            e.preventDefault();

            const editId = this.getAttribute('data-edit-id');
            const name = document.getElementById('userName').value.trim();
            const role = document.getElementById('userRole').value;
            const phone = document.getElementById('userPhone').value.trim();

            if (!name || !role) {
                showAlert('يرجى ملء جميع الحقول المطلوبة', 'error');
                return;
            }

            if (editId) {
                // تعديل مستخدم موجود
                const userIndex = users.findIndex(u => u.id === editId);
                if (userIndex !== -1) {
                    users[userIndex] = {
                        ...users[userIndex],
                        name: name,
                        role: role,
                        phone: phone
                    };
                    showAlert('تم تعديل المستخدم بنجاح!', 'success');
                }
            } else {
                // إضافة مستخدم جديد
                const civilId = generateCivilId();
                const newUser = {
                    id: Date.now().toString(),
                    name: name,
                    role: role,
                    phone: phone,
                    civilId: civilId,
                    createdAt: new Date().toISOString(),
                    lastLogin: null
                };

                users.push(newUser);
                showAlert(`تم إضافة المستخدم بنجاح!\nرقم السجل المدني: ${civilId}`, 'success');
            }

            saveUsers();
            displayUsers();

            // إعادة تعيين النموذج
            this.reset();
            this.removeAttribute('data-edit-id');
            document.querySelector('#addUserModal h3').textContent = 'إضافة مستخدم جديد';
            closeModal('addUserModal');
        });

        function generateCivilId() {
            let civilId;
            do {
                civilId = '1' + Math.floor(Math.random() * 999999999).toString().padStart(9, '0');
            } while (
                users.some(u => u.civilId === civilId) ||
                members.some(m => m.civilId === civilId)
            );
            return civilId;
        }

        // دالة مسح أرقام الهواتف
        function clearAllPhoneNumbers() {
            let updated = false;
            members.forEach(member => {
                if (member.phone && member.phone.trim() !== '') {
                    member.phone = '';
                    updated = true;
                }
            });

            if (updated) {
                saveMembers();
                console.log('تم مسح جميع أرقام الهواتف');
            }
        }

        // نظام الصلاحيات المتكامل
        function hasPermission(action) {
            if (!currentUser) return false;

            const permissions = {
                'admin': [
                    'view_all', 'add_member', 'edit_member', 'delete_member',
                    'manage_associations', 'manage_collections', 'view_reports',
                    'manage_users', 'lock_unlock', 'manage_terms', 'view_own_details', 'edit_own_details'
                ],
                'supervisor': [
                    'view_all', 'add_member', 'edit_member', 'manage_collections',
                    'view_reports', 'view_own_details', 'edit_own_details'
                ],
                'member': [
                    'view_own_details', 'edit_own_details', 'view_all'
                ],
                'guest': [
                    'view_limited', 'view_all'
                ]
            };

            const userPermissions = permissions[currentUser.role] || [];
            return userPermissions.includes(action);
        }

        function checkPermissionAndAlert(action, errorMessage = 'ليس لديك صلاحية للقيام بهذا الإجراء') {
            if (!hasPermission(action)) {
                showAlert(errorMessage, 'error');
                return false;
            }
            return true;
        }

        // دالة للتحقق من أن العضو يصل لبياناته فقط
        function canAccessMemberData(memberId) {
            if (!currentUser) return false;

            // المدير والمشرف يمكنهم الوصول لجميع البيانات
            if (currentUser.role === 'admin' || currentUser.role === 'supervisor') {
                return true;
            }

            // العضو يمكنه الوصول لبياناته فقط
            if (currentUser.role === 'member') {
                // التحقق من ID أولاً
                if (currentUser.id === memberId) {
                    return true;
                }
                
                // إذا لم يطابق ID، تحقق من رقم السجل المدني
                const member = members.find(m => m.id === memberId);
                if (member && currentUser.civilId && member.civilId === currentUser.civilId) {
                    return true;
                }
            }

            return false;
        }

        // دالة إنشاء القائمة حسب الصلاحيات
        function buildNavigationMenu() {
            console.log('بناء القائمة للمستخدم:', currentUser);
            const nav = document.getElementById('mainNavigation');
            if (!nav) {
                console.error('لم يتم العثور على عنصر القائمة');
                return;
            }

            const menuItems = [
                { id: 'home', icon: 'fas fa-home', text: 'الرئيسية', permission: 'view_all', always: true },
                { id: 'myProfile', icon: 'fas fa-user', text: 'بياناتي الشخصية', permission: 'view_own_details', memberOnly: true },
                { id: 'associations', icon: 'fas fa-building', text: 'الجمعيات', permission: 'manage_associations' },
                { id: 'register', icon: 'fas fa-hand-holding-heart', text: 'المعونات', permission: 'add_member' },
                { id: 'members', icon: 'fas fa-users', text: 'قائمة الأعضاء', permission: 'view_all' },
                { id: 'collection', icon: 'fas fa-money-bill-wave', text: 'التحصيل', permission: 'manage_collections' },
                { id: 'reports', icon: 'fas fa-chart-bar', text: 'الكشوفات', permission: 'view_reports' },
                { id: 'terms', icon: 'fas fa-file-contract', text: 'القوانين', permission: 'view_all', always: true },
                { id: 'users', icon: 'fas fa-users-cog', text: 'إدارة المستخدمين', permission: 'manage_users' },
                { id: 'idGenerator', icon: 'fas fa-id-card', text: 'أرقام السجل', permission: 'manage_users' },
                { id: 'backup', icon: 'fas fa-download', text: 'النسخ الاحتياطية', permission: 'manage_users' }
            ];

            let html = '';

            let firstItem = true;
            menuItems.forEach((item, index) => {
                let canShow = false;

                if (item.always) {
                    canShow = true;
                } else if (item.memberOnly) {
                    // عناصر خاصة بالأعضاء فقط
                    canShow = currentUser.role === 'member' && hasPermission(item.permission);
                } else {
                    // عناصر للمدير والمشرف
                    canShow = hasPermission(item.permission);
                }

                if (canShow) {
                    console.log('إضافة عنصر القائمة:', item.text);
                    const activeClass = firstItem ? 'active' : '';
                    firstItem = false;
                    html += `
                        <button class="nav-btn ${activeClass}" onclick="showSection('${item.id}')">
                            <i class="${item.icon}"></i> ${item.text}
                        </button>
                    `;
                } else {
                    console.log('تم رفض عنصر القائمة:', item.text, 'للمستخدم:', currentUser.role);
                }
            });

            // زر الخروج متاح للجميع
            html += `
                <button class="nav-btn btn-danger" onclick="logout()" style="margin-top: 10px;">
                    <i class="fas fa-sign-out-alt"></i> خروج
                </button>
            `;

            nav.innerHTML = html;
            console.log('تم إنشاء القائمة بنجاح، HTML:', html);
        }

        // دالة حساب ما دفعه العضو للآخرين المتزوجين
        function getMemberContributions(memberId) {
            const collections = JSON.parse(localStorage.getItem('associationCollections') || '[]');
            
            // البحث عن التحصيلات التي دفعها هذا العضو للآخرين
            const memberContributions = collections.filter(c => 
                c.contributorId === memberId && 
                c.associationId === currentAssociation.id &&
                parseFloat(c.amount) > 0
            );
            
            // حساب إجمالي ما دفعه
            return memberContributions.reduce((total, c) => total + parseFloat(c.amount), 0);
        }
        
        // دالة حساب عدد الأعضاء غير المتزوجين
        function getUnmarriedMembersCount() {
            if (!currentAssociation) return 0;
            
            // الحصول على أعضاء الجمعية الحالية
            const associationMembers = members.filter(m => 
                m.associationId === currentAssociation.id && 
                m.isActive !== false
            );
            
            // عد الأعضاء غير المتزوجين (الذين لم يحددوا زواجهم أو لم يتزوجوا بعد)
            const unmarriedMembers = associationMembers.filter(m => {
                const status = m.maritalStatus || 'أعزب';
                return status === 'أعزب' || status === 'غير متزوج' || !status || status === '';
            });
            
            return unmarriedMembers.length;
        }

        // دالة عرض البيانات الشخصية للعضو
        function displayMemberProfile() {
            if (!currentUser || currentUser.role !== 'member') {
                return;
            }

            const member = members.find(m => m.id === currentUser.id);
            if (!member) {
                document.getElementById('memberProfileContent').innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #6c757d;">
                        <i class="fas fa-user-slash" style="font-size: 3rem; margin-bottom: 20px;"></i>
                        <h3>لم يتم العثور على بياناتك</h3>
                        <p>يرجى التواصل مع المدير لإضافة بياناتك</p>
                    </div>
                `;
                return;
            }

            const marriageDate = member.marriageDate ? new Date(member.marriageDate).toLocaleDateString('ar-SA') : 'لم يحدد';
            
            // حساب المبلغ المحصل - ما دفعه العضو للآخرين المتزوجين
            const totalCollected = getMemberContributions(member.id);
            
            // حساب المتبقي - عدد الأعضاء غير المتزوجين × المبلغ المتفق عليه
            const unmarriedCount = getUnmarriedMembersCount();
            const agreedAmount = currentAssociation ? currentAssociation.amount || 1000 : 1000;
            const remaining = unmarriedCount * agreedAmount;
            
            // المبلغ المطلوب الإجمالي
            const expectedAmount = totalCollected + remaining;

            document.getElementById('memberProfileContent').innerHTML = `
                <div style="max-width: 800px; margin: 0 auto;">
                    <!-- بطاقة البيانات الشخصية -->
                    <div style="background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 30px; border-radius: 15px; margin-bottom: 30px; text-align: center;">
                        <div style="font-size: 3rem; margin-bottom: 15px;">
                            <i class="fas fa-user-circle"></i>
                        </div>
                        <h2 style="margin-bottom: 10px;">${member.name}</h2>
                        <p style="opacity: 0.9; font-size: 1.1rem;">عضو في ${currentAssociation ? currentAssociation.name : 'الجمعية'}</p>
                    </div>

                    <!-- البيانات الأساسية -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 30px;">
                        <div style="background: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
                            <h3 style="color: #2c3e50; margin-bottom: 20px; border-bottom: 2px solid #3498db; padding-bottom: 10px;">
                                <i class="fas fa-info-circle"></i> البيانات الشخصية
                            </h3>
                            <div style="space-y: 15px;">
                                <div style="margin-bottom: 15px;">
                                    <strong>الاسم الكامل:</strong> ${member.name}
                                </div>
                                <div style="margin-bottom: 15px;">
                                    <strong>رقم الهاتف:</strong> ${member.phone || 'لم يحدد'}
                                </div>
                                <div style="margin-bottom: 15px;">
                                    <strong>الحالة الاجتماعية:</strong> ${member.status || 'لم يحدد'}
                                </div>
                                <div style="margin-bottom: 15px;">
                                    <strong>المدينة:</strong> ${member.city || 'لم يحدد'}
                                </div>
                                <div style="margin-bottom: 15px;">
                                    <strong>رقم السجل المدني:</strong> ${member.civilId || 'لم يحدد'}
                                </div>
                            </div>
                            <div style="text-align: center; margin-top: 20px;">
                                <button class="btn btn-primary" onclick="showMemberDetails('${member.id}')">
                                    <i class="fas fa-edit"></i> تعديل البيانات
                                </button>
                            </div>
                        </div>

                        <div style="background: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
                            <h3 style="color: #2c3e50; margin-bottom: 20px; border-bottom: 2px solid #e74c3c; padding-bottom: 10px;">
                                <i class="fas fa-heart"></i> بيانات الزواج
                            </h3>
                            <div style="space-y: 15px;">
                                <div style="margin-bottom: 15px;">
                                    <strong>حالة الزواج:</strong>
                                    <span style="color: ${(member.maritalStatus === 'متزوج' || member.maritalStatus === 'تزوج') ? '#28a745' : member.maritalStatus === 'تم تحديد الزواج' ? '#ffc107' : '#6c757d'}; font-weight: bold;">
                                        ${member.maritalStatus || 'أعزب'}
                                    </span>
                                </div>
                                <div style="margin-bottom: 15px;">
                                    <strong>تاريخ الزواج:</strong> ${marriageDate}
                                </div>
                                ${member.marriageDate && member.maritalStatus === 'تم تحديد الزواج' ? `
                                    <div style="margin-bottom: 15px;">
                                        <strong>المتبقي على الزواج:</strong>
                                        <span style="color: #ffc107; font-weight: bold;">
                                            ${Math.ceil((new Date(member.marriageDate) - new Date()) / (1000 * 60 * 60 * 24))} يوم
                                        </span>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    </div>

                    <!-- البيانات المالية -->
                    <div style="background: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); margin-bottom: 30px;">
                        <h3 style="color: #2c3e50; margin-bottom: 20px; border-bottom: 2px solid #28a745; padding-bottom: 10px;">
                            <i class="fas fa-money-bill-wave"></i> البيانات المالية
                        </h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                            <div style="text-align: center; padding: 15px; background: linear-gradient(135deg, #e3f2fd, #f3e5f5); border-radius: 8px;">
                                <div style="font-size: 1.5rem; font-weight: bold; color: #1976d2;">${expectedAmount.toLocaleString()}</div>
                                <div style="font-size: 0.9rem; color: #6c757d;">المبلغ المطلوب</div>
                            </div>
                            <div style="text-align: center; padding: 15px; background: linear-gradient(135deg, #e8f5e8, #f0f8f0); border-radius: 8px;">
                                <div style="font-size: 1.5rem; font-weight: bold; color: #28a745;">${totalCollected.toLocaleString()}</div>
                                <div style="font-size: 0.9rem; color: #6c757d;">المبلغ المحصل</div>
                            </div>
                            <div style="text-align: center; padding: 15px; background: linear-gradient(135deg, #ffe6e6, #ffcccc); border-radius: 8px;">
                                <div style="font-size: 1.5rem; font-weight: bold; color: ${remaining > 0 ? '#dc3545' : '#28a745'};">${remaining.toLocaleString()}</div>
                                <div style="font-size: 0.9rem; color: #6c757d;">${remaining > 0 ? 'المتبقي' : 'مكتمل'}</div>
                            </div>
                            <div style="text-align: center; padding: 15px; background: linear-gradient(135deg, #fff3cd, #ffeaa7); border-radius: 8px;">
                                <div style="font-size: 1.5rem; font-weight: bold; color: #856404;">${expectedAmount > 0 ? Math.round((totalCollected / expectedAmount) * 100) : 0}%</div>
                                <div style="font-size: 0.9rem; color: #6c757d;">نسبة الإنجاز</div>
                            </div>
                        </div>
                    </div>

                    <!-- رسالة تشجيعية -->
                    <div style="background: linear-gradient(135deg, #f8f9fa, #e9ecef); padding: 20px; border-radius: 10px; text-align: center; border: 2px solid #dee2e6;">
                        <div style="font-size: 2rem; margin-bottom: 15px; color: #28a745;">
                            <i class="fas fa-heart"></i>
                        </div>
                        <h3 style="color: #2c3e50; margin-bottom: 10px;">بارك الله لك</h3>
                        <p style="color: #6c757d; font-size: 1.1rem; line-height: 1.6;">
                            نسأل الله أن يبارك لك ويبارك عليك ويجمع بينكما في خير
                        </p>
                    </div>
                </div>
            `;
        }

        // دالة لسحب بيانات الزواج من جدول التحصيل أو بيانات العضو
        function getMarriageDataFromCollection(memberId) {
            const member = members.find(m => m.id === memberId);
            if (!member) {
                return {
                    marriageDate: '',
                    maritalStatus: 'أعزب'
                };
            }

            // استخدام بيانات العضو الأساسية
            let marriageDate = member.marriageDate || '';
            let maritalStatus = member.maritalStatus || 'أعزب';

            // التحقق من وجود تحصيل للعضو لتأكيد أنه مؤهل للعرض
            const collections = JSON.parse(localStorage.getItem('associationCollections') || '[]');
            const memberCollections = collections.filter(c =>
                c.beneficiaryId === memberId &&
                c.associationId === currentAssociation.id &&
                parseFloat(c.amount) > 0
            );

            // إذا كان هناك تحصيل، فهو مؤهل للعرض
            const hasCollection = memberCollections.length > 0;

            // تحديث الحالة بناءً على التاريخ إذا وجد
            if (marriageDate) {
                const today = new Date();
                const weddingDate = new Date(marriageDate);

                if (weddingDate > today) {
                    maritalStatus = 'تم تحديد الزواج';
                } else {
                    // إذا كان متزوج سابقاً، يبقى متزوج، وإلا يصبح تزوج
                    if (member.maritalStatus !== 'متزوج') {
                        maritalStatus = 'تزوج';
                    } else {
                        maritalStatus = 'متزوج';
                    }
                }
            }

            return {
                marriageDate: marriageDate,
                maritalStatus: maritalStatus,
                hasCollection: hasCollection
            };
        }

        // وظيفة إعادة التطبيق للحالة المصنعية
        function resetToFactory() {
            const confirmMessage = 'هل أنت متأكد من مسح جميع البيانات؟\n\nسيتم حذف:\n- جميع الجمعيات والمعاونات\n- جميع الأعضاء\n- جميع المستخدمين\n- جميع التحصيلات\n- تاريخ النسخ الاحتياطية\n\nهذا الإجراء لا يمكن التراجع عنه!';
            
            if (!confirm(confirmMessage)) {
                return;
            }
            
            const finalConfirm = 'تأكيد أخير: هل تريد فعلاً مسح جميع البيانات وإعادة التطبيق للحالة المصنعية؟';
            
            if (!confirm(finalConfirm)) {
                return;
            }
            
            try {
                // مسح جميع البيانات من localStorage
                localStorage.removeItem('associations');
                localStorage.removeItem('members');
                localStorage.removeItem('users');
                localStorage.removeItem('associationCollections');
                localStorage.removeItem('terms');
                localStorage.removeItem('backupHistory');
                localStorage.removeItem('currentUser');
                localStorage.removeItem('currentAssociation');
                
                // إعادة تعيين المتغيرات العامة
                associations = [];
                members = [];
                users = [];
                collections = [];
                terms = getDefaultTerms();
                currentUser = null;
                currentAssociation = null;
                
                // تحديث الإحصائيات لإظهار التطبيق فارغاً
                updateStats();
                
                // عرض شاشة تسجيل الدخول
                showLoginScreen();
                
                showAlert('تم مسح جميع البيانات بنجاح! تم إعادة التطبيق للحالة المصنعية.', 'success');
                
            } catch (error) {
                console.error('خطأ في مسح البيانات:', error);
                showAlert('حدث خطأ أثناء مسح البيانات!', 'error');
            }
        }



        // معالجة نموذج التسجيل الفردي المباشر
        document.getElementById('directSingleMemberForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const name = document.getElementById('directMemberName').value.trim();
            const phone = document.getElementById('directMemberPhone').value.trim();
            const status = document.getElementById('directMemberStatus').value;
            const city = document.getElementById('directMemberCity').value.trim();
            
            if (!name) {
                showAlert('يرجى إدخال اسم العضو', 'error');
                return;
            }
            
            // إنشاء عضو جديد
            const newMember = {
                id: Date.now().toString(),
                name: name,
                phone: phone,
                status: status,
                city: city,
                associationId: currentAssociation.id,
                joinDate: new Date().toISOString().split('T')[0],
                isActive: true,
                personalInfo: {
                    civilId: '',
                    birthDate: '',
                    nationality: '',
                    address: '',
                    email: ''
                },
                bankInfo: {
                    accountNumber: '',
                    bankName: '',
                    iban: ''
                },
                marriageInfo: {
                    spouseName: '',
                    marriageDate: '',
                    children: []
                }
            };
            
            // إضافة العضو إلى القائمة
            members.push(newMember);
            saveMembers();
            
            // إغلاق النافذة وتحديث القائمة
            closeModal('directSingleRegistrationModal');
            document.getElementById('directSingleMemberForm').reset();
            displayMembers();
            
            showAlert('تم إضافة العضو بنجاح!', 'success');
        });

        // معالجة البيانات الجماعية المباشرة
        function processDirectBulkData() {
            const data = document.getElementById('directBulkData').value.trim();
            
            if (!data) {
                showAlert('يرجى إدخال بيانات الأعضاء', 'error');
                return;
            }
            
            const lines = data.split('\n').filter(line => line.trim());
            const processedMembers = [];
            
            lines.forEach((line, index) => {
                const trimmedLine = line.trim();
                if (!trimmedLine) return;
                
                let name = '', phone = '', status = 'أعزب', city = '';
                
                // محاولة تحليل البيانات بطرق مختلفة
                if (trimmedLine.includes(',')) {
                    const parts = trimmedLine.split(',').map(p => p.trim());
                    name = parts[0] || '';
                    phone = parts[1] || '';
                    status = parts[2] || 'أعزب';
                    city = parts[3] || '';
                } else if (trimmedLine.includes('\t')) {
                    const parts = trimmedLine.split('\t').map(p => p.trim());
                    name = parts[0] || '';
                    phone = parts[1] || '';
                    status = parts[2] || 'أعزب';
                    city = parts[3] || '';
                } else if (trimmedLine.includes('|')) {
                    const parts = trimmedLine.split('|').map(p => p.trim());
                    name = parts[0] || '';
                    phone = parts[1] || '';
                    status = parts[2] || 'أعزب';
                    city = parts[3] || '';
                } else {
                    // إذا لم توجد فواصل، اعتبر السطر كاملاً كاسم
                    name = trimmedLine;
                }
                
                if (name) {
                    processedMembers.push({
                        id: (Date.now() + index).toString(),
                        name: name,
                        phone: phone,
                        status: status,
                        city: city,
                        associationId: currentAssociation.id,
                        joinDate: new Date().toISOString().split('T')[0],
                        isActive: true,
                        personalInfo: {
                            civilId: '',
                            birthDate: '',
                            nationality: '',
                            address: '',
                            email: ''
                        },
                        bankInfo: {
                            accountNumber: '',
                            bankName: '',
                            iban: ''
                        },
                        marriageInfo: {
                            spouseName: '',
                            marriageDate: '',
                            children: []
                        }
                    });
                }
            });
            
            if (processedMembers.length === 0) {
                showAlert('لم يتم العثور على بيانات صالحة للمعالجة', 'error');
                return;
            }
            
            // عرض المعاينة
            displayDirectBulkPreview(processedMembers);
        }

        // دالة عرض المعونات فقط
        function displayCooperations() {
            const container = document.getElementById('cooperationsList');

            if (associations.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #7f8c8d;">لا توجد معاونات مسجلة</p>';
                return;
            }

            // تصفية المعونات فقط وترتيبها حسب التاريخ من الأقدم للأحدث
            const cooperationsList = associations.filter(a => a.type === 'cooperation')
                .sort((a, b) => {
                    const dateA = new Date(a.date || a.createdAt || '1900-01-01');
                    const dateB = new Date(b.date || b.createdAt || '1900-01-01');
                    return dateA - dateB;
                });

            if (cooperationsList.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #7f8c8d;">لا توجد معاونات مسجلة</p>';
                return;
            }

            let html = '<div class="stats-grid">';

            cooperationsList.forEach(cooperation => {
                const isActive = currentAssociation && currentAssociation.id === cooperation.id;
                const memberCount = members.filter(m => m.associationId === cooperation.id).length;
                const totalAmount = members.filter(m => m.associationId === cooperation.id)
                    .reduce((sum, m) => sum + (parseFloat(m.amount) || 0), 0);

                html += `
                    <div class="stat-card" style="border: ${isActive ? '3px solid #27ae60' : '1px solid #dee2e6'}; background: ${isActive ? '#f8fff8' : '#fff'};">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <h4 style="margin: 0;">${cooperation.name}</h4>
                            <span style="background: #27ae60; color: white; padding: 4px 8px; border-radius: 12px; font-size: 0.8rem;">معاونة</span>
                        </div>
                        <p style="color: #7f8c8d; margin-bottom: 15px;">${cooperation.description || 'لا يوجد وصف'}</p>
                        <div style="margin: 15px 0; text-align: right; line-height: 1.6;">
                            <div><strong>الأعضاء:</strong> ${memberCount}</div>
                            <div><strong>إجمالي المبالغ:</strong> ${totalAmount.toLocaleString()} ريال</div>
                            <div><strong>المسؤول:</strong> ${cooperation.president || 'غير محدد'}</div>
                            <div><strong>أمين السر:</strong> ${cooperation.secretary || 'غير محدد'}</div>
                            <div style="color: #27ae60; font-weight: bold;"><i class="fas fa-info-circle"></i> مبلغ حر لكل عضو</div>
                        </div>
                        <div style="text-align: center; margin-top: 15px;">
                            ${!isActive ? `<button class="btn btn-primary" onclick="selectAssociation('${cooperation.id}')">
                                <i class="fas fa-check"></i> تحديد كحالية
                            </button>` : '<span style="color: #27ae60; font-weight: bold;"><i class="fas fa-check-circle"></i> الحالية</span>'}
                            <button class="btn btn-warning" onclick="showAddAssociationModal('cooperation', '${cooperation.id}')">
                                <i class="fas fa-edit"></i> تعديل
                            </button>
                            <button class="btn btn-danger" onclick="deleteAssociation('${cooperation.id}')">
                                <i class="fas fa-trash"></i> حذف
                            </button>
                        </div>
                    </div>
                `;
            });

            html += '</div>';
            container.innerHTML = html;
        }

        // عرض معاينة الأعضاء الجماعية
        function displayDirectBulkPreview(processedMembers) {
            const previewDiv = document.getElementById('directBulkPreview');
            const tableDiv = document.getElementById('directBulkPreviewTable');
            
            let tableHTML = `
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>الاسم</th>
                            <th>الهاتف</th>
                            <th>الحالة الاجتماعية</th>
                            <th>المدينة</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            processedMembers.forEach(member => {
                tableHTML += `
                    <tr>
                        <td>${member.name}</td>
                        <td>${member.phone || '-'}</td>
                        <td>${member.status}</td>
                        <td>${member.city || '-'}</td>
                    </tr>
                `;
            });
            
            tableHTML += '</tbody></table>';
            tableDiv.innerHTML = tableHTML;
            
            // حفظ البيانات المعالجة مؤقتاً
            window.tempBulkMembers = processedMembers;
            
            previewDiv.style.display = 'block';
        }

        // حفظ الأعضاء الجماعية
        function saveDirectBulkMembers() {
            if (!window.tempBulkMembers || window.tempBulkMembers.length === 0) {
                showAlert('لا توجد بيانات للحفظ', 'error');
                return;
            }
            
            const membersCount = window.tempBulkMembers.length;
            
            // إضافة جميع الأعضاء
            members.push(...window.tempBulkMembers);
            saveMembers();
            
            // إغلاق النافذة وتنظيف البيانات
            closeModal('directBulkRegistrationModal');
            document.getElementById('directBulkData').value = '';
            document.getElementById('directBulkPreview').style.display = 'none';
            window.tempBulkMembers = null;
            
            displayMembers();
            showAlert(`تم إضافة ${membersCount} عضو بنجاح!`, 'success');
        }

        // وظائف إدارة الاتفاقية للأعضاء
        function showMemberAgreement(memberId) {
            // تحميل محتوى الاتفاقية
            const agreementContent = document.getElementById('agreementContent');
            agreementContent.innerHTML = getDefaultTerms();
            
            // إعادة تعيين حالة مربع الموافقة
            const checkbox = document.getElementById('agreementCheckbox');
            const confirmBtn = document.getElementById('confirmAgreementBtn');
            
            checkbox.checked = false;
            confirmBtn.disabled = true;
            
            // حفظ معرف العضو مؤقتاً
            window.currentAgreementMemberId = memberId;
            
            // إظهار النافذة
            showModal('memberAgreementModal');
        }

        // التحكم في تفعيل زر الموافقة
        document.addEventListener('DOMContentLoaded', function() {
            const checkbox = document.getElementById('agreementCheckbox');
            const confirmBtn = document.getElementById('confirmAgreementBtn');
            
            if (checkbox && confirmBtn) {
                checkbox.addEventListener('change', function() {
                    confirmBtn.disabled = !this.checked;
                });
            }
        });

        // تأكيد الموافقة على الاتفاقية
        function confirmAgreement() {
            const memberId = window.currentAgreementMemberId;
            if (!memberId) {
                showAlert('خطأ في تحديد العضو', 'error');
                return;
            }
            
            // حفظ حالة الموافقة في localStorage
            const agreementKey = `memberAgreement_${memberId}`;
            localStorage.setItem(agreementKey, 'agreed');
            
            // إغلاق نافذة الاتفاقية
            closeModal('memberAgreementModal');
            
            // إظهار رسالة نجاح
            showAlert('تم قبول الاتفاقية بنجاح! مرحباً بك في حسابك الشخصي', 'success');
            
            // تنظيف المتغير المؤقت
            window.currentAgreementMemberId = null;
            
            // إكمال عملية تسجيل الدخول
            completeLogin();
        }
        
        // إكمال عملية تسجيل الدخول بعد الموافقة على الاتفاقية
        function completeLogin() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('mainApp').style.display = 'block';
            document.getElementById('userWelcome').innerHTML = `<i class="fas fa-user"></i> مرحباً ${currentUser.name}`;

            // إنشاء القائمة حسب الصلاحيات
            buildNavigationMenu();

            // حفظ حالة المستخدم والجمعية
            localStorage.setItem('currentUser', JSON.stringify(currentUser));
            if (currentAssociation) {
                localStorage.setItem('currentAssociation', JSON.stringify(currentAssociation));
            }

            // عرض القسم المناسب حسب نوع المستخدم (فقط إذا لم يكن هناك قسم محفوظ)
            const savedSection = localStorage.getItem('currentSection');
            if (!savedSection) {
                if (currentUser.role === 'member') {
                    showSection('myProfile');
                } else {
                    showSection('home');
                }
            }
            
            console.log('تم تسجيل الدخول بنجاح للمستخدم:', currentUser.name);
        }

        // فحص ما إذا كان العضو قد وافق على الاتفاقية
        function hasAgreedToTerms(memberId) {
            const agreementKey = `memberAgreement_${memberId}`;
            return localStorage.getItem(agreementKey) === 'agreed';
        }

        // دالة طباعة كشف الأرقام
        function printIdsList() {
            const associationMembers = filterMembersByAssociation();
            if (associationMembers.length === 0) {
                showAlert('لا توجد أعضاء لطباعة كشف الأرقام', 'error');
                return;
            }

            const associationName = currentAssociation ? currentAssociation.name : 'جميع الأعضاء';
            const currentDate = new Date().toLocaleDateString('ar-SA');

            let tableHTML = `
                <table style="width: 100%; border-collapse: collapse; margin: 20px 0;">
                    <thead>
                        <tr style="background: linear-gradient(135deg, #34495e 0%, #2c3e50 100%); color: white;">
                            <th style="border: 1px solid #bdc3c7; padding: 10px; text-align: center;">م</th>
                            <th style="border: 1px solid #bdc3c7; padding: 10px;">الاسم</th>
                            <th style="border: 1px solid #bdc3c7; padding: 10px; text-align: center;">رقم الهاتف</th>
                            <th style="border: 1px solid #bdc3c7; padding: 10px; text-align: center;">رقم السجل المدني</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            associationMembers.forEach((member, index) => {
                tableHTML += `
                    <tr style="${index % 2 === 0 ? 'background-color: #f8f9fa;' : ''}">
                        <td style="border: 1px solid #bdc3c7; padding: 8px; text-align: center;">${index + 1}</td>
                        <td style="border: 1px solid #bdc3c7; padding: 8px;">${member.name}</td>
                        <td style="border: 1px solid #bdc3c7; padding: 8px; text-align: center;">${member.phone || '-'}</td>
                        <td style="border: 1px solid #bdc3c7; padding: 8px; text-align: center;">${member.nationalId || '-'}</td>
                    </tr>
                `;
            });

            tableHTML += '</tbody></table>';

            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <!DOCTYPE html>
                <html dir="rtl" lang="ar">
                <head>
                    <meta charset="UTF-8">
                    <title>كشف أرقام الأعضاء - ${associationName}</title>
                    <style>
                        @page {
                            margin: 12mm;
                            size: A4;
                        }

                        body {
                            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                            direction: rtl;
                            margin: 0;
                            padding: 10px;
                            line-height: 1.3;
                            color: #333;
                            font-size: 11px;
                        }

                        .report-header {
                            border: 2px solid #2c3e50;
                            border-radius: 8px;
                            padding: 10px;
                            margin-bottom: 15px;
                            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
                            text-align: center;
                        }

                        .report-title {
                            font-size: 18px;
                            font-weight: bold;
                            color: #2c3e50;
                            margin: 0 0 5px 0;
                        }

                        .association-name {
                            font-size: 14px;
                            color: #34495e;
                            margin: 0 0 5px 0;
                            font-weight: 600;
                        }

                        .report-date {
                            font-size: 11px;
                            color: #7f8c8d;
                            margin: 0;
                        }

                        table {
                            width: 100%;
                            border-collapse: collapse;
                            margin: 8px 0;
                            font-size: 10px;
                            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
                        }

                        th, td {
                            border: 1px solid #bdc3c7;
                            padding: 4px 6px;
                            text-align: right;
                            vertical-align: middle;
                        }

                        th {
                            background: linear-gradient(135deg, #34495e 0%, #2c3e50 100%);
                            color: white;
                            font-weight: bold;
                            text-align: center;
                            font-size: 9px;
                        }

                        tr:nth-child(even) {
                            background-color: #f8f9fa;
                        }

                        .content {
                            margin-bottom: 60px;
                        }

                        .report-footer {
                            position: fixed;
                            bottom: 0;
                            left: 0;
                            right: 0;
                            border-top: 1px solid #dee2e6;
                            padding: 8px 12px;
                            background: white;
                            text-align: center;
                            font-size: 9px;
                            font-weight: bold;
                            color: #2c3e50;
                            line-height: 1.2;
                            page-break-inside: avoid;
                        }

                        .app-title {
                            color: #2c3e50;
                            font-size: 12px;
                            margin-bottom: 5px;
                        }

                        .designer-info {
                            color: #34495e;
                            margin-bottom: 3px;
                        }

                        .phone-number {
                            color: #e74c3c;
                            font-weight: bold;
                        }

                        .dedication {
                            color: #8e44ad;
                            font-style: italic;
                            margin-top: 5px;
                        }

                        @media print {
                            body {
                                margin: 0;
                                padding: 15px;
                                font-size: 11px;
                            }

                            .report-header {
                                border: 2px solid #000;
                                background: #f5f5f5 !important;
                            }

                            .report-footer {
                                border: 1px solid #000;
                                background: #f9f9f9 !important;
                            }

                            th {
                                background: #e0e0e0 !important;
                                color: #000 !important;
                            }
                        }
                    </style>
                </head>
                <body>
                    <div class="content">
                        <div class="report-header">
                            <div class="report-title">كشف أرقام الأعضاء</div>
                            <div class="association-name">${associationName}</div>
                            <div class="report-date">تاريخ الكشف: ${currentDate}</div>
                            <div style="font-size: 10px; color: #2c3e50; margin: 5px 0 0 0; font-weight: 600; border-top: 1px solid #bdc3c7; padding-top: 5px;">إجمالي الأعضاء: ${associationMembers.length}</div>
                        </div>

                        ${tableHTML}
                    </div>

                    <div class="report-footer">
                        <div class="app-title">تطبيق معاونة وجمعية الزواج النسخة الاولى</div>
                        <div class="designer-info">اعداد وتصميم الأستاذ / ناصر مسعود آل مستنير</div>
                        <div class="phone-number">📱 0505723776 | ✉️ yam287@gmail.com</div>
                    </div>
                </body>
                </html>
            `);

            printWindow.document.close();
            printWindow.print();
        }


    </script>
    
    <!-- PWA Service Worker Registration -->
    <script>
        // تسجيل Service Worker للـ PWA
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                navigator.serviceWorker.register('/sw.js')
                    .then(function(registration) {
                        console.log('Service Worker تم تسجيله بنجاح:', registration.scope);
                        
                        // التحقق من وجود تحديثات
                        registration.addEventListener('updatefound', function() {
                            const newWorker = registration.installing;
                            newWorker.addEventListener('statechange', function() {
                                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                    // يوجد تحديث جديد - تحديث صامت بدون إعادة تحميل
                                    console.log('تم العثور على تحديث جديد - سيتم تطبيقه في الخلفية');
                                    newWorker.postMessage({ type: 'SKIP_WAITING' });
                                    // إزالة إعادة التحميل التلقائي لتجنب الخروج من التطبيق
                                    // window.location.reload();
                                }
                            });
                        });
                    })
                    .catch(function(error) {
                        console.log('فشل في تسجيل Service Worker:', error);
                    });
            });
        }
        
        // إضافة زر تثبيت التطبيق
        let deferredPrompt;
        
        window.addEventListener('beforeinstallprompt', function(e) {
            // منع عرض النافذة التلقائية
            e.preventDefault();
            deferredPrompt = e;
            
            // إظهار زر التثبيت المخصص
            showInstallButton();
        });
        
        function showInstallButton() {
            // إنشاء زر التثبيت إذا لم يكن موجوداً
            if (!document.getElementById('installButton')) {
                const installButton = document.createElement('button');
                installButton.id = 'installButton';
                installButton.innerHTML = '<i class="fas fa-download"></i> تثبيت التطبيق';
                installButton.style.cssText = `
                    position: fixed;
                    bottom: 20px;
                    right: 20px;
                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                    color: white;
                    border: none;
                    padding: 12px 20px;
                    border-radius: 25px;
                    font-family: 'Tajawal', sans-serif;
                    font-size: 14px;
                    font-weight: 600;
                    cursor: pointer;
                    box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
                    z-index: 1000;
                    transition: all 0.3s ease;
                    display: flex;
                    align-items: center;
                    gap: 8px;
                `;
                
                installButton.addEventListener('click', function() {
                    if (deferredPrompt) {
                        deferredPrompt.prompt();
                        deferredPrompt.userChoice.then(function(choiceResult) {
                            if (choiceResult.outcome === 'accepted') {
                                console.log('المستخدم قبل تثبيت التطبيق');
                            } else {
                                console.log('المستخدم رفض تثبيت التطبيق');
                            }
                            deferredPrompt = null;
                            installButton.remove();
                        });
                    }
                });
                
                installButton.addEventListener('mouseenter', function() {
                    this.style.transform = 'translateY(-2px)';
                    this.style.boxShadow = '0 6px 20px rgba(102, 126, 234, 0.6)';
                });
                
                installButton.addEventListener('mouseleave', function() {
                    this.style.transform = 'translateY(0)';
                    this.style.boxShadow = '0 4px 15px rgba(102, 126, 234, 0.4)';
                });
                
                document.body.appendChild(installButton);
            }
        }
        
        // إخفاء زر التثبيت بعد التثبيت
        window.addEventListener('appinstalled', function(e) {
            console.log('تم تثبيت التطبيق بنجاح');
            const installButton = document.getElementById('installButton');
            if (installButton) {
                installButton.remove();
            }
        });
        
        // تحسين تجربة PWA على iOS
        if (window.navigator.standalone) {
            // التطبيق يعمل في وضع standalone على iOS
            document.body.classList.add('ios-standalone');
        }
    </script>
</body>
</html>
